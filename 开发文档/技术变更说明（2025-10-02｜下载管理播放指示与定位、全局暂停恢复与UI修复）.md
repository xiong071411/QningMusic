## 2025-10-02｜下载管理播放指示与定位、全局暂停/恢复与UI修复
(TechChangeSpec_2025-10-02-Downloads-NowPlaying-Locate-GlobalPause-UI-Fixes)

### 方案总览与实现要点
- 下载管理页（内嵌页）接入“正在播放指示器与定位按钮”。当视图为 `downloads` 时：
  - 播放状态分发到 `DownloadedSongAdapter`，在“已下载”分区展示正在播放指示。
  - 定位按钮支持 `ConcatAdapter`，可一键定位到“已下载”分区的当前曲目（自动展开分区并居中）。
- 全局暂停/恢复行为重构与稳态化：
  - 新增 `globalPaused` 标志及 `pauseAll()/resumeAll()` 能力。
  - 全局暂停下，新任务与恢复任务一律标记为 `WAITING` 入队，不再误标 `PAUSED`；恢复时清除 `pauseFlags` 并把 `PAUSED` 统一转 `WAITING`，调度按并发上限启动。
  - 取消全部会清空等待队列、还原数据库中活动任务到 `NOT_DOWNLOADED` 并清理 `.part` 残留，彻底移除“杀后台残留任务”。
- UI 一致性与“最后一首”驻留修复：
  - 下载完成/取消广播触发“强制刷新”（绕过节流），立即将最后一首从“正在下载”移动到“已下载”分区。
  - 多选大规模删除后：本地先清空“已下载”适配器，随后立即刷新+两次延迟刷新（250ms/600ms），避免需要重进页面。
- 头部区交互与可达性优化：
  - 统计文案永远由刷新逻辑重建（`▼/▶ + 标题 + 计数`），折叠/展开后不再消失。
  - 折叠/展开点击范围从“仅文字”扩大到“整条标题栏”。
- 多选与批量操作增强：
  - 下载页多选模式下恢复“添加到歌单”入口（与其它列表一致）。
  - “已下载”区头新增“全选”按钮（文字+边框，直观且不占用 toolbar），仅在多选模式显示。
- 日志与警告降噪：
  - `ConcatAdapter` 使用 `ISOLATED_STABLE_IDS`，消除 Stable IDs 警告。
  - 下载进度广播限流（≥200ms 或进度增量≥1%），减少 UI 刷新压力。
  - 列表项标题/副标题设置固定 `lineHeight` 与 `includeFontPadding=false`，降低 `StaticLayout maxLineHeight` 警告频次。

- 已下载分区 UI：
  - 右侧不显示任何下载相关图标（下载/完成/失败/进度）。
  - 每首歌显示本地文件大小，格式为“时长 · 大小”（示例：`3:45 · 8.2MB`），弱网/离线同样可见。

---

### 问题回溯与根因分析
1) 全局暂停后等待队列仍被拉起 → 暂停仅影响运行中任务，空出并发后等待任务继续启动。
   - 根因：暂停未阻断调度；新/恢复任务在暂停态被触发。
   - 解决：`globalPaused` 短路调度；新/恢复任务在暂停下进 `WAITING`；`pauseAll()` 清空等待队列；`resumeAll()` 清 `pauseFlags` 并批量转 `WAITING` 启动。

2) 全局恢复/单曲恢复显示“正在下载”但实际未下载 → 仍受 `pauseFlags` 影响或未入队。
   - 根因：`pauseFlags` 未清；状态被错误改回 `PAUSED`。
   - 解决：`resumeAll()` 清 `pauseFlags`，并统一转 `WAITING` 入队；单曲在全局暂停时同样转 `WAITING`。

3) 最后一首完成后仍驻留“正在下载”满进度条。
   - 根因：刷新节流导致完成瞬间 UI 未更新；需强制刷新。
   - 解决：在 `ACTION_DOWNLOAD_COMPLETE/CANCELED` 触发“强制刷新”（绕过节流）。

4) 多选删除后“已下载”计数为 0，但列表仍残留旧项。
   - 根因：数据库异步写入延迟，UI 合并刷新时机不稳定。
   - 解决：先清空适配器、再立即刷新+两次延迟刷新兜底。

5) 折叠/展开后统计文案消失、点击区域过小。
   - 根因：标题刷新未覆盖所有时序；点击仅绑定在文字。
   - 解决：每次 `rebuildDownloadsConcat()/refreshDownloadsData()` 重建标题文本；点击绑定整行。

6) 下载页多选缺少“添加到歌单”。
   - 根因：早前整理菜单时遗漏。
   - 解决：恢复多选菜单项并复用统一添加流程。

7) 大量 `ConcatAdapter Stable ids…ignored` 与 `StaticLayout maxLineHeight` 警告。
   - 根因：`ConcatAdapter` 默认稳定 ID 策略与 TextView 行高未固定。
   - 解决：`ISOLATED_STABLE_IDS` + 固定 `lineHeight` 与 `includeFontPadding=false`。

---

### 受影响文件与关键点（路径相对 `app/src/main/`）
- `java/com/watch/limusic/download/DownloadManager.java`
  - 新增：`globalPaused`；`pauseAll()/resumeAll()`；进度广播限流（200ms/≥1%）。
  - 行为：
    - 暂停：运行中改 `PAUSED`、等待清空；取消全部还原 DB 状态为 `NOT_DOWNLOADED` 并清理 `.part`。
    - 全局暂停下：新/恢复任务改 `WAITING` 入队（不再误标 `PAUSED`）。
    - 恢复：清理 `pauseFlags` 并批量转 `WAITING` 入队；调度时 `globalPaused` 短路保护。
    - 单项暂停：立即发送一次进度广播以驱动 UI 立刷。

- `java/com/watch/limusic/MainActivity.java`
  - 下载页接入播放指示/定位：`updateLocateButtonVisibility()`/`locateCurrentPlaying()` 兼容 `ConcatAdapter`，支持定位“已下载”分区。
  - 下载完成/取消广播：改为强制刷新，修复“最后一首驻留”。
  - 全局暂停/继续：调用 `pauseAll()/resumeAll()` 并本地 UI upsert，同步两次延迟刷新兜底。
  - 多选删除：先清空 `downloadedSongAdapter` 再连刷，修复 UI 残留。
  - 菜单：下载页多选恢复 `action_add_to_playlist`；
  - 头部区交互：整行可点击折叠/展开；退出多选时隐藏“全选”。
  - 构建下载页 `ConcatAdapter` 使用 `ISOLATED_STABLE_IDS`，移除稳定 ID 警告。

- `java/com/watch/limusic/adapter/SectionHeaderAdapter.java`
  - 新增“全选”按钮显隐与点击回调；点击绑定整行；兼容旧布局。

- `res/layout/item_artist_section_header.xml`
  - 从单一 `TextView` 升级为 `RelativeLayout`：左侧标题 `section_title` + 右侧“全选” `btn_select_all`（默认 `gone`）。

- `res/drawable/text_button_box.xml`
  - 新增“全选”按钮的文字边框背景。

- `res/layout/item_download_task.xml`
  - 文本行高与内边距优化，抑制 `StaticLayout` 警告。

- `res/menu/menu_downloads_selection.xml`
  - 新增/恢复 `action_add_to_playlist`；保留 `action_delete_selected`。

- `java/com/watch/limusic/adapter/DownloadedSongAdapter.java`
  - 固定 `setShowDownloadStatus(false)`；在 `onBindViewHolder` 中二次强制隐藏 `download_container` 及其子控件，杜绝任意时序下的误显。
  - 新增 `LocalFileDetector` 注入，获取本地文件大小；复用 `song_duration` 文本显示“时长 · 大小”。
  - 大小格式化规则 `formatSize(bytes)`：
    - **< 1KB**：显示 `B`
    - **< 1MB**：显示整数 `KB`
    - **< 1GB**：显示 1 位小数的 `MB`
    - **≥ 1GB**：显示 2 位小数的 `GB`

---

### 行为变更明细
- 全局暂停：立即暂停运行中，清空等待队列；此时所有新/恢复请求进入 `WAITING`，不会被拉起。
- 全局继续：清 `pauseFlags`、批量转 `WAITING` 入队，由调度按并发上限推进。
- 下载完成/取消：强制刷新，最后一个任务不再驻留在“正在下载”。
- 多选删除：删除后 UI 立刻清空“已下载”列表并在短时内稳定反映最终状态。
- 头部区交互：整条标题栏可点击折叠/展开；计数文案在任何时序下都会被刷新重建。
- 多选模式（下载页）：出现“添加到歌单”与“全选”（仅多选态可见）。
- “已下载”分区：每行显示本地文件大小；若文件不存在或大小为 0，则仅显示时长，不引入额外占位与抖动。

---

### 验收用例与标准（手表优先）
1) 全局暂停/继续：
   - 暂停后不存在任何任务被新启动；继续后任务有序恢复且实际产生下载流量。
2) 单曲恢复（全局暂停期间）：
   - 行为显示为“等待中”，解除全局暂停后自动开始下载。
3) 最后一首完成：
   - 完成瞬间从“正在下载”移动到“已下载”，无驻留满进度条。
4) 多选删除：
   - 删除后立即清空“已下载”列表；0.6s 内稳定显示最终状态。
5) 折叠/展开：
   - 点击整条标题栏可折叠/展开；计数文案始终存在并正确更新。
6) 多选交互：
   - 下载页多选出现“添加到歌单”与“全选”；全选可一键选中当前“已下载”全部歌曲；退出多选“全选”消失。

7) 已下载文件大小显示：
   - 已下载歌曲行尾显示“时长 · 大小”，大小与文件系统一致；当文件缺失或大小不可读时，仅显示时长。

---

### 性能与功耗评估
- 下载进度广播限流与 UI 合并刷新减少主线程与布局抖动；对 CPU/GPU 负担降低，功耗影响可忽略不计。
- `ISOLATED_STABLE_IDS` 避免不必要的适配器重建与日志刷屏，稳定性提升。
- 文件大小获取基于本地文件 `length()`，在绑定时一次性读取，开销极低；未引入周期性轮询或额外 I/O。

---

### 风险与回滚策略
- 若个别设备 resume 后仍出现“显示在下载但无实际下载”的现象：
  - 校验 `pauseFlags` 是否被彻底清除；可回退为“resume 前统一清空并强制重排队”的更保守策略。
- 若“强制刷新”引入过多刷新次数：
  - 可提升节流阈值或对完成事件做批处理。
- 回滚：移除 `globalPaused` 相关逻辑，恢复旧的 per-task 暂停/恢复与原调度（不建议）。
- 若个别 ROM/设备因存储沙箱或权限差异导致大小读取失败：
  - UI 自动退化为仅显示时长，无需回滚；必要时可在设置中增加“显示文件大小”开关用于快速关闭。

---

### 日志与告警优化
- 移除 `ConcatAdapter` 稳定 ID 警告；降低 `StaticLayout` 警告出现频率。
- 下载完成/失败/取消日志保留；进度广播限流后日志与 UI 刷新更平衡。

---

### 版本信息与变更摘要
- 版本：v4.0Beta4（2025-10-02，下载管理播放指示/定位、全局暂停/恢复、UI与交互修复）
- 摘要：
  - 下载管理页接入播放指示与定位；
  - 全局暂停/恢复具备确定性与可恢复性；
  - 删除/完成等时序下的 UI 不一致问题消除；
  - 多选恢复“添加到歌单”并新增“全选”；
  - 警告日志显著减少。


---

### 追加更新（折叠计数、“全选”可见性与已下载右侧图标）
- 折叠/展开计数丢失修复：
  - 折叠/展开回调中在 `rebuildDownloadsConcat()` 之后调用 `refreshDownloadsData(true)` 强制刷新；
  - `rebuildDownloadsConcat()` 内直接以当前适配器项数设置标题为 “▼/▶ 名称 (数量)”。
- 触发区域扩大：
  - `SectionHeaderAdapter` 改为整行 `itemView.setOnClickListener(clickListener)`，不再局限于文字区域。
- “全选”仅在多选模式显示：
  - 进入多选时为“已下载”区头调用 `setSelectAllVisible(true, ...)`；
  - `exitSelectionMode()` 显式调用 `headerCompleted.setSelectAllVisible(false, null)` 立即隐藏。
- “已下载”右侧不显示任何下载相关图标：
  - `DownloadedSongAdapter` 固定 `setShowDownloadStatus(false)`，确保无下载按钮/完成/失败图标露出。

- “已下载”显示文件大小：
  - 在 `DownloadedSongAdapter` 中复用 `song_duration` 文本显示“时长 · 大小”，通过 `LocalFileDetector.getDownloadedSongSize(songId)` 获取大小；若未命中则不追加大小文案。
  - 为防止外部状态变更导致误显下载控件，在 `onBindViewHolder` 中二次将 `download_container` 及其子控件设为 `GONE`。


