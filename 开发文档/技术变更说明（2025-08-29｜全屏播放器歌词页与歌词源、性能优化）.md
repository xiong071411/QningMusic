## 2025-08-29｜全屏播放器歌词页与歌词源、性能优化（歌词页面 + 手势切页 + 懒加载 + LRC 解析 + 自定义歌词源 + 同步与动效开关）
(TechChangeSpec_2025-08-29-Lyrics-Page-and-Sources)

### 背景与目标
- 背景：
  - 在低性能安卓手表上为全屏播放器新增歌词显示功能，要求低开销、流畅；
  - 提供左右滑动在“主控页/歌词页”间切换的交互，并增加两点式页指示器；
  - 歌词需支持时间戳同步、高亮/放大当前行、点击跳转进度；
  - 无服务器时间戳歌词时，支持第三方/自定义歌词源；
  - 设置项即时生效，低电模式自动禁用歌词。
- 目标：
  - UI：两点页指示器、歌词页懒加载、返回条不被遮挡、切后台/回前台不叠层；
  - 手势：指示器纯切换、横向拖拽跟手、40% 阈值、排除进度/音量区；
  - 顶部条：拖动时绿/蓝联动，进入歌词页定格左右各 50%，回主控页定格绿 100%；
  - 歌词：鲁棒 LRC 解析、多时间格式、二分查找定位、仅局部刷新；
  - 性能：后台取词、轻量刷新、低电模式短路；
  - 扩展：第三方歌词源（实验性）与自定义歌词源（URL 模板），可回退至 Navidrome；
  - 可选：歌词平滑过渡（实验性）开关，默认关闭。

（补充）
- 新增：全屏音量遮罩与居中音量按钮，点击显示全屏半透明背景 + 卡片承载的音量拖动条（点击空白处关闭），默认隐藏不占用渲染。
- 新增：歌词字号自定义（当前行/其他行），设置变更后即时广播 `UI_SETTINGS_CHANGED(what=lyric_size)`，歌词页立即生效。
- 新增：自定义歌词源（URL 模板，支持 `{artist}`/`{title}`），设置变更后广播 `UI_SETTINGS_CHANGED(what=lyric_source)` 触发重载。
- 新增：进度条 TIME_UNSET 容错与“延后 Seek”机制，保证时长未就绪时拖动不会回到开头，时长就绪后自动跳转。
- 低功耗优化：默认不预加载歌词页；停留在主控页时暂停歌词调度与渲染，几乎零开销；省电模式下隐藏第二个指示点并禁止进入歌词页。

---

### 问题回溯与根因分析
1) 首次打开全屏时歌词与主控重叠、返回条被遮挡：
- 原因：歌词容器未懒加载/未正确设置顶部间距与层级；
- 解决：改用 `ViewStub` 懒加载，并在 `lyrics_stub` 与 `layout_lyrics_page` 明确 `layout_marginTop`，设置 `elevation`，保证顶栏优先。

2) 左右滑动“硬切/不跟手/返回困难”：
- 原因：仅靠简单手势监听，不做实时位移；
- 解决：在覆盖层上实现 `OnTouchListener`，拖拽期间对子视图做 `translationX` 跟手；释放后 140–200ms 减速 settle 动画，动画期间临时开启硬件图层；排除进度条与音量条区域；降低方向锁阈值至 8dp；在歌词列表与容器也绑定右滑返回；歌词页右滑返回时禁用“反向右滑进入”。
（补充）
- 实时跟手比：向左进入歌词页时 `factor=0.9f`，向右回主控页 `factor=0.7f` 减小跟手比，手感更稳。
- 结算阈值：40% 屏宽，未达阈值立即将歌词容器 `GONE` 并重置位移，避免短暂闪现。
- 返回动画：主控页在动画开始前即设为 `VISIBLE`，符合直觉；歌词页返回仅位移 25% 屏宽后隐藏，避免过度运动。
- 顶部条宽度联动：拖动进度 p∈[0,1]，将 `layout_weight` 映射为“左=1−0.5p、右=0.5p”。蓝条最大仅至 50%，绿条最小保留 50%，避免出现“蓝条独占”。
- 目标页定格：进入歌词页时强制定格为 0.5/0.5；回主控页定格为 1/0。非拖拽切页（点击两点/按钮）亦通过 120–200ms 减速动画补间至目标权重，视觉一致。

3) 任意歌曲显示“暂无歌词”与主线程网络异常：
- 原因：取词在主线程、服务器返回结构不一；
- 解决：后台线程取词；`NavidromeApi.getLyrics` 宽松解析 `subsonic-response.lyrics`；无时间戳时进入纯文本模式。

4) 歌词不随时间戳放大/不滚动：
- 原因：时间格式覆盖不足/调度偶发丢行；
- 解决：`LyricsParser` 支持 `[mm:ss(.S|.SS|.SSS)]`、`[hh:mm:ss]`、小数点与逗号；
  用二分查找定位当前行；增加“下一行定时”与 500ms 心跳兜底（取最小值），仅在含时间戳时生效；
  仅刷新“旧行+新行”两项，减小 UI 开销。
（补充）
- 列表禁用 `ItemAnimator`，启用稳定 ID；将 `TextView` 开启抗锯齿与亚像素文本，关闭 `includeFontPadding`，单行最小高度=“其他行字号行高+4dp”。
- 放大行的额外高度按“向上/向下”各一半分配，保证上下间距对称，消除“上远下近”。

5) 居中失败、放大后行距不一致：
- 原因：行视图未渲染时直接偏移；放大只变字号导致上下间距不对称；
- 解决：两阶段精准居中（先确保可见，下一帧按 `(ListH-ItemH)/2` 精确偏移，必要时延迟 16ms 再试）；
  计算放大后相对增量行高，将额外高度等分进当前行上下内边距，保证对称；
  固定最小高度为“其他行单行高度 + 基础内边距”以保持紧凑与稳定。

6) 进度条拖动后跳回开头：
- 原因：旧广播立即覆盖用户进度；
- 解决：在 `onStopTrackingTouch` 后 600ms 抑制过期广播更新。
（补充）
- 新增 `pendingSeekMs` 延后提交：若 ExoPlayer `duration==TIME_UNSET` 或 `max==0`，先记录目标进度，等收到有效时长（或服务端补发 `fallbackDurationMs`）后再一次性 `seekTo`。
- 广播侧 UI 仅在 `effectiveDuration>0` 时刷新进度与时间文本，避免 `--:--` 覆盖用户进度。

7) 第三方歌词源命中低、以及需要自建源：
- 解决：保留“自定义歌词源”URL 模板（支持 `{artist}`/`{title}` URL 编码替换）；
  仓库优先级：缓存 > 本地下载 > 自定义源 > Navidrome；
  服务器端给出 PHP/纯静态两套实现，并支持“标题模糊匹配”。
（补充）
- 出于合规考虑，已移除第三方歌词源（LRCLIB）开关与实现，避免潜在法律风险；相关 UI、设置键与客户端 API 均已删除。

8) 视觉抖动/邻行闪动：
- 解决：禁用 `RecyclerView` 的 `ItemAnimator`，启用稳定 ID，仅刷新 2 项；
  放大使用 textSize，启用抗锯齿与亚像素绘制；
  新增“歌词平滑过渡（实验性）”开关（默认关闭），开启时对旧/新行做 120ms 字号+内边距联动动画。

---

### 方案总览与实现要点
A. 布局与懒加载
- `layout_full_player_overlay.xml`
  - 顶部条改为左右分栏：左“返回列表”（绿色）、右“返回播放器”（蓝色，仅歌词页可见）；
  - 新增两点页指示器（选中实心、未选中空心，4dp）；
  - 增加 `lyrics_stub`（`ViewStub`）并设置 `layout_marginTop`，保证歌词容器位于返回条和指示器之下；
  - 顶部条宽度动画：`layout_weight` 随拖动进度 p 联动映射为“左=1−0.5p、右=0.5p”，歌词页定格 0.5/0.5，主控页定格 1/0；点击切页同样通过 120–200ms 减速动画补间至目标权重。
- `layout_lyrics_page.xml`
  - 标注可调的显示区域边距（`layout_marginTop` 与 `paddingBottom`），便于后续微调；
  - `TextView` 占位“暂无歌词”与 `RecyclerView` 列表。

B. 手势与切页
- 覆盖层 `OnTouchListener`：
  - 实时 `translationX` 跟手；释放后 140–200ms 减速 settle；40% 屏宽阈值；
  - 排除进度条/音量条；方向锁阈值 8dp；
  - 顶部条联动：拖动期间持续调用 `updateTopBarProgress(p)`，并在 `settleDrag/animateReturnToMain` 用补间动画将权重过渡至目标值（歌词页 0.5/0.5，主控页 1/0）；
  - 歌词容器与列表也支持右滑返回；
  - 回到主控页时立即 `GONE` 歌词容器，避免叠层。

C. 歌词解析与同步
- `LyricsParser`
  - 支持多格式时间戳与多时间标签行，逗号小数兼容；
  - 纯文本行 `startMs=-1`；结果含 `offsetMs`；
- `LyricsController`
  - 懒加载歌词页；后台线程取词；
  - 解析完成后设置适配器，仅刷新两项；
  - 调度：下一行定时 + 500ms 心跳兜底（仅有时间戳时生效）；
  - 居中：两阶段精准居中（首帧可见→次帧偏移），必要时 16ms 再试；
  - 设置即时生效广播：字号/歌词源/平滑过渡切换均可立即更新；
  - 低电模式：直接显示禁用文案，短路渲染与取词；
  - 进入前台时做“两步校正”，消除历史叠层；
（补充）
  - 新增 `pause()/resume()`，切页与返回动画期间暂停定时，动画结束后恢复；
  - `scheduleNextTick` 加入 `heartbeat=500ms` 的最小延迟策略，提升稳健性。

D. 适配器与渲染
- `LyricsAdapter`
  - 稳定 ID，禁用 `ItemAnimator`；
  - 放大以 textSize 实现，抗锯齿/亚像素、去除额外 font padding；
  - 紧凑显示：以“其他行单行高度 + 基础内边距(2dp)”为最小高度，一屏显示更多行；
  - 当前行上下内边距对称分配放大增量，杜绝“上大下小”；
  - 实验性平滑过渡：开关来自 `player_prefs.lyric_smooth_enabled`，对旧/新行做 180ms 字号+内边距动画；仅“旧行+新行”参与动画，避免整屏重绘。
（补充）
  - `computeMinHeightPx()` 基于“其他行字号”的单行高度 + 4dp 计算，保障不同字号下密度一致；
  - `recomputeHeights()` 缓存基础行高、当前行行高与最小项高，减少重复测量。

E. 歌词源与设置
- `LyricsRepository`
  - 优先级：缓存 > 本地下载目录 > 自定义源（启用且配置 URL）> Navidrome；
  - 写入缓存：命中任一远端即缓存到 `downloads/lyrics/{songId}.lrc`；
- `CustomLyricsApi`：支持 URL 模板 `{artist}`/`{title}`，可返回纯文本或 JSON(`syncedLyrics/lrc/lyrics`)；
- `PlayerSettingsActivity`/`activity_player_settings.xml`
  - 新增：当前/其他行字号调节、自定义歌词源（点击启用、长按编辑 URL 模板）、歌词平滑过渡（实验）开关；
  - 去除：第三方歌词源（实验）开关与说明文案；
  - 编辑弹框改良：黑色文字、半透明黑提示、单行与内边距；
  - 广播 `UI_SETTINGS_CHANGED`：`what=lyric_size/lyric_source` 即时生效。
（补充）
  - 设置页标题可去掉“来源许可”提示（如需），避免误导。

F. 服务器端建议（简述）
- 纯静态：`/lyrics/{artist}/{title}.lrc` 或 `{artist} - {title}.lrc`；
- 动态 PHP：`/lyrics/index.php?artist=...&title=...`，支持：
  - 精确匹配 + 智能模糊（清洗括号/编号/噪声标签、分词重合与子串匹配），命中率高；
  - 返回 LRC 或 `{ "syncedLyrics": "..." }`；
  - Nginx 重写：`try_files $uri $uri/ /lyrics/index.php?$args;`

---

### 受影响文件与关键点
- 布局：
  - `app/src/main/res/layout/layout_full_player_overlay.xml`
  - `app/src/main/res/layout/layout_lyrics_page.xml`
  - `app/src/main/res/layout/item_lyric_line.xml`
  - `app/src/main/res/drawable/indicator_dot_selected.xml`
  - `app/src/main/res/drawable/indicator_dot_unselected.xml`
- 代码：
  - `com/watch/limusic/LyricsController.java`
  - `com/watch/limusic/adapter/LyricsAdapter.java`
  - `com/watch/limusic/repository/LyricsRepository.java`
  - `com/watch/limusic/api/NavidromeApi.java`
  - `com/watch/limusic/api/CustomLyricsApi.java`
  - `com/watch/limusic/PlayerSettingsActivity.java`
  - `com/watch/limusic/MainActivity.java`
- 资源：
  - `app/src/main/res/values/strings.xml` 新增缺失文案（`no_lyrics`、`lyrics_disabled_low_power` 等）。

---

### 验证用例与验收标准（手表设备优先）
1) 切页与状态：
- 左划进入歌词页，右划/点击“返回播放器”回主控；40% 阈值；进度/音量区不触发切页；
- 指示器两点无淡变，仅切换；
- 顶部条联动：拖动过程中，绿条随 p 线性缩至最小 50%，蓝条随 p 增至最大 50%；
- 终态校验：停在歌词页时顶部应为左右各半（0.5/0.5），回主控页为绿 100%/蓝 0%；
- 切后台/回前台后无叠层与错位。

2) 歌词显示与交互：
- 含时间戳文件：当前行放大、始终居中；点击某行跳转到对应时间点；
- 无时间戳：纯文本模式显示，点击不 seek；
- 4 秒无操作自动回到当前行且居中。

3) 设置即时生效：
- 当前/其他字号调整立即更新；
- 切换第三方/自定义歌词源开关后，当前歌曲歌词可重新加载；
- 平滑过渡开关开启后，仅旧/新行做 120ms 过渡。

4) 歌词源优先级：
- 当自定义/第三方关闭时，回退到 Navidrome；
- 命中任一来源即缓存，下次走缓存。

5) 异常与保护：
- 主线程无网络操作；
- 进度条拖动后 600ms 内不被旧广播覆盖；
- 低电模式下歌词功能禁用、第二个指示器隐藏。

---

### 性能与功耗评估
- 懒加载：歌词页只在首次左划时 inflate；
- 列表刷新：仅两项 `notifyItemChanged`，禁用 `ItemAnimator`；
- 同步调度：多数由“下一行时间”驱动，兜底心跳 500ms（仅含时间戳时），CPU/功耗极低；
- 绘制：单 TextView 项、紧凑高度，放大以 textSize 渲染并开启抗锯齿；
- 网络：后台线程、失败回退、有缓存写入；
- 低电模式：整块功能短路；
（补充）
- 实时切页动画期间临时启用硬件图层，结束后立即还原，降低掉帧风险且不增加常驻开销；
- 顶部条权重动画仅影响 `LinearLayout` 的 `layout_weight`，不触发布局树大规模重排；拖动时按帧更新，结算用 120–200ms 减速补间，CPU/GPU 开销极低；
- 主控页可见时暂停歌词调度与渲染，确保停留在主控页时近似零耗电；
- 进度广播 UI 以有效时长为准，避免 `TIME_UNSET` 导致的无意义刷新。
- 预计在 372×430/261dpi 的手表上流畅运行，其他分辨率因居中与高度自适应亦可兼容。

---

### 风险与回滚
- 风险：
  - 个别非常规 LRC（时间戳稀疏/错误）可能仍需心跳兜底；
  - 自定义源的可用性取决于外部服务；
  - 平滑过渡在极端低频设备上可能轻微掉帧（默认关闭）。
（补充）
  - 播放器部分曲目返回 `TIME_UNSET` 时长；已增加服务端多级兜底与 UI 延后 seek 方案，剩余风险极低。
- 回滚策略：
  - 可在设置关闭自定义源与平滑过渡；
  - 关闭心跳，仅按“下一行时间”驱动（可加隐藏开关）；
  - 恢复硬切刷新与既有高度策略。

---

### 版本信息与变更摘要
- 版本：v2.5（2025-08-29，歌词页面、歌词源与性能优化）
- 变更摘要：
  - 新增：全屏播放器歌词页、两点指示器、手势切页与懒加载；
  - 歌词：鲁棒解析、二分定位、两阶段精准居中、行级最小刷新；
  - 设置：字号调节、第三方歌词源、自定义歌词源（URL 模板）、歌词平滑过渡（实验）开关；
  - 性能：后台网络、轻量调度、禁动画与稳定 ID、紧凑布局；
  - 可靠性：进度广播抑制、低电模式禁用、回前台状态校正；
  - 服务器：提供纯静态/动态（PHP）实现与模糊匹配策略建议。
- 顶部条：新增“左右联动+定格”机制，歌词页固定 0.5/0.5，主控页固定 1/0，拖动/点击切换均保持一致的视觉与手感。 