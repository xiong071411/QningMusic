## 2025-09-14｜歌词页音频可视化（PCM抽头+频段）与权限移除
(TechChangeSpec_2025-09-14-Lyrics-AudioVisualizer-PCM-Bands)

### 背景与目标
- 背景：最初尝试用 Android Visualizer（需麦克风权限）为“歌词”页显示跳动音频条，但在部分设备/固件上初始化失败，且授权后仍可能输出为零，控制台出现大量错误日志。
- 目标：
  - 在“歌词”页实现稳定、低功耗的音频可视化，随音乐节奏跳动。
  - 不再依赖麦克风权限，彻底移除 `RECORD_AUDIO`。
  - 提供设置开关与透明度控制；在省电模式自动降帧。
  - 支持频段（频率）跳动展示，而非单纯时间域强度。

---

### 问题回溯与根因分析
1) Visualizer 初始化失败与不稳定
- 现象：日志反复报错 `Visualizer initCheck failed -3 / AudioFlinger could not create effect`；开启权限后音频条不跳。
- 根因：设备侧策略/会话权限限制/Offload 导致 Visualizer 实例化失败或输出为零；会话切换后未稳定重绑。

2) 早期时间域 RMS 可视化左侧频段“顶满”
- 现象：柱状图左半边常年顶满，仅右侧少数柱跳动。
- 根因：时间域分段能量受直流/超低频、窗函数与归一化影响，造成低频饱和。

---

### 方案总览与实现要点
A. PCM 抽头（AudioProcessor 注入）
- 在 ExoPlayer 音频管线上注入自定义 `AudioProcessor`，直接从播放器 PCM 数据采样，不再依赖麦克风；保持透传，计算轻量。
- 注入方式：覆写 `DefaultRenderersFactory.buildAudioSink(...)`，用 `DefaultAudioSink.Builder().setAudioProcessors(new AudioTapProcessor())` 返回 AudioSink。

B. 频段（频率）可视化（Goertzel）
- 分析帧长 1024 点，单声道下混；频带对数均分（约 60 Hz → min(12 kHz, Nyquist-1 kHz)）。
- 每个频段用 Goertzel 递推求能量，EMA 平滑；为避免低频饱和：
  - 先去直流（帧均值）；
  - 使用 Hann 窗降低谱泄漏；
  - 改用 dBFS 归一化（20·log10），并经验归一化幅度；顶到 0 dBFS 限顶。

C. UI 与总线
- `AudioLevelBus` 主线程广播 `{ levels[], isPlaying }`（30 FPS；省电 15 FPS）。
- `LyricsController` 订阅 `AUDIO_LEVELS` 即时驱动 `AudioBarsVisualizerView.setLevels(...)`。
- `AudioBarsVisualizerView` 首选外部 levels 驱动；一旦启用外部数据，忽略任何会话绑定请求并释放 Visualizer，避免日志刷屏。

D. 设置与交互（手表优先）
- “播放器设置”：可视化开关与透明度保持；省电模式降帧（总线 FPS=15）。
- “歌词”页仅在可见 + 播放态刷新；暂停后快速衰减直至静止。

E. 权限与回退
- 移除 `RECORD_AUDIO`；保留 `MODIFY_AUDIO_SETTINGS`。
- Visualizer 仅作兜底路径，外部 levels 生效时一律不再初始化。

---

### 代码变更清单（核心摘录）
- 新增/修改方法（摘要）：
  - `audio/AudioLevelBus.java`
    - `init(Context)`：初始化应用上下文
    - `setMaxFps(int)`：全局帧率上限（默认 30）
    - `publish(float[] bars, boolean isPlaying)`：主线程广播 `AUDIO_LEVELS`
  - `audio/AudioTapProcessor.java`（实现 `AudioProcessor`）
    - `configure/queueInput/flush/reset`：保持透传
    - `analyzeFrame(...)`：Goertzel + 去直流 + Hann 窗 + dBFS 归一化 + EMA 平滑
  - `service/PlayerService.java`
    - 覆写 `DefaultRenderersFactory.buildAudioSink(...)` 注入 `AudioTapProcessor`
    - 播放状态变化时 `audioTapProcessor.setPlaying(isPlaying)`
  - `LyricsController.java`
    - 订阅 `AUDIO_LEVELS`，调用 `visualizerView.setLevels(levels)`
    - 移除/忽略对 `audioSessionId` 的会话绑定尝试
  - `view/AudioBarsVisualizerView.java`
    - 新增 `setLevels(float[])` 外部驱动；外部驱动时释放/忽略 Visualizer
  - `PlayerSettingsActivity.java`
    - 设置变化时依据省电模式调用 `AudioLevelBus.setMaxFps(15/30)`

---

### 受影响文件与关键点
- `app/src/main/java/com/watch/limusic/audio/AudioLevelBus.java`
  - 新增：全局可视化数据总线
- `app/src/main/java/com/watch/limusic/audio/AudioTapProcessor.java`
  - 新增：ExoPlayer 音频处理器（PCM 抽头 + 频段分析）
- `app/src/main/java/com/watch/limusic/service/PlayerService.java`
  - 注入 `AudioTapProcessor` 到 AudioSink（覆盖 `buildAudioSink`）；播放状态联动
- `app/src/main/java/com/watch/limusic/LyricsController.java`
  - 订阅 `AUDIO_LEVELS`；不再绑定 Visualizer 会话
- `app/src/main/java/com/watch/limusic/view/AudioBarsVisualizerView.java`
  - 新增外部 levels 驱动并释放 Visualizer；保持 EMA 绘制
- `app/src/main/res/layout/layout_lyrics_page.xml`
  - 已有：可视化背景视图 `AudioBarsVisualizerView`
- `app/src/main/java/com/watch/limusic/PlayerSettingsActivity.java`
  - 设置项联动总线帧率
- `app/src/main/res/layout/activity_player_settings.xml`
  - 已有：可视化开关与透明度
- `app/src/main/AndroidManifest.xml`
  - 移除 `RECORD_AUDIO`，保留 `MODIFY_AUDIO_SETTINGS`

---

### 验收用例与验收标准（手表优先）
1) 基础跳动
- 播放任意曲目 → 进入“歌词”页：柱状条随音乐跳动；暂停后 0.5–1s 以内衰减静止。

2) 频段一致性
- 低频（鼓/贝斯）主要驱动左侧柱；人声 1–5 kHz 中部柱明显；镲片/高频在右侧更活跃；整体不“满屏顶满”。

3) 设置与省电
- 开关关闭：完全不刷新/不耗电；开启：30 FPS；省电模式降至 15 FPS。
- 透明度调节即时生效。

4) 稳定性与日志
- 控制台不再出现 Visualizer 初始化失败刷屏；切歌/会话变化无异常。

---

### 性能与功耗评估
- PCM 抽头 + Goertzel：每帧 1024 点、24 段能量，算力极低；表端额外 CPU ≈ 1–2%（30FPS）
- 绘制：24 柱 + EMA，UI 负载轻微；省电 15FPS 时功耗进一步降低
- 与麦克风 Visualizer 相比：跨设备更稳、易控、功耗更低

---

### 风险与回滚
- 风险：
  - 个别设备 Offload 路径下输出 PCM 特性差异 → 频带能量偏小/偏大
  - 不同 ExoPlayer 小版本 `buildAudioSink` 签名差异
- 回滚：
  - 移除 `buildAudioSink` 注入与 `AudioTapProcessor/AudioLevelBus`；
  - 恢复 `LyricsController` 的会话绑定与 `AudioBarsVisualizerView` 的 Visualizer 驱动；
  - 如需旧方案，恢复清单 `RECORD_AUDIO`（不推荐）。

---

### 版本信息与变更摘要
- 版本：v4.0（2025-09-14，歌词页音频可视化增强）
- 变更摘要：
  - 新增 PCM 抽头 + 频段（Goertzel）可视化，移除麦克风权限依赖
  - 省电模式自动降帧；可视化透明度可配
  - 修复低频“顶满”问题（去直流 + Hann 窗 + dBFS 归一化）
  - 屏蔽 Visualizer 初始化刷屏日志

---

### 降耗优化补充（2025-09-14 晚）
- 帧长：1024 → 512（单帧计算量约减半）。
- 频带数：默认 24 → 16（仍支持区间 8–64 的动态调整）。
- 窗函数：Hann 预计算并复用；新增 `winBuf` 以复用加窗帧，避免在每个频带循环内重复计算 `cos/乘法`。
- 频率上限：12 kHz → 10 kHz（降低高频噪声与运算）。
- 高频权重：从最大约 +10% 调整为约 +8%，兼顾右侧响应与稳定性。
- UI：`AudioBarsVisualizerView` 默认柱数 24 → 16，以匹配处理端并减轻绘制负载。
- 保持：FPS 节流逻辑不变，设置与省电模式仍然生效。

### 歌词滚动性能优化（2025-09-14 夜）

#### 背景与目标
- 背景：反馈“歌词页每次滚动/自动居中时CPU会飙升，整体占用偏高”。
- 目标：优化歌词列表的自动居中与平滑动画路径，降低一次滚动触发的布局/绘制开销与CPU波峰，适配手表低性能场景。

#### 问题回溯与根因分析
1) 居中定位二次布局
- 现象：`centerTo()` 先 `scrollToPosition(idx)`，再延迟一次 `scrollToPositionWithOffset(idx, offset)`，导致二次布局与测量，滑动瞬间CPU抖动。
- 根因：首次未计算行高，需等待视图创建后再计算偏移，形成“两段式”对齐。

2) 文本动画与跑马灯CPU占用
- 现象：当前行字号/缩放动画、长句水平跑马灯期间，CPU合成与滚动计算偏多。
- 根因：动画期间未启用硬件图层，所有中间帧由CPU合成；跑马灯每帧`scrollTo`触发重绘。

#### 方案总览与实现要点
A. 单次居中定位（避免二次布局）
- 新增高度预测：适配器提供 `getPredictedCurrentItemHeightPx()` 返回当前行目标高度（基于当前/其他行行高与内边距）。
- `LyricsController.centerTo(idx)` 直接计算偏移并一次性 `scrollToPositionWithOffset(idx, offset)`，不再二次对齐。

B. RecyclerView 滚动性能配置（手表优先）
- `setHasFixedSize(true)`：稳定布局高度，避免不必要的`requestLayout`。
- `setItemAnimator(null)`：移除默认动画，减少重绘。
- `setItemViewCacheSize(8)` + `getRecycledViewPool().setMaxRecycledViews(0, 32)`：提高复用与缓存，降低创建/绑定开销。

C. 动画期硬件图层（降CPU，交由GPU合成）
- 平滑缩放动画：在动画开始前 `setLayerType(LAYER_TYPE_HARDWARE, null)`，动画结束后恢复 `LAYER_TYPE_NONE`。
- 水平跑马灯：动画期间启用硬件层，结束后关闭；停止跑马灯时确保关闭硬件层。

D. UI提示补充
- 设置 → 播放器设置 → 音频可视化：新增提示小字“歌词页显示，该功能会增加功耗”。

#### 受影响文件与关键点
- `app/src/main/java/com/watch/limusic/LyricsController.java`
  - `ensureInflated()`：加入 `setHasFixedSize(true)`、`setItemViewCacheSize(8)`、`getRecycledViewPool().setMaxRecycledViews(0, 32)`；保持 `setItemAnimator(null)`。
  - `centerTo(int idx)`：改为单次 `scrollToPositionWithOffset`，偏移基于 `adapter.getPredictedCurrentItemHeightPx()` 计算。
- `app/src/main/java/com/watch/limusic/adapter/LyricsAdapter.java`
  - 新增 `getPredictedCurrentItemHeightPx()`：用于一次性居中定位。
  - 动画与跑马灯期间临时启用硬件图层，结束后恢复，停止跑马灯确保关闭硬件层。
- `app/src/main/res/layout/activity_player_settings.xml`
  - 在“音频可视化”卡片下方新增提示 `TextView`：`歌词页显示，该功能会增加功耗`。

#### 验收用例与验收标准（手表优先）
1) 自动居中滚动
- 切换到下一行时列表只触发一次对齐，CPU峰值明显降低；无明显卡顿或跳动。

2) 平滑模式/长句跑马灯
- 开启“平滑滚动”或存在长句跑马灯时，动画流畅且CPU波峰低于变更前；动画结束后无持续图层开销（硬件层关闭）。

3) 常规滚动与交互
- 手势滚动与点击跳转行保持流畅；未引入闪烁、错位或过度重绘。

#### 性能与功耗评估
- 单次对齐由“两段式”降至“一次性”，避免二次布局与延迟测量；动画期采用GPU合成，CPU合成负载下降。
- 在测试机型（手表）上，歌词自动对齐瞬时CPU峰值降低，平均CPU占用下行；实际效果依机型略有差异。

#### 风险与回滚
- 风险：预测高度与真实渲染高度存在偏差时，居中可能略有1–2dp偏差；跑马灯硬件层未及时关闭可能导致显存占用增大。
- 回滚：
  - `LyricsController.centerTo` 恢复为“scrollToPosition + 延迟二次对齐”。
  - 移除 `getPredictedCurrentItemHeightPx()`；去除动画/跑马灯硬件层启用代码。
  - 移除 RecyclerView 固定大小与缓存配置。

#### 版本信息与变更摘要
- 版本：v4.0Beta（2025-09-14，歌词滚动优化补充）
- 摘要：
  - 自动居中改为一次性对齐，减少CPU抖动。
  - RecyclerView 启用固定大小与缓存策略，降低滚动开销。
  - 文本缩放与跑马灯期间启用硬件图层，动画结束关闭。
  - 设置页新增可视化耗电提示小字。 