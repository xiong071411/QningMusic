# 项目结构与功能清单（2025-08-30）

## app/src/main 目录结构
- `AndroidManifest.xml`
- `java/com/watch/limusic/`
  - `adapter/`
    - `AlbumAdapter.java`：专辑网格/列表适配器
    - `AllSongsRangeAdapter.java`：所有歌曲“范围分页”适配器（懒加载、占位行、选择模式、字母预取）
    - `LyricsAdapter.java`：歌词行渲染（稳定ID、禁ItemAnimator、行高/放大/平滑过渡）
    - `PlaylistAdapter.java`：歌单列表适配器（名称/数量/公开标识、封面）
    - `SongAdapter.java`：歌曲列表适配器（选择模式、稳定ID、拖动柄、顺序快照）
  - `api/`
    - `CustomLyricsApi.java`：自定义歌词源 URL 模板请求（支持纯文本或 JSON：syncedLyrics/lrc/lyrics）
    - `NavidromeApi.java`：OkHttp 直连版 Subsonic API（播放、歌单 CRUD、歌词、连接测试）
    - `NavidromeClient.java`：Retrofit 客户端（保留）
    - `NavidromeResponse.java`：Subsonic 响应解析实体
    - `NavidromeService.java`：Retrofit 接口定义
    - `SubsonicResponse.java`：Subsonic 原始响应模型
  - `cache/`
    - `CacheManager.java`：ExoPlayer 磁盘缓存管理（LRU 驱逐）
    - `SmartDataSourceFactory.java`：智能数据源（本地 file:// 直读；在线走缓存）
  - `CacheSettingsActivity.java`：缓存设置与清理入口
  - `database/`
    - `AlbumDao.java`：专辑 DAO
    - `AlbumEntity.java`：专辑实体
    - `CacheDetector.java`：下载/缓存状态检测辅助
    - `DatabaseConverters.java`：Room 类型转换器
    - `DownloadDao.java`：下载任务 DAO
    - `DownloadEntity.java`：下载任务实体
    - `DownloadRepository.java`：下载仓库（任务调度/状态广播封装）
    - `EntityConverter.java`：Entity ↔ 业务模型转换
    - `InitialCount.java`：初始计数/统计载体
    - `MusicDatabase.java`：Room 数据库入口
    - `MusicRepository.java`：音乐仓库（专辑/歌曲范围/字母映射/全局计数）
    - `PlaylistDao.java`：歌单头部 DAO（对账、软删除、孤儿清理）
    - `PlaylistEntity.java`：歌单实体（公开/私有、syncDirty、isDeleted 等）
    - `PlaylistSongDao.java`：歌单明细 DAO（尾部追加保持顺序、三步安全位移、按序删除）
    - `PlaylistSongEntity.java`：歌单明细实体（主键=playlistLocalId+ordinal）
    - `SongDao.java`：歌曲 DAO
    - `SongEntity.java`：歌曲实体
  - `debug/`（占位）
  - `download/`
    - `DownloadManager.java`：下载队列与线程池（进度/完成/失败/取消 LocalBroadcast）
    - `DownloadSystemValidator.java`：下载系统环境校验与兼容性处理
    - `LocalFileDetector.java`：本地已下载文件检测与路径规则
  - `DownloadSettingsActivity.java`：下载设置入口
  - `GeneralSettingsActivity.java`：通用设置页面
  - `LiMusicGlideModule.java`：Glide 配置（RGB_565、禁动画/硬件位图、缓存策略）
  - `LyricsController.java`：歌词页控制（懒加载、取词与解析、二分定位、精准居中、调度/心跳）
  - `MainActivity.java`：主界面/导航与列表、全屏播放器/歌词页/音量与定时遮罩、刷新与广播接收
  - `migration/`
    - `DownloadSystemMigration.java`：下载系统迁移
  - `model/`
    - `Album.java`：专辑模型
    - `DiscTitlesAdapter.java`：多碟标题适配（专辑内显示）
    - `DownloadInfo.java`：下载信息模型
    - `DownloadStatus.java`：下载状态枚举
    - `GenresAdapter.java`：流派适配（遗留/模型相关装配）
    - `Song.java`：歌曲模型
    - `SongWithIndex.java`：带字母索引的歌曲模型
  - `NavidromeSettingsActivity.java`：服务器/账号设置与连接测试
  - `PlayerSettingsActivity.java`：播放器与歌词设置（字号/平滑过渡/自定义歌词源/省电/刷新频率等）
  - `repository/`
    - `LyricsRepository.java`：歌词源优先级与缓存写入
    - `PlaylistRepository.java`：歌单业务封装（CRUD、同步、排序与删除）
  - `service/`
    - `PlayerService.java`：播放服务（ExoPlayer、媒体会话、全局“所有歌曲”滑动窗口、解码回退、睡眠定时/AFTER_CURRENT/AlarmManager 兜底）
  - `SettingsActivity.java`：设置入口聚合
  - `SettingsGeneralActivity.java`：设置-通用（保留/兼容）
  - `SettingsPlayerActivity.java`：设置-播放器（保留/兼容）
  - `ui/`
    - `PlaylistListActivity.java`：歌单列表页面
    - `theme/`（主题资源占位）
  - `util/`
    - `BlurUtils.java`：背景模糊工具
    - `LyricsParser.java`：LRC 解析与时间戳兼容
    - `NetworkUtils.java`：网络状态检测
    - `PinyinUtil.java`：中文拼音首字母映射
    - `SwipeGestureListener.java`：通用滑动手势监听
  - `view/`
    - `LetterIndexDialog.java`：字母索引对话框（快速跳转）
- `res/`
  - `color/`
    - `text_input_box_stroke.xml`
  - `drawable/`
    - `_495f015947fb5a94dd08afb13435b75.xml`
    - `btn_circle_bg.xml`
    - `button_background.xml`
    - `card_background_v2.xml`
    - `card_background.xml`
    - `default_album_art.xml`
    - `ic_add_playlist.xml`
    - `ic_add_to_playlist_select.xml`
    - `ic_album.xml`
    - `ic_arrow_back_white.xml`
    - `ic_artist.xml`
    - `ic_check_box_outline.xml`
    - `ic_check_box.xml`
    - `ic_delete.xml`
    - `ic_download_failed.xml`
    - `ic_download.xml`
    - `ic_downloaded.xml`
    - `ic_drag_handle.xml`
    - `ic_info.xml`
    - `ic_launcher_background.xml`
    - `ic_launcher_foreground.xml`
    - `ic_letter_index.xml`
    - `ic_music_note.xml`
    - `ic_next_rounded.xml`
    - `ic_next.xml`
    - `ic_pause_rounded.xml`
    - `ic_pause.xml`
    - `ic_play_rounded.xml`
    - `ic_play.xml`
    - `ic_playlist.xml`
    - `ic_previous_rounded.xml`
    - `ic_previous.xml`
    - `ic_qingningplayer.xml`
    - `ic_repeat_off.xml`
    - `ic_repeat_one.xml`
    - `ic_repeat.xml`
    - `ic_search.xml`
    - `ic_settings.xml`
    - `ic_shuffle.xml`
    - `ic_volume.xml`
    - `indicator_dot_selected.xml`
    - `indicator_dot_unselected.xml`
    - `item_background_v2.xml`
    - `item_background.xml`
    - `item_song_selected_bg.xml`
    - `letter_button_background.xml`
    - `letter_item_background.xml`
    - `list_divider.xml`
    - `player_background.xml`
    - `progress_bar_rounded.xml`
    - `scrollbar_thumb.xml`
    - `seekbar_thumb_invisible.xml`
    - `seekbar_thumb.xml`
  - `layout/`
    - `activity_cache_settings.xml`
    - `activity_download_settings.xml`
    - `activity_general_settings.xml`
    - `activity_main.xml`
    - `activity_navidrome_settings.xml`
    - `activity_player_settings.xml`
    - `activity_playlist_detail.xml`
    - `activity_playlist_list.xml`
    - `activity_settings_general.xml`
    - `activity_settings_list.xml`
    - `activity_settings_player.xml`
    - `activity_settings.xml`
    - `item_album_grid.xml`
    - `item_album_skeleton.xml`
    - `item_album.xml`
    - `item_letter_grid.xml`
    - `item_lyric_line.xml`
    - `item_playlist.xml`
    - `item_song.xml`
    - `layout_full_player_overlay.xml`
    - `layout_letter_index.xml`
    - `layout_lyrics_page.xml`
    - `nav_header.xml`
    - `toolbar_title_marquee.xml`
  - `menu/`
    - `drawer_menu.xml`
    - `menu_playlist_list.xml`
    - `menu_songs.xml`
    - `nav_menu.xml`
  - `mipmap-anydpi/`
    - `ic_launcher_round.xml`
    - `ic_launcher.xml`
  - `mipmap-anydpi-v26/`
    - `ic_launcher_round.xml`
    - `ic_launcher.xml`
  - `mipmap-hdpi/`
    - `ic_launcher_round.webp`
    - `ic_launcher.webp`
  - `mipmap-mdpi/`
    - `ic_launcher_round.webp`
    - `ic_launcher.webp`
  - `mipmap-xhdpi/`
    - `ic_launcher_round.webp`
    - `ic_launcher.webp`
  - `mipmap-xxhdpi/`
    - `ic_launcher_round.webp`
    - `ic_launcher.webp`
  - `mipmap-xxxhdpi/`
    - `ic_launcher_round.webp`
    - `ic_launcher.webp`
  - `values/`
    - `colors.xml`
    - `dimens.xml`
    - `ids.xml`
    - `strings.xml`
    - `styles.xml`
    - `themes.xml`
  - `xml/`
    - `backup_rules.xml`
    - `data_extraction_rules.xml`

---

## 开发文档 目录结构
- `总体项目说明.md`：项目概览、技术栈、能力清单与关键设计
- `技术变更说明（2025-08-16｜“所有歌曲”流畅度优化）.md`：所有歌曲页面性能与跳转优化
- `技术变更说明（2025-08-17--2025-08-18｜歌单与多选拖拽同步修复）.md`：歌单 CRUD、多选拖拽与同步修复
- `技术变更说明（2025-08-19｜性能优化与歌单一致性修复）.md`：性能与歌单一致性相关修复
- `技术变更说明（2025-08-25｜服务器切换与歌单修复）.md`：服务器切换体验与歌单修复
- `技术变更说明（2025-08-27｜全局滑动窗口播放与元数据一致性修复）.md`：滑动窗口播放与元数据修复
- `技术变更说明（2025-08-27｜手表切歌后进度与时长显示异常修复）.md`：进度/时长显示异常修复
- `技术变更说明（2025-08-28｜设置三级导航与全屏播放器模糊优化）.md`：设置导航与模糊背景优化
- `技术变更说明（2025-08-29｜全屏播放器歌词页与歌词源、性能优化）.md`：歌词页、歌词源与相关性能优化
- `技术变更说明（2025-8-20｜专辑首屏修复、蓝牙线控修复）.md`：专辑首屏问题与蓝牙线控修复
- `技术变更说明（2025-8-20｜修复进度条显示）.md`：进度条显示修复
- `自定义歌词源API标准（v1）.md`：自定义歌词源服务端与客户端协议
- `技术变更说明（2025-08-30｜定时暂停与全屏菜单遮罩、AFTER_CURRENT逻辑与定时器稳定性修复）.md`：定时暂停与稳定性修复细节

---

## 功能清单（补充完善）
- 播放器
  - 自定义 Navidrome/Subsonic 客户端（OkHttp 直连 + Retrofit 保留）
  - 流媒体播放与解码回退（FLAC→MP3），快速起播与缓冲策略
  - 后台前台服务、媒体会话、耳机拔出处理、蓝牙耳机媒体键（上一首/下一首/播放暂停）
- 全屏播放器与交互
  - 主控页/歌词页（两点指示器、左右切页、顶部权重联动）
  - 音量遮罩、定时暂停遮罩（0–60 分钟、播完当前再暂停、打开即回显）
  - 播放模式（列表循环/单曲循环/随机）、播放/暂停/上一首/下一首、进度条（TIME_UNSET 兜底与延后 seek）
  - 首屏记忆与恢复（上次板块与滚动位置）
- 歌词
  - LRC 解析（多格式时间戳/多标签行/小数点与逗号兼容）、二分定位当前行、点击跳转
  - 当前行放大/高亮、两阶段精准居中、可选平滑过渡、字号可调
  - 自定义歌词源（URL 模板，{artist}/{title}），优先级：缓存>本地下载>自定义源>Navidrome
- 列表/浏览
  - 专辑列表/详情（骨架屏、懒加载、统一封面尺寸）
  - 所有歌曲（范围分页、字母索引跳转、占位行、选择模式）
  - 全局“所有歌曲”滑动窗口播放（WINDOW_CHUNK/GUARD/MAX，边播边扩边）
  - 歌单列表与详情，长按多选添加到歌单、拖拽排序（本地排序、三步安全位移）、批量删除
  - 歌单与服务器对账（头部对齐、软删除、孤儿清理、精准删除同步）
- 下载与离线
  - 下载任务（进度/暂停/继续/取消/失败重试 LocalBroadcast）、封面离线化
  - 离线模式仅播放已下载歌曲，本地文件 `file://` 直读不写缓存
- 缓存/图片
  - ExoPlayer 磁盘缓存（LRU 驱逐）、缓存清理
  - Glide 全局降耗（RGB_565、禁动画/硬件位图）
- 中文拼音索引
  - 按拼音首字母快速定位
- 状态持久化
  - 播放列表/索引、歌曲信息、进度与模式；启动恢复（默认暂停防误触）
- 设置项与系统集成
  - 服务器/账号设置与连接测试；下载/缓存/解码兼容模式/省电模式/背景模糊与强度/进度刷新速率/歌词字号、平滑过渡、自定义歌词源 URL
  - 导航抽屉、返回逻辑优化、退出二次确认
- 定时暂停（稳定性增强）
  - 普通定时：到点立即暂停（Handler + AlarmManager 兜底，Doze 下可触发）
  - 勾选“播完当前再暂停”：到点转 AFTER_CURRENT，当前曲目自然结束或单曲重播时暂停
  - 仅勾选（分钟=0）：纯 AFTER_CURRENT，本首结束处暂停 