# 2025-08-16｜“所有歌曲”流畅度优化技术变更说明（TechChangeSpec_2025-08-16-AllSongs-Perf）

## 背景与优化目标

- **目标**：在服务端歌曲数量上升（>100 首）后，显著提升“所有歌曲”列表的首屏加载速度与滚动流畅度；保持原有交互与显示逻辑不变：
  - **排序**：按首字母分组，“#→数字→A-Z”，组内按标题升序。
  - **字母索引**：右上角字母索引，点击跳转到该分组的第一项。
  - **低开销**：适配安卓手表设备（低内存/低算力），避免大对象/大列表一次性构建。

- **约束**：
  - 不改变用户可见逻辑与操作习惯。
  - 离线/在线、下载/缓存状态显示与行为保持一致。
  - 可维护、可回滚。

---

## 主要问题回溯（按时间序）

1) 早期：全量加载 + Java 端排序导致首屏慢、内存压力大。

2) 引入按需加载后暴露的问题：
- 外键约束失败（`SQLiteConstraintException: FOREIGN KEY constraint failed (code 787)`）
  - 现象：第一次进入“所有歌曲”后返回再进入，列表无法加载，logcat 报外键失败。
  - 根因：`SongEntity.albumId` 外键约束到 `AlbumEntity.id`，但保存歌曲时未先确保 `albums` 表存在对应专辑。

- 字母跳转后仅显示左侧序号（占位），右侧信息不显示；点击无效或播放错项
  - 现象：刚进“所有歌曲”直接点“Z”，跳到了 80 多附近，85-117 行只显示序号；点击无反应，过久后点击播放到的是前面的歌；或“W”跳转初次显示在 60，滑动后又变到 88。
  - 根因（并发&加载策略耦合）：
    - 仅加载“前一半页”或“未包含可视区”的页，导致可视区仍是占位行。
    - 数据库刚完成入库（保存 117 首）后，适配器里已有的旧页缓存与新排序混合，产生行号错乱与跳转偏移。

- 删除已下载的歌曲后，右侧下载状态 UI 不刷新
  - 现象：点击“删除下载”图标后，行仍显示“已下载”，需要滚动或等待广播才更新。
  - 根因：删除后只刷新了旧 `SongAdapter`，而“所有歌曲”使用了新范围适配器，未同步刷新；未广播缓存状态变更。

- 列表左侧出现大空白
  - 现象：隐藏封面时，标题/艺术家右移，序号与文本间留出不必要空白。
  - 根因：布局中封面占位仍为可见（或 margin 未归零）。

---

## 解决方案（设计与实现）

### 一、数据层（Room + 业务仓库）
- `SongEntity` 新增字段 `initial`（首字母），并新增索引：
  - `@Index("initial")`、`@Index(value={"initial","title"})`
  - 统一 SQL 排序依据，避免 Java 端大列表排序。
- `SongDao` 新增：
  - `getSongsRange(limit, offset)`：按“#→数字→A-Z，组内按标题”排序，范围查询。
  - `getCountsByInitial()`：统计各首字母分组数量（用于字母锚点偏移）。
  - `getTotalSongCount()`：总数（与 `getSongCount()` 语义一致）。
- `EntityConverter.toSongEntity(...)`：入库时写入 `initial = PinyinUtil.getFirstLetter(title)`。
- `MusicRepository.saveSongsToDatabase(...)`：
  - 先补齐缺失专辑占位，避免外键失败：
    - 批量构造 `AlbumEntity` 轻量占位并通过 `AlbumDao.insertAlbumsIfAbsent(...)` IGNORE 插入；不覆盖已有完整专辑。
  - 更新 `initial`、`isCached` 后批量插入歌曲。
  - 入库成功后发送广播 `com.watch.limusic.DB_SONGS_UPDATED`（附带总数），用于驱动 UI 刷新。
- `MusicRepository.getLetterOffsetMap()`：
  - 将“# + 数字”合并为 `#` 锚点；仅对有计数的字母生成偏移；保持排序与 SQL 一致。

### 二、UI 适配器（按需加载 / 占位渲染）
- 新增 `AllSongsRangeAdapter`（范围加载）：
  - `getItemCount()` 返回 DB 总数；未加载项以“序号占位”轻量渲染。
  - `triggerLoadAround(position)`: 加载“**包含** position 的整页”（修复跳转后页未命中的问题）。
  - `prefetchAround(position)`: 跳转时一次性加载“当前页 + 前一页 + 后一页”，避免可视区只剩占位。
  - `clearCache()`: 在 DB 入库完成时清空已缓存页，避免旧页与新排序混合导致错乱。
  - `updateSongDownloadStatus / updateSongDownloadProgress / updateSongCacheStatus`: 保持行状态及时刷新。

### 三、界面逻辑（MainActivity）
- “所有歌曲”初始化：
  - 采用 `AllSongsRangeAdapter`，设置 `totalCount` 与 `letterOffsetMap` 后首屏预取；不再一次性加载全部。
- 字母跳转：
  - 使用 `LinearLayoutManager.scrollToPositionWithOffset(position, 0)`，确保分组首项顶对齐。
  - 调用 `prefetchAround(position)`，立即覆盖可视区与相邻页，避免“只序号”。
  - 记录 `pendingJumpLetter = letter`；如果正好处于 DB 入库与刷新窗口，待广播后自动纠正定位并再预取一次（彻底消除竞态导致的跳偏/空白）。
- DB 更新广播（`DB_SONGS_UPDATED`）：
  - `rangeAdapter.clearCache()` → 刷新 `totalCount` 与 `letterOffsetMap`。
  - 若存在 `pendingJumpLetter`：
    - 使用最新偏移再次 `scrollToPositionWithOffset` 到分组首项，并执行 `prefetchAround`。
    - 重置 `pendingJumpLetter = null`。
- 下载/缓存状态广播：
  - 依据当前适配器类型（范围/传统）分发更新，避免遗漏。
- 删除下载：
  - 删除成功后，针对当前适配器刷新行状态；并发送 `com.watch.limusic.CACHE_STATUS_CHANGED`（`isCached=false`）广播，统一让其它组件与 UI 同步状态。

### 四、布局修正
- `res/layout/item_song.xml`
  - `album_art` 默认 `visibility="gone"`，避免隐藏封面时仍占位导致左侧大空白。
  - 文本容器 `layout_marginStart` 调整为 `0dp`（如需，可改为很小值）。

---

## 关键改动清单（按文件）

- `app/src/main/java/com/watch/limusic/database/SongEntity.java`
  - 新增字段：`initial`
  - 新增索引：`@Index("initial")`、`@Index(value={"initial","title"})`

- `app/src/main/java/com/watch/limusic/database/SongDao.java`
  - 新增 `getSongsRange(limit, offset)`（含 CASE 排序）
  - 新增 `getCountsByInitial()`、`getTotalSongCount()`

- `app/src/main/java/com/watch/limusic/database/AlbumDao.java`
  - 新增 `insertAlbumsIfAbsent(List<AlbumEntity>)`（IGNORE 插入专辑占位）

- `app/src/main/java/com/watch/limusic/database/EntityConverter.java`
  - `toSongEntity(...)` 写入 `initial`

- `app/src/main/java/com/watch/limusic/database/MusicRepository.java`
  - `saveSongsToDatabase(...)`：插入专辑占位 → 写入 `initial`/`isCached` → 插入歌曲 → 发送 `DB_SONGS_UPDATED`
  - 新增 `getSongsRange(...)` 与 `getLetterOffsetMap()`

- `app/src/main/java/com/watch/limusic/adapter/AllSongsRangeAdapter.java`
  - 范围加载、占位渲染、页对齐修正、三页预取 `prefetchAround`、缓存清理 `clearCache`

- `app/src/main/java/com/watch/limusic/MainActivity.java`
  - “所有歌曲”改为范围适配器 + 首屏预取
  - 字母跳转：`scrollToPositionWithOffset` + `prefetchAround`
  - DB 更新广播：`clearCache` → 刷新总数/偏移 → 若有 `pendingJumpLetter` 则纠正定位并预取
  - 删除下载：适配两类适配器并广播 `CACHE_STATUS_CHANGED(false)`

- `app/src/main/res/layout/item_song.xml`
  - `album_art` 设为 `gone`，文本容器 marginStart=0

---

## 行为校验（与用户用例一致）

- 用例1：刚进入“所有歌曲”，立刻点击“Z”
  - 预计：精准定位到“Z”分组首项；可视区完整显示，85-117 不再只显示序号；可立即点击并播放对应歌曲。
  - 若恰逢 DB 入库刷新窗口：自动等待广播后一瞬间矫正定位 + 预取，最终仍呈现正确结果。

- 用例2：返回“专辑”，再次进入“所有歌曲”并立刻点击“Z”
  - 预计：同上；不会再出现“跳到 80 多/空白/错项”。

- 用例3：快速滚动一遍“所有歌曲”后再字母跳转
  - 预计：与之前一致，跳转与显示均正常；滚动无抖动，行状态按下载/缓存/离线在线正确展示。

---

## 性能与体验提升

- **首屏**：不再全量构建与排序；DB 端按 `initial+title` 排序 + 范围抓取；快速可见。
- **滚动**：仅按需加载所在页与相邻页，减少 I/O 与对象分配；保持流畅。
- **跳转**：`scrollToPositionWithOffset` + 三页预取，跳转后可视区立即有数据；避免“只序号”。
- **一致性**：DB 入库完成 → 广播 → 清缓存 → 刷新 → 若有挂起跳转则矫正；避免旧缓存与新排序混合导致的错乱。

---

## 兼容性与交互不变性

- **排序/索引**：仍为“#→数字→A-Z”，组内标题升序；数字与特殊字符合并为 `#` 锚点；字母按 DB 实际存在分组显示与跳转。
- **删除/下载/缓存/离线**：所有状态行为与视觉与原逻辑一致；仅适配了新范围适配器的行刷新。
- **专辑内歌曲**：仍使用原 `SongAdapter` 路径，行为不变。

---

## 已知边界 & 后续可选优化

- **偏移计算**：当前偏移基于 `getCountsByInitial()` 的聚合结果与排序规则一致，若未来引入二级排序（如忽略大小写/特殊字符等），需同步更新 SQL 排序与偏移计算。
- **搜索性能**：如需更强本地搜索，建议引入 FTS5 虚表，替代 `LIKE`。
- **离线“同曲去重优先可播放版本”**：可将“标题|艺人”键与“可离线优先权”下沉到 DB 字段，用 SQL 分组减少 Java 端去重的开销（当前已满足体验，不是必须）。
- **页大小**：`pageSize`（默认 60）可按设备/体验调节；过大影响内存，过小增加 I/O 次数。

---

## 回滚与开关建议

- 若需临时回滚到“全量加载”（不推荐）：
  - `MainActivity.loadAllSongs()` 改回绑定 `SongAdapter` 并直接 `processAndSubmitList(allSongs)`。
  - 保留本次数据层改动不影响旧路径（字段/索引存在不构成风险）。

---

## 维护提示

- **DB 版本**：`MusicDatabase` 从 v3 → v4（本项目使用 `fallbackToDestructiveMigration` 开发策略）。如未来改为迁移脚本，请在升级时批量回填 `initial`（分批事务）。
- **广播**：
  - DB 更新：`com.watch.limusic.DB_SONGS_UPDATED`（附 `totalCount`）。
  - 缓存变更：`com.watch.limusic.CACHE_STATUS_CHANGED`（`songId` + `isCached`）。
  - 下载相关：`DownloadManager.ACTION_*`（本地广播）。
- **关键开关**：
  - 预取策略在 `AllSongsRangeAdapter.prefetchAround(...)`；
  - 跳转矫正在 `pendingJumpLetter` + DB 更新广播中；
  - 页对齐在 `triggerLoadAround(...)`。

---

## 版本与变更（2025-08-16）

- 新增：范围适配器 `AllSongsRangeAdapter`（范围/占位/三页预取/缓存清理）。
- 新增：`SongEntity.initial` 字段与索引；`SongDao.getSongsRange` 等 DAO。
- 新增：`AlbumDao.insertAlbumsIfAbsent`，保存歌曲前补齐专辑占位，修复外键失败。
- 优化：字母跳转使用 `scrollToPositionWithOffset`；DB 更新广播驱动 UI 刷新与跳转矫正。
- 修复：删除下载后 UI 不刷新的问题；封面隐藏时的左侧空白问题。

---

## 附：相关文件与位置索引

- `database/SongEntity.java`、`SongDao.java`、`AlbumDao.java`、`EntityConverter.java`、`MusicRepository.java`
- `adapter/AllSongsRangeAdapter.java`、`adapter/SongAdapter.java`
- `MainActivity.java`（`loadAllSongs`、`showLetterIndexDialog`、DB 更新广播、下载与缓存广播处理）
- `res/layout/item_song.xml`

（本报告记录了“所有歌曲”流畅度优化的背景、问题、方案与改动明细，便于后续维护与升级。）
