## 2025-8-20｜进度条冻结修复（返回前台/旋转）与旧数据/缓存干扰说明
(TechChangeSpec_2025-08-20-Playback-Progress-Resume-Fix-and-Legacy-Cache-Compatibility)

### 背景与目标
- 背景：用户反馈两类问题：
  - 播放中将应用退到后台或横竖屏切换后，返回前台时播放器进度条/时间不更新，播放/暂停图标也可能不匹配；若在“卡住”状态下自动切歌，后续多首歌曲进度会停在 0，时间显示异常。
  - 覆盖安装后“所有歌曲”偶发出现同名两条且一条不可播、部分新专辑封面显示为 Navidrome 默认图；卸载重装后问题消失。
- 目标：
  - 修复返回前台/旋转后的进度条冻结与状态不同步问题，确保切歌后也能立即得到正确的时长与进度。
  - 记录并说明老数据/缓存干扰的现象与规避策略。

---

### 问题回溯与根因分析
#### 1) 进度条冻结与状态不同步
- 现象重现条件：
  - 手机端：横竖屏切换触发 Activity 重建后，返回前台进度/时间不更新。
  - OPPO 手表：通过表盘顶部“播放器直达”返回应用时出现（该入口仅在播放中生效）。
- 根因：
  - 为降温，移除了 onStart 的自动绑定；Activity 返回前台时若未绑定，服务端 `isUiVisible=false`，1s 心跳广播未启动。
  - `updatePlaybackState()` 仅更新通知与持久化，不广播 UI；切歌时只在过渡瞬间发一次广播，此时 ExoPlayer 的 `duration` 可能为 UNKNOWN，UI 侧因 `duration<=0` 不会设置进度条 `max`，导致显示“0/00:00”，且后续没有心跳纠正。

#### 2) 覆盖安装后的“同名一条不可播 / 新专辑封面为默认图”
- 现象：覆盖安装后问题存在；卸载重装（清数据+缓存）后消失。
- 根因：
  - 旧数据库/缓存与新逻辑不一致：历史版本曾将 `coverArt` 与 `albumId`/URL 混用，Glide/播放器缓存残留导致错误封面与不可播放 URL 被命中。
  - 升级覆盖不会清 Room/ExoPlayer/Glide 的磁盘缓存，老状态干扰新版本。

---

### 方案总览与实现要点
本次采取“A+B”组合：
- A（Activity 侧，省电为先）：返回前台时“条件绑定+恢复心跳”
  - `onStart()` 调用 `maybeBindIfPlaying()`：读取 `player_prefs`（服务端已持续写入），若 `last_is_playing=true` 且存在 `last_song_id`，则自动 `bindService()`；绑定成功后 `setUiVisible(true)`，恢复 1s UI 心跳广播。
- B（Service 侧，增强鲁棒）：切歌/就绪时补发一次 UI 广播
  - `onPlaybackStateChanged(STATE_READY)` 与 `onMediaItemTransition(...)` 中各补发一次 `sendPlaybackStateBroadcast()`，保证即使短时未绑定或 UI 未准备好，前台也能拿到包含正确 `duration/position` 的一帧，避免“0/00:00”卡死。

同时补充两项稳定性优化（同日合入）：
- “所有歌曲”点击定位稳定化：范围窗口内优先按 `songId` 重定位点击项，避免 UI/DB 时序漂移造成“点到相邻曲”。
- 封面加载回退收敛：仅在存在有效 `coverArtId` 时才请求网络封面；本地封面优先；否则使用占位图，避免误命中 Navidrome 默认封面。

---

### 受影响文件与关键点
- `app/src/main/java/com/watch/limusic/MainActivity.java`
  - 新增：`maybeBindIfPlaying()`（读取 `player_prefs` 的 `last_is_playing/last_song_id`，满足条件即绑定）。
  - `onStart()`：注册广播后调用 `maybeBindIfPlaying()`；绑定成功时 `setUiVisible(true)`。
  - “所有歌曲”播放：范围窗口内按 `songId` 重定位点击索引。
- `app/src/main/java/com/watch/limusic/service/PlayerService.java`
  - `onPlaybackStateChanged(STATE_READY)`：补发一次 `sendPlaybackStateBroadcast()`。
  - `onMediaItemTransition(...)`：补发一次 `sendPlaybackStateBroadcast()`。
  - 持续持久化 `last_is_playing/last_song_id` 供条件绑定判断。
- 封面加载（同日合入）：
  - `AlbumAdapter.java` / `SongAdapter.java`：本地优先；仅 `coverArtId` 才走网络；否则占位图。

---

### 验证用例与验收标准
- 返回前台/重建：
  - 播放中→按 Home 或息屏→从任务管理器/桌面图标/手表表盘播放器直达返回：进度与时间持续更新；播放/暂停图标与实际一致。
  - 播放中→横竖屏切换（Activity 重建）：返回后进度/时间不再卡住。
- 切歌：
  - 卡住复现场景下自动切到下一首：下一首应立即显示正确 `duration`，进度从 0 正常前进。
- 所有歌曲点击定位：
  - 快速切换/刷新后点击项，应精确从点击曲目开始播放，无错位。
- 封面：
  - 新导入专辑封面在手表端与手机端一致展示；无 `coverArtId` 的专辑显示占位图，不再出现 Navidrome 默认封面混入。

---

### 性能与兼容性评估
- 绑定策略：仅在“正在播放/最近在播”时自动绑定，维持低功耗目标；心跳仍为 1s，仅在 UI 可见时持续。
- 额外广播：READY/切歌各补 1 帧，次数极少，对性能与功耗影响可忽略。
- 封面/点击定位逻辑仅为条件分支与查找，CPU 代价极低。

---

### 风险与回滚
- 若个别设备仍出现偶发停更，可将播放期间在 UI 不可见时的心跳频率降到 1.5–2s 保活（待选开关，不默认启用）。
- 回滚：移除 `maybeBindIfPlaying()` 与两处补发广播，恢复原逻辑；或仅保留其一以二分定位。

---

### 旧数据/缓存干扰的说明与处置建议
- 覆盖安装会保留 Room/ExoPlayer/Glide 缓存，历史错误映射或无效 URL/封面可能被命中，导致“同名一条不可播/默认封面”。
- 建议：设置 → 缓存设置 → “清理缓存”；如问题仍在，可重新进入“所有歌曲/专辑”触发数据库刷新。卸载重装可一并清理数据库与磁盘缓存。

---

### 版本信息与变更摘要
- 分支/版本：v2.3.1（2025-8-20）
- 变更摘要：
  - 进度条冻结：A+B 方案（条件绑定恢复心跳 + READY/切歌补发广播），修复返回前台/旋转/直达后的进度与时长显示。
  - 所有歌曲：点击定位改为按 `songId` 精确匹配，避免错位开播。
  - 封面加载：仅在存在 `coverArtId` 时走网络；本地优先；无 id 用占位图，避免默认封面混入。
