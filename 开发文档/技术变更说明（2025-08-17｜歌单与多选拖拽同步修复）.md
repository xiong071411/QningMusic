## 2025-08-17｜歌单与多选/拖拽/同步修复（TechChangeSpec_2025-08-17-Playlist-UX-Fixes）

### 背景与目标

- 目标：在安卓手表设备上完成“歌单”功能闭环并修复多项交互/同步问题，确保小屏操作可用性与稳定性。
  - 歌单：本地增删改查、与 Navidrome/Subsonic 服务器同步、离线歌曲可用。
  - 交互：长按多选、选择模式标题与菜单、下载按钮/拖动柄切换、拖拽排序可用性。
  - 性能：优先不增加额外内存与计算开销，保证滚动与拖拽流畅，兼容之前的“所有歌曲”性能优化。

---

### 主要问题回溯

1) 歌单详情冷启动无法长按进入多选，需要先在其他页面触发一次多选。
2) 歌单详情进入多选后，右上角删除图标非白色，夜间主题不清晰。
3) 进入多选后未隐藏下载按钮，拖动柄与下载按钮并列，操作拥挤；拖动柄触摸区域偏小。
4) 拖拽排序不可用：
   - 有时靠近底部不会继续滚动，或拖动快速时提前结束；
   - 有时仅与上一/下一首交换、松手后又弹回；（目前仍未解决）
   - 偶发列表“游离”项与错位；（目前仍未解决）
   - 早前还出现过 `UNIQUE constraint failed: playlist_songs.playlistLocalId, playlist_songs.ordinal`。
5) 多选计数与标题：
   - “所有歌曲”进入多选后标题仍显示“所有歌曲”；
   - 所有列表在多选下标题恒为“已选择1首”，且实际只保留第一首被选中。
6) 删除歌单中的歌曲后仅本地删除，服务端未同步删除。
7) 拖拽与长按冲突：长按整行触发拖拽导致与“长按进入多选”互相抢占，表现为拖拽误触或多选失效。
8) 拖拽边缘自动滚动偶发不触发或拖拽提前结束：拖动柄触摸逻辑拦截了后续事件，ItemTouchHelper 无法持续接管。
9) 拖拽松手“弹回”：视觉顺序与适配器真实数据未同步，clearView 结束后列表回滚。
10) 拖拽后偶发“游离/错位”：未启用稳定 ID，且排序过程触发整表刷新导致复用错位。
11) “选择集”只保留第一首：选择回调未与全局集合对齐，且进入/退出选择模式的刷新策略不一致。
12) 下载区域拦截长按：长按命中下载区域时事件被子视图消费，无法进入多选。
13) 歌单详情列表刷新闪动：冷启先本地再轻量校验刷新，双 submit 时序偶发打架，造成顺序抖动感。
14) 添加到歌单的去重与顺序：已存在歌曲未过滤，或插入顺序与选择顺序不一致。
15) 歌单明细 join 为空：服务端回写歌曲明细时，本地 songs 表缺少条目导致 JOIN 结果为空，歌单页面空白。
16) 选择模式下下拉刷新误触：滑动时触发刷新打断选择/拖拽。
17) 歌单详情返回行为不一致：选择模式下返回未优先退出选择模式。
18) 暗色主题删除图标可读性差：未强制白色着色，夜间不清晰。

---

### 解决方案（设计与实现）

#### 一、拖拽排序可用性与稳定性
- 触发方式：禁用长按整行触发拖拽，仅允许通过“拖动柄”启动（防止与长按多选冲突）。
- 拖拽中：仅进行视觉移动（notifyItemMoved），不写库、不整表刷新，降低抖动与卡顿。
- 松手提交：在 ItemTouchHelper.clearView（松手）时：
  - 先将当前“视觉顺序”提交为适配器真实数据快照（commitOrderSnapshot），避免松手后“弹回”；
  - 再后台线程一次性写库 `playlistRepository.reorder(from, to)`；
  - 数据层已采用“三步安全位移”避免 ordinal 冲突（详见 `PlaylistSongDao.reorder`）。
- 列表稳定性：启用稳定 ID（stableIds）并维护内部可变列表（backingList），拖动仅 `notifyItemMoved`，杜绝“游离/错位”。
- 拖动柄体验：仅在歌单详情的“选择模式”显示拖动柄；拖动柄尺寸由 24dp→36dp，触摸逻辑改为仅在 ACTION_DOWN 启动拖动，后续交由 RecyclerView/ItemTouchHelper 处理，从而正常触发边缘自动滚动、避免提前结束。

#### 二、选择模式与标题/菜单联动
- 进入选择模式：
  - 歌单详情/专辑详情/所有歌曲：长按当前行后即进入选择模式，并立即选中该行；
  - 绑定 OnSelectionChanged 回调，将适配器内选择集与全局 `selectedSongIds` 保持一致；
  - `updateSelectionTitle()` 同时更新自定义标题视图与系统标题，标题稳定显示“已选择 n 首”。
- 菜单与导航：
  - 选择模式禁用下拉刷新，左上角改为“退出选择模式”；
  - 歌单详情：选择模式显示“删除”按钮（白色图标）；退出后恢复。
- 行视觉：
  - 选择模式隐藏下载区域，仅显示拖动柄；退出选择模式隐藏拖动柄并恢复下载按钮。

#### 三、删除与服务端同步
- 批量删除：
  - 计算本地 `ordinals` 删除本地；
  - 同时构建 `serverIndexBySongId`（依据当前本地顺序与服务器一致的索引），调用 `api.updatePlaylist(..., songIndexToRemove=indices)` 同步服务端；
  - 成功后更新歌单统计并刷新 UI。

#### 四、图标与可读性
- 勾选图标：改为“实心蓝底（#1E88E5）+ 白色粗对勾（3.2dp）”，提高手表小屏可读性；未选中为加粗白色描边 28dp。
- 删除图标：歌单详情选择模式强制白色显示。

---

### 关键改动清单（按文件）

- `app/src/main/java/com/watch/limusic/MainActivity.java`
  - 歌单详情：补齐长按进入多选；选择计数回调同步全局选择集；`updateSelectionTitle()` 同步更新自定义与系统标题；
  - 拖拽：`enableDragHandleInPlaylistDetail()` 改为 onMove 视觉移动、clearView 一次性落库，禁用长按拖拽；
  - 批量删除：构建 `serverIndexBySongId`，服务端同步 `songIndexToRemove`；
  - 歌单详情返回行为、菜单图标（白色删除）、选择模式下禁用刷新等细节。

- `app/src/main/java/com/watch/limusic/adapter/SongAdapter.java`
  - 启用 `setHasStableIds(true)` 与 `getItemId()`；
  - 内部 `backingList` + `moveItem()` 仅 `notifyItemMoved`；增加 `commitOrderSnapshot()` 将视觉顺序固化为数据；
  - 选择模式的 `toggleSelect()` 仅刷新受影响项，减少抖动；
  - 拖动柄触摸：仅 ACTION_DOWN 启动拖动；
  - 歌单详情选择模式隐藏下载、显示拖动柄；退出反向恢复；支持 `setPlaylistDetail(true)`。

- `app/src/main/java/com/watch/limusic/adapter/AllSongsRangeAdapter.java`
  - 进入/退出选择模式 `notifyDataSetChanged()`；
  - `toggleSelect()` 触发计数回调并刷新可见项；
  - 行点击在选择模式下仅刷新当前项，保持选择/标题同步。

- `app/src/main/java/com/watch/limusic/repository/PlaylistRepository.java`
  - `removeByOrdinals(...)`：接收 `serverIndexBySongId`，通过 `api.updatePlaylist` 的 `songIndexToRemove` 同步服务端删除；
  - `reorder(...)`：本地写库与统计更新（服务端排序同步为后续可选项）。

- `app/src/main/res/layout/item_song.xml`
  - `drag_handle` 由 24dp → 36dp；
  - 选择模式下隐藏/显示下载区域与拖动柄的布局基础。

- `app/src/main/res/drawable/ic_check_box.xml`、`ic_check_box_outline.xml`
  - 勾选图标改为实心蓝底+白色粗对勾；未选中为 28dp 白描边。

---

### 排查与修复细节（逐项）

- 拖拽与长按冲突（问题7）
  - 原因：默认允许长按整行触发拖拽，和“长按进入多选”冲突。
  - 修复：`ItemTouchHelper.isLongPressDragEnabled=false`；仅通过拖动柄在 ACTION_DOWN 调用 `startDrag` 启动拖拽；长按整行仅用于进入选择模式。
  - 位置：`MainActivity.enableDragHandleInPlaylistDetail()`、`SongAdapter.setOnItemLongClickListener`。

- 边缘自动滚动不触发/提前结束（问题8）
  - 原因：拖动柄 `OnTouchListener` 过度拦截事件，导致后续 move 事件未交给 RecyclerView。
  - 修复：仅在 ACTION_DOWN 返回 true 触发 `onStartDrag`，其余事件放行；边缘自动滚动恢复正常。
  - 位置：`SongAdapter.onBindViewHolder -> dragHandle.setOnTouchListener`。

- 松手“弹回”（问题9）
  - 原因：拖动期间只做视觉移动，松手后未将视觉顺序提交为真实数据。
  - 修复：`clearView` 中先 `commitOrderSnapshot()`，再异步写库。
  - 位置：`MainActivity.enableDragHandleInPlaylistDetail()`、`SongAdapter.commitOrderSnapshot()`。

- “游离/错位”（问题10）
  - 原因：未启用稳定 ID、排序期触发整表刷新导致 ViewHolder 复用错位。
  - 修复：启用 `setHasStableIds(true)` 与稳定 `getItemId()`；仅 `notifyItemMoved`；维护 `backingList`；必要时再快照提交。
  - 位置：`SongAdapter`。

- 选择集只保留第一首 & 标题不同步（问题11）
  - 原因：适配器选择集与全局 `selectedSongIds` 未对齐；进入/退出选择模式未统一刷新策略。
  - 修复：引入 `OnSelectionChanged` 回调；`toggleSelect` 仅刷新受影响项；进入/退出选择模式做一次性刷新；统一 `updateSelectionTitle()`。
  - 位置：`SongAdapter`、`AllSongsRangeAdapter`、`MainActivity`。

- 下载区域拦截长按（问题12）
  - 原因：长按命中下载子视图被消费，行级长按不触发。
  - 修复：选择模式下隐藏下载区域，仅显示拖动柄；下载区域自身长按消费但进入选择模式后不再可见。
  - 位置：`SongAdapter.onBindViewHolder`。

- 歌单详情刷新闪动（问题13）
  - 原因：冷启先本地列表，再轻量校验后二次提交，时序打架造成视觉抖动。
  - 修复：两次都采用 `processAndSubmitListKeepOrder`，避免排序变动；UI 层不整表刷新，仅必要时提交。
  - 位置：`MainActivity.openPlaylistDetail` 附近的两处加载与校验线程。

- 添加去重与顺序（问题14）
  - 原因：未过滤已存在歌曲、或插入位置与选择顺序不一致。
  - 修复：DAO 查询交集 `getExistingIds` 过滤；采用“按尾部追加保持选择顺序”。
  - 位置：`PlaylistSongDao.insertAtTailKeepingOrder`、`PlaylistRepository.addSongsAtHeadFiltered`。

- 歌单明细 JOIN 为空（问题15）
  - 原因：本地 songs 表缺少服务端返回的歌曲元数据，导致 JOIN 无结果。
  - 修复：回写服务端明细前先补齐 `songs` 与必要的专辑占位，再落库明细。
  - 位置：`PlaylistRepository.validateAndMaybeRefreshFromServer`。

- 下拉刷新误触（问题16）
  - 原因：选择/拖拽时仍允许 SwipeRefresh 处理手势。
  - 修复：进入选择模式禁用刷新，退出后恢复。
  - 位置：`MainActivity.updateNavigationForSelectionMode / exitSelectionMode`。

- 返回行为不一致（问题17）
  - 原因：选择模式下仍保留原页面返回行为。
  - 修复：工具栏导航在选择模式下改为“退出选择模式”。
  - 位置：`MainActivity.updateNavigationForSelectionMode`。

- 暗色主题删除图标（问题18）
  - 原因：图标着色未强制白色。
  - 修复：选择模式下强制白色图标。
  - 位置：`MainActivity` 菜单配置。

- 数据库唯一约束冲突（补充：问题4延伸）
  - 原因：直接移动 ordinal 容易与区间重叠导致 `(playlistLocalId, ordinal)` 唯一冲突。
  - 修复：DAO 采用“三步安全位移”法：将待覆盖区间暂存到高位（+BIG），写入目标位，再整体回落（-BIG±1）。
  - 位置：`PlaylistSongDao.reorder`。

- 服务端删除同步（补充：问题6延伸）
  - 要点：服务端 `updatePlaylist` 接口使用 `songIndexToRemove`，索引以服务端当前顺序为准。
  - 方案：在本地顺序等同服务端的前提下构建 `serverIndexBySongId`；如未来存在多端排序差异，需先拉取服务端顺序再映射。
  - 位置：`PlaylistRepository.removeByOrdinals`、`NavidromeApi.updatePlaylist`。

---

### 行为校验（关键用例）

- 用例1：冷启动→歌单详情→长按任一项
  - 预期：立即进入多选，标题显示“已选择 1 首”，右上角显示白色“删除”。
- 用例2：歌单详情→进入多选→向下拖到列表底部
  - 预期：列表自动向下滚动；手未松不结束；松手后位置稳定不弹回；短暂后台写库。
- 用例3：歌单详情→多选删除若干项
  - 预期：本地与服务器均删除；返回歌单列表后数量一致。
- 用例4：“所有歌曲”→长按进入多选→连续点选多项
  - 预期：标题准确显示“已选择 n 首”；复选框与高亮状态与选择集一致。

---

### 性能与体验

- 拖拽中不写库、不整表刷新，仅 `notifyItemMoved`，提升流畅度，降低卡顿与抖动。
- 仅在必要时提交顺序快照与后台写库；数据库侧采用三步安全位移规避唯一冲突。
- 保持“所有歌曲”范围适配器的轻量策略，不影响此前性能优化。

---

### 兼容性与交互不变性

- 保持“所有歌曲”排序/索引与既有逻辑一致；
- 选择模式的入口与标题规则一致化到“所有歌曲/专辑详情/歌单详情”；
- 资源/图标替换向下兼容深色主题。

---

### 已知边界 & 后续可选优化

- 服务端排序同步：当前仅本地排序生效，若需要与服务器保持排序一致，可扩展 `api.updatePlaylist` 的重排参数（Navidrome 支持后接入）。
- 拖拽体验：如仍感知滚动触发不够稳，可在拖拽会话中暂时禁用 `itemAnimator` 或加入“边缘滚动加速器”。
- “所有歌曲”标题：若设备上偶发标题不同步，可将该页也统一切换为自定义跑马灯标题视图以彻底规避。

---

### 回滚与开关

- 拖拽仅视觉移动与快照提交：可通过恢复旧的“onMove 即写库并整表刷新”实现快速回滚（不推荐）。
- 勾选图标样式：如需回退可仅替换 `ic_check_box*.xml` 资源。

---

### 维护提示

- 数据库版本：本项目开发期采用 `fallbackToDestructiveMigration`；如后续改为迁移脚本，需确保 `playlist_songs` 的 ordinal 改动仍遵循“三步安全位移”。
- 广播：
  - 歌单头/明细更新：`PLAYLISTS_UPDATED` / `PLAYLIST_CHANGED`；
  - DB 更新与缓存/下载状态广播保持与 2025-08-16 方案一致。

---

### 版本与变更（2025-08-17）

- 新增：歌单详情长按即入多选（冷启动可用）。
- 优化：拖拽排序采用“视觉移动 + 松手写库 + 稳定 ID + 快照提交”。
- 修复：
  - 多选标题/计数在所有列表下正确更新；
  - 歌单详情选择模式菜单图标为白色；
  - 选择模式下隐藏下载，仅显示拖动柄；
  - 批量删除同步至服务器；
  - 勾选图标可读性（实心蓝底+白勾）。

---

### 附：相关文件与位置索引

- `MainActivity.java`（拖拽交互、选择模式标题/菜单、批量删除服务端同步）
- `adapter/SongAdapter.java`（稳定 ID、backingList、拖动柄触摸、commitOrderSnapshot）
- `adapter/AllSongsRangeAdapter.java`（选择模式刷新与选择计数回调）
- `repository/PlaylistRepository.java`（remove 同步 server、reorder 写库）
- `database/PlaylistSongDao.java`（三步安全位移重排、去重/插入策略、辅助查询）
- `api/NavidromeApi.java`（`updatePlaylist` 的 name/public/add/remove 参数与调用）
- `res/layout/item_song.xml`（拖动柄 36dp）
- `res/drawable/ic_check_box*.xml`（勾选图标样式） 