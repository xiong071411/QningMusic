## 2025-10-03｜下载管理排序持久化与字母检索显示优化
(TechChangeSpec_2025-10-03-Downloads-Sort-Persist-And-Index-Visibility)

### 方案总览与实现要点

本次变更围绕“下载管理-已下载”页的排序与字母检索一致性问题，提供可切换且可持久化的排序模式，并据排序模式动态显示字母检索入口：
- 新增排序模式（持久化）：
  - 按下载时间（最新在前，默认）
  - 按标题 A–Z 排序
- 字母检索显示策略：
  - 仅在“按标题 A–Z 排序”时显示“字母索引（放大镜）”。
  - 在“按下载时间（最新在前）”模式下隐藏字母索引，避免与非字母顺序冲突。
- 交互优化：
  - 将“暂停/继续/取消全部”合并为“下载操作”小悬浮菜单（PopupMenu），并集成排序切换项，减少工具栏占位、提升手表端可用性。
  - 首次进入“下载管理”即按持久化的排序模式渲染列表与菜单。

### 问题回溯与根因分析

- 历史问题：
  - “已下载”列表原按下载时间（最新在前）展示，而字母检索语义天然绑定于按标题排序的列表，导致跳转偏移不符合直觉。
  - 工具栏空间受限，多个操作按钮同时存在时，字母检索易被挤出或时序上迟迟不显示。
- 根因：
  - 列表顺序与字母索引分组语义不一致。
  - 进入页面与数据刷新时机导致菜单可见性与数据状态存在竞态。

### 受影响文件与关键点（路径相对 `app/src/main/`）

- `java/com/watch/limusic/MainActivity.java`
  - 菜单逻辑：`onCreateOptionsMenu(...)`
    - 仅当当前视图为 `downloads` 且排序模式为“按标题 A–Z”且“已下载”有数据时，显示 `action_letter_index`。
  - 下载数据刷新：`refreshDownloadsData(boolean force)`
    - 依据 `downloadsSortMode` 选择提交策略：
      - 按标题 A–Z：对歌曲标题进行不区分大小写排序后提交。
      - 按下载时间（最新在前）：对数据库返回的“完成列表”逆序（最新在前）并保序提交。
    - 提交完成后 `invalidateOptionsMenu()`，确保菜单即时反映。
  - 排序持久化：
    - 读取：`openDownloadsEmbedded()` 启动时从 `SharedPreferences("downloads_prefs").getInt("sort_mode", 0)` 恢复。
    - 写入：`applyDownloadsSortMode(int mode)` 更改时保存并强制刷新。
  - 下载操作入口：
    - 将原 3 个按钮合并为 `action_download_ops`；
    - `showDownloadOpsPopup()` 使用 `PopupMenu(toolbar, Gravity.END)` 弹出“继续全部/暂停全部/取消全部”与“排序切换”菜单项（带选中态）。
  - 字母索引弹窗：`showLetterIndexDialog()` 已支持 `downloads` 分支的 ConcatAdapter 偏移计算与折叠自动展开。

- `res/menu/menu_downloads.xml`
  - 新增/保留项：`action_download_ops`、`action_letter_index`、`action_enter_selection`；
  - 调整 `android:orderInCategory`，保证放大镜优先级更高、显示更靠前。

- `java/com/watch/limusic/adapter/SongAdapter.java`
  - `processAndSubmitListKeepOrder(...)`：在主线程提交列表时同步更新字母索引映射，避免时序导致的映射错位；
  - `getPositionForLetter(...)`：
    - `#` 跳转定义为“首个非 A–Z 开头项”；
    - 对 A–Z 未命中字母做向前回退兜底，提升接近定位的稳定性（仅适用于按标题排序时的严格定位）。

- `res/drawable/ic_more_vert.xml`
  - 新增三点更多图标，作为“下载操作”入口图标。

- `java/com/watch/limusic/adapter/DownloadTaskAdapter.java`
  - `DOWNLOAD_PAUSED` 状态：右侧动作按钮（继续）改为黄色（`R.color.download_progress_paused`），与进度条暂停色一致。

- `java/com/watch/limusic/download/DownloadManager.java`
  - `resumeDownload(Song)`：在全局暂停时单曲“显式恢复”将被临时放行一次启动，随后立即恢复全局暂停，避免批量拉起其它等待任务；增加日志标记该行为。

### 行为变更明细

- 工具栏“下载操作”整合为 PopupMenu，包含“继续全部/暂停全部/取消全部/排序切换”。
- 新增排序模式（持久化记忆）：按下载时间（最新在前，默认）与按标题 A–Z。
- 仅在“按标题 A–Z”模式下显示字母索引按钮；下载时间模式下隐藏。
- 暂停态下载任务右侧动作按钮（继续）统一使用黄色（暂停色）。
- 在“暂停全部”状态下，单曲“继续”会被临时放行一次启动下载（若并发已满则入等待），随后恢复全局暂停。

### 验收用例与标准（手表优先）

1) 进入“下载管理”，按上次保存的排序模式展示；切换排序后立即刷新并持久化；重启应用保持。
2) 标题 A–Z 模式：放大镜显示，点击字母准确跳转；
3) 下载时间模式：放大镜隐藏；
4) 暂停全部后点击某单曲“继续”：该曲可实际进入 DOWNLOADING（并发满则进入 WAITING，稍后自动开始）；
5) 暂停态右侧动作按钮显示黄色；
6) PopupMenu 在手表上锚定右上角显示，不遮挡全屏。

### 性能与功耗评估

- 工具栏按钮合并，减少视图与测量；PopupMenu 代替全屏对话框，交互更轻量；
- 排序时在工作线程完成计算，主线程只做提交与 `invalidateOptionsMenu()`；
- 字母索引仅在标题排序模式使用，减少无效计算；
- 代码路径短、变更集中，对功耗与内存影响可忽略。

### 风险与回滚策略

- 风险：极端时序下菜单显示与数据可能短暂不同步；单曲临时放行需确保不拉起批量任务。
- 兜底：列表提交后统一刷新菜单；单曲放行后立即恢复 `globalPaused=true`。
- 回滚：
  - 恢复旧的三个下载操作按钮；
  - 移除排序切换与持久化读取；
  - 恢复字母索引按钮固定显示策略。

### 日志与告警优化

- 在 `DownloadManager.resumeDownload()` 输出“全局暂停中，单曲显式恢复：临时放行一次”日志，便于排查；
- 其余日志维持简洁，避免刷屏与性能影响。

### 设置与入口新增（路径相对 `app/src/main/`）

- 无（仅复用“下载管理”内的工具栏入口与 PopupMenu）。

### 版本信息与变更摘要

- 版本：4.0Beta6（2025-10-03，合入开发分支）
- 摘要：
  - 下载管理：排序模式（标题 A–Z/下载时间）与持久化；
  - 字母索引仅在标题排序模式下显示；
  - 工具栏操作合并为 PopupMenu；
  - 暂停态动作按钮变更为黄色；
  - 在“暂停全部”下支持单曲显式恢复一次下载。


