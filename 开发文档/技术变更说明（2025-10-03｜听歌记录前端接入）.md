## 2025-10-03｜听歌记录前端接入
(TechChangeSpec_2025-10-03-Listen-Report-Integration)

### 方案总览与实现要点

本次改动在 Android 手表端接入“听歌记录”网站的接口文档（见 `开发文档/android_integration.md`）。策略为：仅在“新曲开始播放且进度≤2秒”时上报一次，网络/5xx 失败重试一次，其他错误不重试；未配置直接跳过，尽量不影响播放性能。

### 问题回溯与根因分析

- 需要一个轻量、可配置、易维护的上报机制，避免引入复杂依赖与额外耗电。
- 播放器有明确的切歌/就绪回调（`PlayerService` 中 `onMediaItemTransition`、`STATE_READY` 与 `onIsPlayingChanged`）。
- 复用现有 OkHttp 生态，避免过多改动。

### 受影响文件与关键点（路径相对 `app/src/main/`）

- `java/com/watch/limusic/api/ListenReporter.java`
  - 读取偏好 `SharedPreferences("listen_report_settings")`：`enabled`、`base_url`、`username`、`password`；
  - Basic 认证，POST `/api/listens`，JSON 字段：`title/artist/album/source/started_at/duration_sec/external_id`；
  - 1 次短超时重试：超时/IO 或 5xx 才重试，其他直接放弃。

- `java/com/watch/limusic/service/PlayerService.java`
  - 引入 `ListenReporter`；
  - 新增 `listenReportedForCurrent`（每首仅上报一次）；
  - 在 `onMediaItemTransition` 重置标记；在 `STATE_READY` 与 `onIsPlayingChanged(true)` 时调用 `maybeReportListenIfJustStarted()`；
  - `maybeReportListenIfJustStarted()`：进度≤2s、网络可用与配置完整则异步上报。

### 行为变更明细

- 仅在“刚开始播放”窗口（≤2s）上报一次该曲目；
- 网络/5xx 失败重试一次，其余错误不重试；
- 未配置或网络不可用时跳过，不影响播放。

### 验收用例与标准（手表优先）

1) 切歌到新曲且进度≤2s：触发一次上报；超过 2s 不再上报；
2) 基本配置不完整或 `enabled=false`：完全不发起任何网络请求；
3) 网络故障/5xx：最多重试 1 次；4xx/解析错误：不重试；
4) 上报包含 `title/artist/album/source/started_at/duration_sec/external_id` 且来源标记为 `watch`。

### 性能与功耗评估

- 单线程执行器 + 短超时（1.5s 连接/读/写，2s 总超时），避免阻塞主线程与过度耗电；
- 触发窗口极短且每曲一次，不引入持续性任务；
- 使用现有网络栈，代码体量小、维护简单。

### 风险与回滚策略

- 若出现异常导致卡顿或耗电：可通过开关 `listen_report_settings.enabled=false` 立即关闭；
- 回滚：删除 `ListenReporter` 调用与设置入口，保留播放主流程。

### 日志与告警优化

- 上报失败仅在 debug 下打印必要信息，release 降噪；
- 不新增系统告警；异常已 try/catch 保护。

### 设置与入口新增（路径相对 `app/src/main/`）

- 布局：`res/layout/activity_general_settings.xml`
  - 新增卡片 `@id/card_listen_report_settings`，标题“听歌记录服务器”。
- 页面：`java/com/watch/limusic/ListenReportSettingsActivity.java`
  - 偏好命名空间：`listen_report_settings`，键：`enabled/base_url/username/password`；
  - 按钮：测试连接（GET `/api/listens?page=1&limit=1`，Basic 认证，短超时）与保存。
- 布局：`res/layout/activity_listen_report_settings.xml`
- 清单：`AndroidManifest.xml` 注册 `ListenReportSettingsActivity`。

### 版本信息与变更摘要

- 版本：4.0Beta6（2025-10-03，合入开发分支）
- 摘要：
  - 接入听歌记录上报，仅在曲目开始时上报一次；
  - 失败仅在网络/5xx 情况重试一次；
  - 提供设置入口与连接测试，默认关闭，安全可控。



