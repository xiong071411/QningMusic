## 2025-10-03｜下载管理已下载字母检索
(TechChangeSpec_2025-10-03-Downloads-Completed-Index)

### 方案总览与实现要点

为“下载管理”的“已下载”分区接入与“艺术家”页一致的字母检索能力：
- 在 `menu_downloads.xml` 新增 `action_letter_index` 按钮；
- 在 `MainActivity.showLetterIndexDialog()` 扩展 downloads 分支：当当前视图为 `downloads` 时，读取 `DownloadedSongAdapter.getAvailableIndexLetters()`，弹出 `LetterIndexDialog`，选择后通过 `getPositionForLetter(letter)` 计算内部分区位置；
- 计算 `ConcatAdapter` 偏移（头部顺序：`headerActive` → 可选 `DownloadTaskAdapter` → `headerCompleted` → `DownloadedSongAdapter`），若“已下载”折叠则自动展开并滚动到绝对位置；
- 在 `onCreateOptionsMenu` 的 `downloads` 分支中，根据 `DownloadedSongAdapter` 可用字母动态控制按钮可见性。

### 问题回溯与根因分析

- 背景：艺术家页具备字母索引，但“下载管理”-“已下载”缺少快速定位功能，长列表滚动成本高。
- 根因：下载页采用 `ConcatAdapter`，此前未为 `DownloadedSongAdapter` 提供字母索引入口；位移需考虑多分区偏移量。

### 受影响文件与关键点（路径相对 `app/src/main/`）

- `res/menu/menu_downloads.xml`
  - 新增 `action_letter_index` 菜单项。

- `java/com/watch/limusic/MainActivity.java`
  - `onCreateOptionsMenu(...)`：downloads 分支根据 `DownloadedSongAdapter.getAvailableIndexLetters()` 动态控制按钮可见性。
  - `showLetterIndexDialog()`：新增 `downloads` 分支，弹出字母索引对话框；根据展开状态计算绝对跳转位置（`headerActive`、`downloadTaskAdapter`、`headerCompleted` 偏移）。

- `开发文档/总体项目说明.md`
  - “下载管理页”与“最近优化（概览）”中补充“已下载分区接入字母检索”。

### 行为变更明细

- “已下载”分区支持字母索引弹窗；
- 折叠状态触发检索会自动展开并跳转；
- 多选模式隐藏字母索引按钮避免冲突。

### 验收用例与标准（手表优先）

1) “已下载”有数据时：放大镜按钮显示；
2) 点击放大镜选择字母，滚动到对应首项；
3) 折叠状态下触发检索：自动展开并定位；
4) 多选模式：放大镜按钮隐藏；
5) 列表刷新后再次检索：定位准确无偏移。

### 性能与功耗评估

- 使用已有索引映射与弹窗组件，改动小；
- 仅在触发时进行计算与滚动；
- 对功耗与内存影响可忽略。

### 风险与回滚策略

- 风险：分区折叠/展开与偏移计算存在竞态；
- 兜底：跳转前强制展开并重建拼接适配器；
- 回滚：移除菜单项与 `downloads` 分支逻辑。

### 版本信息与变更摘要

- 版本：4.0Beta6（2025-10-03，合入开发分支）
- 摘要：
  - “已下载”分区接入字母检索；
  - 进入时可用字母根据列表动态生成；
  - 折叠场景自动展开并精确定位。


