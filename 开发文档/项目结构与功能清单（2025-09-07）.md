# 项目结构与功能清单（2025-09-07）

更新时间：2025-09-07  
适用版本：v3.3（手表版）

---

## app/src/main 目录结构（更新点标注）
- `AndroidManifest.xml`
- `java/com/watch/limusic/`
  - `adapter/`
    - `AlbumAdapter.java`：专辑网格/列表适配器
    - `AllSongsRangeAdapter.java`：所有歌曲“范围分页”适配器（懒加载、占位行、选择模式、字母预取）
      - 更新：新增“正在播放指示器”绑定（左侧3dp品牌绿竖条、播放中标题加粗），去掉三角图标与动效
      - 更新：提供 `setCurrentPlaying(songId, isPlaying)`、`getPositionBySongId(songId)` 给 `MainActivity` 使用
    - `LyricsAdapter.java`：歌词行渲染（稳定ID、禁 ItemAnimator、行高/放大/平滑过渡）
      - 更新：平滑模式不再做 `textSize` 连续动画，改为整体 `scaleX/scaleY` 轻缩放（0.96→1.0/约160ms、左枢轴），避免“从左到右逐字放大”的违和感
      - 更新：所有绑定路径显式 `pivotX=0f` 且重置 `scale=1f`，防止复用导致左缘不齐；横向跑马灯延后一帧启动以避免动效叠加
    - `PlaylistAdapter.java`：歌单列表适配器（名称/数量/公开标识、封面）
    - `SongAdapter.java`：歌曲列表适配器（选择模式、稳定ID、拖动柄、顺序快照）
      - 更新：同 `AllSongsRangeAdapter`，新增“正在播放指示器”与 `setCurrentPlaying(...)`/`getPositionBySongId(...)`
  - `api/`
    - `CustomLyricsApi.java`：自定义歌词源 URL 模板请求（支持纯文本或 JSON：syncedLyrics/lrc/lyrics）
    - `NavidromeApi.java`：OkHttp 直连版 Subsonic API（播放、歌单 CRUD、歌词、连接测试）
    - `NavidromeClient.java`：Retrofit 客户端（保留）
    - `NavidromeResponse.java`：Subsonic 响应解析实体
    - `NavidromeService.java`：Retrofit 接口定义
    - `SubsonicResponse.java`：Subsonic 原始响应模型
  - `cache/`
    - `CacheManager.java`：ExoPlayer 磁盘缓存管理（LRU 驱逐）
      - 重要更新：线程安全的 SimpleCache 单例（`volatile` + 双重检查锁 + 并发兜底等待复用），修复偶发“Another SimpleCache instance uses the folder”崩溃
      - 支持缓存清理、释放与空间统计
    - `SmartDataSourceFactory.java`：智能数据源（本地 file:// 直读；在线走缓存，支持读写/只读两类 CacheDataSource）
  - `CacheSettingsActivity.java`：缓存设置与清理入口
  - `database/`
    - `AlbumDao.java`：专辑 DAO
    - `AlbumEntity.java`：专辑实体
    - `CacheDetector.java`：下载/缓存状态检测辅助
    - `DatabaseConverters.java`：Room 类型转换器
    - `DownloadDao.java`：下载任务 DAO
    - `DownloadEntity.java`：下载任务实体
    - `DownloadRepository.java`：下载仓库（任务调度/状态广播封装）
    - `EntityConverter.java`：Entity ↔ 业务模型转换
    - `InitialCount.java`：初始计数/统计载体
    - `MusicDatabase.java`：Room 数据库入口
    - `MusicRepository.java`：音乐仓库（专辑/歌曲范围/字母映射/全局计数）
    - `PlaylistDao.java`：歌单头部 DAO（对账、软删除、孤儿清理）
    - `PlaylistEntity.java`：歌单实体（公开/私有、syncDirty、isDeleted 等）
    - `PlaylistSongDao.java`：歌单明细 DAO（尾部追加保持顺序、三步安全位移、按序删除）
    - `PlaylistSongEntity.java`：歌单明细实体（主键=playlistLocalId+ordinal）
    - `SongDao.java`：歌曲 DAO
      - 更新：新增 `int getGlobalIndex(int cat, String ini, String title)`，用于精确计算全局索引，解决长列表远距离定位的偏差
    - `SongEntity.java`：歌曲实体
  - `debug/`（占位）
  - `download/`
    - `DownloadManager.java`：下载队列与线程池（进度/完成/失败/取消 LocalBroadcast）
    - `DownloadSystemValidator.java`：下载系统环境校验与兼容性处理
    - `LocalFileDetector.java`：本地已下载文件检测与路径规则
  - `DownloadSettingsActivity.java`：下载设置入口
  - `GeneralSettingsActivity.java`：通用设置页面
  - `LiMusicGlideModule.java`：Glide 配置（RGB_565、禁动画/硬件位图、缓存策略）
  - `LyricsController.java`：歌词页控制（懒加载、取词与解析、二分定位、精准居中、调度/心跳）
  - `MainActivity.java`：主界面/导航与列表、全屏播放器/歌词页/音量与定时遮罩、刷新与广播接收
    - 重要更新：
      - 分发“当前播放”状态到各列表适配器，驱动行内指示器样式
      - 新增悬浮“定位当前曲目”按钮（`@id/btn_locate_current`）显隐逻辑与点击定位
      - 精准居中定位：改用“两阶段 `scrollToPositionWithOffset`”即时居中，替代 SmoothScroller，显著降低卡顿
      - “所有歌曲”未加载目标行时，按钮仍可见；点击后通过 `SongDao.getGlobalIndex` 粗定位并预取，再多次复查二次/三次纠正到精准居中
      - 歌单详情：设置适配器前先隐藏列表并禁用 `ItemAnimator`，数据就绪后再显示，避免骨架与列表叠加、以及初期滚动重叠
      - 修复：移除重复方法定义、lambda 捕获改为 final/有效 final
  - `migration/`
    - `DownloadSystemMigration.java`：下载系统迁移
  - `model/`
    - `Album.java`、`DiscTitlesAdapter.java`、`DownloadInfo.java`、`DownloadStatus.java`、`GenresAdapter.java`、`Song.java`、`SongWithIndex.java`
  - `NavidromeSettingsActivity.java`：服务器/账号设置与连接测试
  - `PlayerSettingsActivity.java`：播放器与歌词设置（字号/平滑过渡/自定义歌词源/省电/刷新频率等）
  - `repository/`
    - `LyricsRepository.java`：歌词源优先级与缓存写入
    - `PlaylistRepository.java`：歌单业务封装（CRUD、同步、排序与删除）
  - `service/`
    - `PlayerService.java`：播放服务（ExoPlayer、媒体会话、全局“所有歌曲”滑动窗口、解码回退、睡眠定时/AFTER_CURRENT/AlarmManager 兜底）
      - 更新：初始化数据源走 `SmartDataSourceFactory` 与 `CacheManager`；随 `CacheManager` 并发安全增强受益，避免 SimpleCache 并发创建崩溃
  - `SettingsActivity.java` / `SettingsGeneralActivity.java` / `SettingsPlayerActivity.java`
  - `ui/`
    - `PlaylistListActivity.java`：歌单列表页面
    - `theme/`（主题资源占位）
  - `util/`
    - `BlurUtils.java`、`LyricsParser.java`、`NetworkUtils.java`、`PinyinUtil.java`、`SwipeGestureListener.java`
  - `view/`
    - `LetterIndexDialog.java`、`SeamlessMarqueeTextView.java`
- `res/`
  - `color/`
    - `text_input_box_stroke.xml`
  - `drawable/`
    - `_495f015947fb5a94dd08afb13435b75.xml`
    - `badge_audio_type.xml`
    - `btn_circle_bg.xml`
    - `button_background.xml`
    - `card_background_v2.xml`
    - `card_background.xml`
    - `default_album_art.xml`
    - `ic_add_playlist.xml`
    - `ic_add_to_playlist_select.xml`
    - `ic_album.xml`
    - `ic_arrow_back_white.xml`
    - `ic_artist.xml`
    - `ic_check_box_outline.xml`
    - `ic_check_box.xml`
    - `ic_delete.xml`
    - `ic_download_failed.xml`
    - `ic_download.xml`
    - `ic_downloaded.xml`
    - `ic_drag_handle.xml`
    - `ic_info.xml`
    - `ic_launcher_background.xml`
    - `ic_launcher_foreground.xml`
    - `ic_letter_index.xml`
    - `ic_locate.xml`（新增：定位按钮图标）
    - `ic_music_note.xml`
    - `ic_next_rounded.xml`
    - `ic_next.xml`
    - `ic_pause_rounded.xml`
    - `ic_pause.xml`
    - `ic_play_rounded.xml`
    - `ic_play.xml`
    - `ic_playlist.xml`
    - `ic_previous_rounded.xml`
    - `ic_previous.xml`
    - `ic_qingningplayer.xml`
    - `ic_repeat_off.xml`
    - `ic_repeat_one.xml`
    - `ic_repeat.xml`
    - `ic_search.xml`
    - `ic_settings.xml`
    - `ic_shuffle.xml`
    - `ic_volume.xml`
    - `indicator_dot_selected.xml`
    - `indicator_dot_unselected.xml`
    - `item_background_v2.xml`
    - `item_background.xml`
    - `item_song_selected_bg.xml`
    - `letter_button_background.xml`
    - `letter_item_background.xml`
    - `list_divider.xml`
    - `player_background.xml`
    - `progress_bar_rounded.xml`
    - `scrollbar_thumb.xml`
    - `seekbar_thumb_invisible.xml`
    - `seekbar_thumb.xml`
  - `layout/`
    - `activity_cache_settings.xml`
    - `activity_download_settings.xml`
    - `activity_general_settings.xml`
    - `activity_main.xml`（更新：新增右下角定位按钮 `@id/btn_locate_current`，36dp 圆形）
    - `activity_navidrome_settings.xml`
    - `activity_player_settings.xml`
    - `activity_playlist_detail.xml`
    - `activity_playlist_list.xml`
    - `activity_settings_general.xml`
    - `activity_settings_list.xml`
    - `activity_settings_player.xml`
    - `activity_settings.xml`
    - `item_album_grid.xml`
    - `item_album_skeleton.xml`
    - `item_album.xml`
    - `item_letter_grid.xml`
    - `item_lyric_line.xml`
    - `item_playlist.xml`
    - `item_song.xml`（更新：左侧 3dp 竖条 `@id/playing_indicator_bar`、标题左图标位保留但默认隐藏，播放时标题加粗）
    - `layout_full_player_overlay.xml`
    - `layout_letter_index.xml`
    - `layout_lyrics_page.xml`
    - `nav_header.xml`
    - `toolbar_title_marquee.xml`
  - `menu/`
    - `drawer_menu.xml`
    - `menu_playlist_list.xml`
    - `menu_songs.xml`
    - `nav_menu.xml`
  - `mipmap-anydpi/`、`mipmap-anydpi-v26/`、`mipmap-hdpi/`、`mipmap-mdpi/`、`mipmap-xhdpi/`、`mipmap-xxhdpi/`、`mipmap-xxxhdpi/`
  - `values/`
    - `colors.xml`（更新：`playing_indicator = #58D36B` 品牌绿）
    - `dimens.xml`
    - `ids.xml`
    - `strings.xml`
    - `styles.xml`
    - `themes.xml`
  - `xml/`
    - `backup_rules.xml`
    - `data_extraction_rules.xml`

---

## 开发文档 目录结构（新增）
- `总体项目说明.md`
- `技术变更说明（2025-08-16｜“所有歌曲”流畅度优化）.md`
- `技术变更说明（2025-08-17--2025-08-18｜歌单与多选拖拽同步修复）.md`
- `技术变更说明（2025-08-19｜性能优化与歌单一致性修复）.md`
- `技术变更说明（2025-08-25｜服务器切换与歌单修复）.md`
- `技术变更说明（2025-08-27｜全局滑动窗口播放与元数据一致性修复）.md`
- `技术变更说明（2025-08-27｜手表切歌后进度与时长显示异常修复）.md`
- `技术变更说明（2025-08-28｜设置三级导航与全屏播放器模糊优化）.md`
- `技术变更说明（2025-08-29｜全屏播放器歌词页与歌词源、性能优化）.md`
- `技术变更说明（2025-08-30｜定时暂停与全屏菜单遮罩、AFTER_CURRENT逻辑与定时器稳定性修复）.md`
- `技术变更说明（2025-09-06｜流媒体Seek防误跳、FLAC原生优先与音频类型徽标、回退320kbps）.md`
- `技术变更说明（2025-09-07｜正在播放指示器与定位按钮、精准居中与“所有歌曲”分页定位优化）.md`（新增）
- `项目结构与功能清单（2025-08-30）.md`
- `项目结构与功能清单（2025-09-07）.md`（本文件，新增）
- `自定义歌词源API标准（v1）.md`

---

## 功能清单（更新补充）
- 播放器
  - ExoPlayer 解码与媒体会话；FLAC→MP3 回退；快速起播与缓冲策略
  - 后台/前台服务、耳机与蓝牙媒体键；首屏记忆与恢复（默认暂停防误触）
- 列表/浏览
  - 专辑列表/详情（骨架屏、懒加载、统一封面尺寸）
  - 所有歌曲（范围分页、字母索引跳转、占位行、选择模式）
  - 歌单列表与详情，长按多选添加到歌单、拖拽排序（本地排序、三步安全位移）、批量删除
  - 全局“所有歌曲”滑动窗口播放（WINDOW_CHUNK/GUARD/MAX，边播边扩边）
  - 新增：行内“正在播放指示器”（左侧3dp绿条、标题加粗，无三角图标/无动效）
  - 新增：右下角“定位当前曲目”悬浮按钮（目标未加载也显示；点击后精准居中）
- 精准定位与居中
  - 新增：`SongDao.getGlobalIndex` 精确计算目标全局索引，用于远距离预取与粗定位
  - 新增：两阶段 `scrollToPositionWithOffset` 同步居中（先估高到位、下一帧用实高二次修正），替代 SmoothScroller，显著降低卡顿与偏差
  - 新增：多次 `postDelayed` 复查（约 160/260/320ms），目标加载即二次/三次纠正到严格居中
- 歌词
  - 平滑模式改为“左枢轴轻缩放”（0.96→1.0）替代字号动画，消除“逐字放大”错觉
  - 绑定时统一重置 `pivotX=0f`、`scale=1`；横向跑马灯延后一帧启动以避免动效叠加
- 下载与离线
  - 下载任务（进度/暂停/继续/取消 LocalBroadcast）、封面离线化；离线模式 `file://` 直读不写缓存
- 缓存/图片
  - ExoPlayer 磁盘缓存（LRU 驱逐），`CacheManager` 并发安全增强；Glide RGB_565、禁动画/硬件位图
- 稳定性与 UI 细节
  - 歌单详情：进入时先隐藏列表并禁用 `ItemAnimator`，数据就绪后显示，避免骨架与列表叠加及初期滚动重叠
  - 代码质量：移除 `MainActivity` 重复方法；lambda 捕获变量统一 final 化

---

## 关键交互与算法说明（简版）
- “定位当前曲目”流程
  1) 取当前 `songId` → 先从当前适配器 `getPositionBySongId` 获取位置
  2) 若返回 -1（未加载），调用 `SongDao.getGlobalIndex(cat, ini, title)` 得到 `approx` 粗位置，先瞬时滚至 `approx` 触发预取
  3) 连续多次延迟检查：一旦 `getPositionBySongId` 找到真实位置，立即两阶段同步居中
- 居中算法
  - 第一步：用估算项高 `scrollToPositionWithOffset(target, rvHeight/2 - estItemHeight/2)` 粗居中
  - 第二步（下一帧）：读取目标实高，再次 `scrollToPositionWithOffset` 严格居中
- 歌词平滑模式
  - 立即设置目标字号/内边距，再做 `scaleX/scaleY` 轻缩放，枢轴固定左边缘；横向跑马灯延后一帧

---

## 性能与功耗（手表端）
- 替代 SmoothScroller 的“两阶段同步居中”减少长距离滚动帧绘制，显著降低卡顿
- 隐藏/禁用不必要的 `ItemAnimator`，减少首屏与早期滚动的过渡开销
- Glide 全局降耗与缓存命中优先策略，降低网络与解码负载

---

## 稳定性与异常处理
- 缓存并发安全：`CacheManager` 使用 `volatile + DCL + 并发兜底等待`，避免 SimpleCache 同目录多实例崩溃
- 编译健壮性：移除重复方法定义、lambda 捕获变量显式 final 化
- UI 稳定：歌单详情首帧仅显示骨架，数据就绪后再显列表，避免叠加与早期重叠

---

## 验收要点（简明清单）
- 行内“正在播放指示器”：播放中项左侧绿条可见、标题加粗，其余正常
- 悬浮“定位当前曲目”按钮：
  - 目标未加载/不在屏内：按钮可见；点击后应一次到位居中（或预取后在 0.2–0.3s 内自动纠正到居中）
  - 目标在屏内：按钮可隐藏；如需“屏内也可点击居中”，可后续开关化
- 歌词平滑模式：长句不出现“逐字放大”，左缘严格对齐；横向跑马灯与缩放不互相干扰
- 歌单详情：进入时不出现骨架与列表重叠；早期滚动无多项叠影
- 缓存稳定：冷启动或服务创建不再出现 SimpleCache 并发崩溃

---

## 风险与回滚
- 居中估算高度偏差：已通过二次校正与多次复查兜底；如仍偏差，可拉长复查间隔或增加一次检查
- 极端并发：`CacheManager` 已加锁与兜底等待；如仍命中，可在 `PlayerService.onCreate` 主线程预热 `getCache()`
- 动效存在感：歌词缩放幅度与时长可微调（如 0.98/0.94，120–200ms）以平衡观感与功耗
- 若需回滚：
  - 指示器/定位按钮可通过布局/适配器开关快速禁用
  - 居中方案可退回 SmoothScroller（不建议，性能回退）
  - 歌词动效可退回“无缩放、仅字号切换” 