## 2025-09-13｜艺术家页、顶置分区与悬浮顶置按钮、艺术家二级页与导航与多选修复
(TechChangeSpec_2025-09-13-Artists-Pin-Popup-Detail-Fixes)

### 背景与目标
- 背景：
  - 新增“艺术家”一级页，按艺术家聚合显示“名称 + 歌曲数”，支持按首字母快速定位。
  - 需要“长按顶置艺术家”，并在列表顶部独立分区展示；字母索引只对未顶置生效。
  - 需提供“艺术家二级页（该艺术家的所有歌曲）”，并修复返回导航与多选标题状态异常。
  - 手表小屏优化：行元素轻量、字号更小、一屏容纳更多项；弹出操作应贴附项旁，避免遮挡。
- 目标：
  - 艺术家页一次性加载，分区展示“已顶置/全部艺术家”，字母索引忽略已顶置分区。
  - 长按艺术家弹出“悬浮小按钮”执行顶置/取消顶置。
  - 艺术家二级页点击返回与系统返回都回到艺术家一级页；多选模式退出后标题与导航恢复正常。

---

### 问题回溯与根因分析
1) 顶置操作缺少就地提示
- 根因：使用全屏对话框承载操作，弱化了“与目标项的空间关联”。

2) 艺术家二级页返回错误
- 现象：左上角返回键或系统返回没有回到“艺术家”一级页，有时回到“专辑”或仅切换标题。
- 根因：使用了专辑详情的导航模式与返回逻辑（`enterAlbumDetailNavigationMode` / `navigateBackToAlbums`），未为艺术家详情提供独立导航模式与返回入口。

3) 艺术家二级页多选后标题/返回异常
- 现象：退出多选后标题仍显示“已选择 n 首”，返回键无效或不生效；添加到歌单后标题不恢复。
- 根因：`updateSelectionTitle/restoreNavigationForView/exitSelectionMode` 未覆盖 `artist_songs` 分支，且退出多选未重设自定义标题视图与导航点击行为。

4) 离线播放误判（白色可播但被拒播 / 或离线注入未缓存项导致失败）
- 现象：“所有歌曲”页离线时，白色（缓存）歌曲点击仍提示“离线模式下只能播放已缓存的歌曲”；或离线播放时尝试播放未缓存项导致连续失败。
- 根因：UI 使用“按自定义缓存键（mp3/raw）”识别缓存，而播放点击的离线校验用“按URL”检测，口径不一致；且未覆盖 FLAC。离线全局播放还无条件调用 `playAllSongsFromGlobal`，注入了未缓存的媒体项。

---

### 方案总览与实现要点
A. 艺术家数据聚合（一次性）
- 依赖现有 `songs` 表聚合：`SongDao.getArtistCounts()`（`SELECT TRIM(artist) AS name, COUNT(*) ... GROUP BY TRIM(artist)`）。
- 仓库归并：`MusicRepository.getArtists()` 对大小写与空白归一（`trim+lowercase`），空/未知合并为“(未知艺术家)”；用 `PinyinUtil.getFirstLetter` 生成 `sortLetter`，数字并入“#”。
- 排序规则与“所有歌曲”一致：组序 0=`#`，2=`A-Z`；组内按 `name COLLATE NOCASE`。

B. 艺术家列表 UI 与分区
- 轻量列表项（无图片）：`item_artist.xml`，标题字号 16sp → 14sp；副标题“n 首歌曲”。
- 适配器 `ArtistAdapter`：
  - 分区：`pinned/unpinned` 两段；当 `pinned` 非空时插入两个头部项：`已顶置` 与 `全部艺术家`（`item_artist_section_header.xml`）。
  - 顶置持久化：`SharedPreferences("artist_prefs").pinned_keys`（存 `normalize(name)`）。
  - 字母索引：只针对 `unpinned` 构建 `letter → 全局position`；数字并入“#”。

C. 长按“悬浮顶置按钮”（就地提示）
- 行内长按触发 `PopupWindow`，布局 `popup_pin_artist.xml`（小文本按钮，12sp、轻量背景）。
- 位置：优先 `showAsDropDown(anchor, …, Gravity.END)` 贴靠当前行右侧；失败回退 `showAtLocation`。
- 点击后执行顶置/取消顶置、关闭弹窗并即时重建分区与字母索引。

D. 艺术家二级页（该艺术家的所有歌曲）
- DAO：`SongDao.getSongsByArtist(artistName)`（忽略大小写/空白，`ORDER BY title COLLATE NOCASE`）。
- 仓库：`MusicRepository.getSongsByArtist(name)` 返回 `List<Song>`。
- 主界面：`
  - 点击艺术家 → `openArtistDetail(name)` → 进入 `artist_songs` 视图。
  - 详情导航模式：新增 `enterArtistDetailNavigationMode(title)`（自定义标题 + 返回箭头）；返回回调 `navigateBackToArtists()`。
  - 适配器复用 `SongAdapter`（不显示封面），保持手表性能与一致性。

E. 返回与多选行为修复
- `onBackPressed` / `onOptionsItemSelected(android.R.id.home)` 新增 `artist_songs` 分支，统归 `navigateBackToArtists()`。
- 退出多选：
  - `exitSelectionMode()` 与 `updateSelectionTitle()` 增加 `artist_songs` 分支，恢复为当前艺术家名与正确返回行为；`restoreNavigationForView()` 支持 `artist_songs`。
  - “添加到歌单”完成后自动 `exitSelectionMode()`，使标题/导航同步恢复。

F. 手表性能与功耗
- 列表项纯文本、稳定 ID，最小刷新；分区/索引仅在顶置集合变更时重建。
- 悬浮弹窗仅在长按时短暂出现；不做持续动画；功耗可忽略。
- 离线播放路径避免注入未缓存媒体项，减少失败重试与无效I/O。

---

### 代码变更清单（核心摘录）
- 新增文件：
  - `app/src/main/java/com/watch/limusic/database/ArtistCount.java`
  - `app/src/main/java/com/watch/limusic/model/ArtistItem.java`
  - `app/src/main/java/com/watch/limusic/adapter/ArtistAdapter.java`
  - `app/src/main/res/layout/item_artist.xml`（标题 14sp）
  - `app/src/main/res/layout/item_artist_section_header.xml`
  - `app/src/main/res/layout/popup_pin_artist.xml`
- 资源与字符串：
  - `res/values/strings.xml`：`section_pinned`、`section_all_artists`、`pin_artist`、`unpin_artist`。
- DAO/仓库：
  - `SongDao.java`：`getArtistCounts()`、`getSongsByArtist(name)`。
  - `MusicRepository.java`：`getArtists()`、`getSongsByArtist(name)`。
- 缓存口径统一：
  - `CacheManager` 新增 `isCachedByAnyKey(songId)`（统一按 `stream_mp3_/{id}`、`stream_raw_/{id}`、`stream_flac_/{id}` 判定）。
  - `AllSongsRangeAdapter`/`MainActivity`/`PlayerService` 使用该方法，保证白色标记与离线放行一致。
- 主界面：`MainActivity.java`
  - 新增：`loadArtists()`、`openArtistDetail(name)`、`navigateBackToArtists()`、`enterArtistDetailNavigationMode(title)`。
  - 修改：
    - `onNavigationItemSelected(nav_artists)` → `loadArtists()`。
    - `onCreateOptionsMenu` 增加 `artists/artist_songs` 分支；`action_letter_index` 在 `artists` 时根据可用字母显隐，在 `artist_songs` 隐藏。
    - `showLetterIndexDialog()` 支持 `ArtistAdapter` 分支（按未顶置分区定位）。
    - `restoreLastViewOrDefault()` 支持恢复到 `artists`。
    - 返回逻辑：`onBackPressed` 与 `home` 处理 `artist_songs → artists`。
    - 多选恢复：`updateSelectionTitle/exitSelectionMode/restoreNavigationForView` 补齐 `artist_songs` 分支。
    - 离线播放：`AllSongsRangeAdapter` 点击播放分支（位于 `MainActivity`）在离线时改为 `setPlaylist(currentList, position)`，避免调用 `playAllSongsFromGlobal` 注入未缓存项；在线仍走 `playAllSongsFromGlobal`。

---

### 受影响文件与关键点
- 列表 UI：`item_artist.xml`（更小字号、无图片）；`item_artist_section_header.xml`（分区头）。
- 顶置交互：`ArtistAdapter`（分区/索引/PopupWindow 顶置）；`strings.xml` 文案。
- 数据：`SongDao/MusicRepository` 艺术家聚合与按艺术家取歌。
- 导航与状态：`MainActivity`（artists/artist_songs 的菜单、返回、标题、多选状态恢复）。

---

### 验收用例与验收标准（手表优先）
1) 艺术家列表与字母索引
- 列表按“已顶置/全部艺术家”分区；未顶置分区可通过标题栏字母索引定位；数字与符号归“#”。
- 标题字号更小（14sp），一屏可显示更多项；滑动顺畅。

2) 顶置交互
- 长按任意艺术家：在该行右侧出现小的悬浮按钮；点击后顶置/取消顶置；分区即时刷新；重启后仍生效。
- 字母索引仅作用于“全部艺术家”分区。

3) 艺术家二级页
- 点击艺术家进入其歌曲列表；顶部显示艺术家名；返回键与系统返回均回到“艺术家”一级页。

4) 多选与标题恢复
- 在二级页长按进入多选后，点击返回键应退出多选并恢复标题为艺术家名；添加到歌单后标题也恢复。

---

### 性能与功耗评估
- 一次性聚合 + 轻量文本项 + 稳定 ID，滚动流畅、功耗低。
- 顶置仅操作内存集合与 `SharedPreferences`，重建索引与刷新最小化；弹窗短时存在不显著耗电。

---

### 风险与回滚
- 不规范艺术家名（空/unknown/大小写混用）：已统一归并为“(未知艺术家)”并入“#”。
- 个别设备 PopupWindow 定位差异：已做 `showAsDropDown` → `showAtLocation` 回退；必要时可进一步微调偏移或改用 `BottomSheet`。
- 如艺术家数量显著增大导致一次性聚合耗时，可演进为 `ArtistEntity` 持久化与首字母字段固化（Room 迁移）。

---

### 版本信息与变更摘要
- 版本：v3.4（2025-09-13，艺术家页与交互增强）
- 变更摘要：
  - 新增“艺术家”一级页与字母索引（忽略已顶置分区）。
  - 新增“长按旁侧悬浮按钮”执行顶置/取消顶置；分区实时刷新。
  - 新增“艺术家二级页”，修复返回导航与多选标题状态；总体体验符合手表小屏交互。

---

### 附录：接口与关键方法（摘要）
- DAO：
  - `SongDao.getArtistCounts()`：统计 `name, songCount`。
  - `SongDao.getSongsByArtist(name)`：忽略大小写/空白取歌，`ORDER BY title COLLATE NOCASE`。
- 仓库：
  - `MusicRepository.getArtists()`：归并 + 首字母 + 排序，返回 `List<ArtistItem>`。
  - `MusicRepository.getSongsByArtist(name)`：返回 `List<Song>`。
- 适配器：
  - `ArtistAdapter.setData(list)`：分区 + 构建未顶置字母索引；`getAvailableIndexLetters()/getPositionForLetter(letter)`；`togglePin()`；`showPinPopup()`。
- Activity：
  - `loadArtists()` / `openArtistDetail(name)` / `navigateBackToArtists()` / `enterArtistDetailNavigationMode(title)`。
  - 菜单与索引：`onCreateOptionsMenu()` / `showLetterIndexDialog()` 覆盖 `artists/artist_songs`。 