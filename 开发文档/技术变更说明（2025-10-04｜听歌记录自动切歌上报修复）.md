## 2025-10-04｜听歌记录自动切歌上报修复
(TechChangeSpec_2025-10-04-Listen-Auto-Report-Fix)

### 方案总览与实现要点

为解决“自动切歌（随机播放/单曲循环/顺序播放）不触发听歌上报”的问题，在 `PlayerService.onMediaItemTransition(...)` 中补充一次上报触发：当切到新曲且当前处于播放状态时，调用 `maybeReportListenIfJustStarted()`。依旧沿用“每首仅上报一次、≤2s 窗口、网络可用且配置完整才上报”的既有策略，避免重复与功耗增加。对“AFTER_CURRENT（本曲结束后暂停）”场景做了保护，不在自动切曲即将暂停时触发上报。

### 问题回溯与根因分析

- 现状：初版仅在 `STATE_READY` 与 `onIsPlayingChanged(true)` 时尝试上报；手动点击播放能触发，但自动切歌在部分时序下可能不再触发上述两个回调（或 `isPlaying` 未变化），导致漏报。
- 根因：ExoPlayer 在无缝自动切换到下一曲时，事件顺序与状态变化可能与手动起播不同，导致“刚开始播放”的判定点未覆盖。
- 证据：用户反馈“自动切歌不记听歌”，结合日志可见切歌与就绪日志存在，但 ListenReporter 未必在该窗口触达。

### 受影响文件与关键点（相对 `app/src/main/`）

- `java/com/watch/limusic/service/PlayerService.java`
  - 在 `onMediaItemTransition(...)` 中，完成以下处理：
    - 重置 `listenReportedForCurrent=false`；
    - `sendPlaybackStateBroadcast()` 后，若 `player.isPlaying()` 且 `sleepType != AFTER_CURRENT`，调用 `maybeReportListenIfJustStarted()`；
    - 保持既有 `maybeReportListenIfJustStarted()` 的判定：`pos<=2000ms`、网络可用与配置完整；上报成功后置 `listenReportedForCurrent=true`。

### 行为变更明细

- 新增：自动切歌（顺序/随机）与单曲循环重复开始时，将在“起播≤2s窗口”内上报一次听歌记录。
- 保持：手动点击播放的首播上报行为不变；每首歌仅上报一次；网络/5xx 失败重试一次，其他不重试。
- 保护：`AFTER_CURRENT` 模式下，自动切到下一曲立即暂停，不触发此次补充的上报尝试。

### 验收用例与标准

1) 手动点击播放新曲，进度 ≤2s：上报一次；超过 2s 不上报；
2) 顺序播放自动切到下一曲：上报一次；
3) 单曲循环自动回到同一曲：每次重新开始播放时上报一次；
4) 随机播放自动切歌：上报一次；
5) `listen_report_settings.enabled=false` 或配置不完整：不发起请求；
6) 网络/5xx 失败重试一次，4xx/解析异常不重试；
7) 上报 JSON 字段包含：`title/artist/album/source=watch/started_at/duration_sec/external_id`；
8) 日志期望：切歌后在 0–2s 内看到一次 ListenReporter 上报日志（debug 构建），release 降噪。

### 性能与功耗评估

- 触发窗口极短、每曲一次；仅在自动切歌时多一次轻量判定，不引入轮询或持续任务；
- 仍使用单线程执行器与短超时（connect/read/write 1.5s、call 2s），主线程零阻塞；
- 手表设备优先：无额外频繁 wake-up，不增加可感知功耗。

### 风险与回滚策略

- 风险：自动切歌瞬时 `getCurrentPosition()` 大于 2s 时可能错过窗口（概率极低）；若出现，可调窄/放宽窗口或将触发点前移；
- 回滚：如需回退，删除 `onMediaItemTransition(...)` 内对 `maybeReportListenIfJustStarted()` 的调用（不影响主播放流程）。

### 版本信息与变更摘要

- 版本：4.0Beta6+（2025-10-04，合入开发分支）
- 变更摘要：
  - 修复自动切歌未上报听歌记录的问题；
  - 在媒体项切换时增加一次“刚开始播放窗口内”的上报尝试，保证自动切换/重复播放也被纳入统计；
  - 保持每曲仅上报一次与短超时重试策略，兼顾性能与稳定性。


