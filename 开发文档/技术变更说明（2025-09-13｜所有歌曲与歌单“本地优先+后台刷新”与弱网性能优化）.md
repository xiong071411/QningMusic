## 2025-09-13｜所有歌曲与歌单“本地优先+后台刷新”与弱网性能优化
(TechChangeSpec_2025-09-13-LocalFirst-BackgroundRefresh-WeakNet)

### 背景与目标
- 背景：在线模式下进入“所有歌曲”需要等待网络返回（弱网更明显），离线模式下则能秒开；歌单列表也存在类似的等待现象（较轻）。
- 目标：
  - 将“所有歌曲/歌单”改为“本地优先呈现 + 后台刷新”的统一策略，实现首屏“秒出”。
  - 网络刷新引入短超时与TTL限流，弱网快速失败、不阻塞UI。
  - 保持现有DB广播驱动的无感增量刷新与字母索引定位稳定性。

---

### 问题回溯与根因分析
1) 在线“所有歌曲”等待明显：
- 现象：在线点击“所有歌曲”需等网络返回随机500首后才初始化适配器；离线则直接读DB秒开。
- 根因：`loadAllSongs()` 先发网络再初始化UI，导致首屏被网络阻塞。

2) 歌单列表也有等待：
- 现象：弱网下歌单列表需要等网络请求才可见。
- 根因：`loadPlaylists()` 未在网络返回前先行展示本地数据。

---

### 方案总览与实现要点
A. 本地优先 + 后台刷新
- 所有歌曲：先读DB的`getSongCount()`与`getLetterOffsetMap()`，立即挂载`AllSongsRangeAdapter`并`prefetch(0)`，实现“秒出”；后台并行刷新并入库，沿用`DB_SONGS_UPDATED`广播驱动差量更新与字母定位纠正。
- 歌单：进入时先从本地`PlaylistDao.getAll()`渲染，后台网络拉取对账并广播刷新。

B. 短超时与TTL
- 新增`NavidromeApi.getAllSongsQuick()`使用短超时（connect 2s / read 6s / call 8s），弱网快速失败不阻塞UI；失败后仅降级尝试一次原通道。
- 简单TTL（15分钟）：避免频繁刷新导致功耗与流量浪费；手动下拉或空库首进不在本次改动中改动，后续可接入强制刷新。

C. RecyclerView 性能配置（手表优先）
- 在“所有歌曲”列表设置：`setHasFixedSize(true)`、`setItemAnimator(null)`、`getRecycledViewPool().setMaxRecycledViews(0, 24)`，降低首滚抖动与创建销毁开销。

---

### 受影响文件与关键点
- `app/src/main/java/com/watch/limusic/MainActivity.java`
  - 重构 `loadAllSongs()`：改为“本地优先挂载 + 后台快速刷新”，加入TTL与RecyclerView性能配置；保留原有选择模式、定位与广播处理逻辑。
  - 修改 `loadPlaylists()`：在网络线程前增加“本地优先秒出”的展示线程。
- `app/src/main/java/com/watch/limusic/api/NavidromeApi.java`
  - 新增 `getAllSongsQuick()`：基于现有`client`克隆出短超时Client，仅用于列表后台刷新；不影响播放/下载链路。

---

### 代码变更清单（核心摘录）
- 新增/修改方法：
  - `NavidromeApi.java`
    - `public List<Song> getAllSongsQuick()`：短超时随机500首，用于快速刷新入库。
  - `MainActivity.java`
    - `private void loadAllSongs()`：本地优先初始化`AllSongsRangeAdapter` → 后台按TTL触发`getAllSongsQuick()`刷新入库；RecyclerView性能优化配置。
    - `private void loadPlaylists()`：新增本地优先渲染路径，网络对账后再覆盖/增量更新。

---

### 验收用例与验收标准（手表优先）
1) 所有歌曲
- 在线弱网：点击“所有歌曲”应“秒出”列表（至少出现占位/已有数据行），不再等待网络。
- 刷新完成后，列表总数差量更新无闪烁，字母索引定位准确不跳位。

2) 歌单
- 弱网：进入歌单列表先可见本地数据，网络返回后对账与合并，不影响首屏响应。

3) 性能与功耗
- 首次滚动流畅度不下降，短超时与TTL不引入明显额外耗电。

---

### 性能与功耗评估
- 将阻塞型在线首屏改为本地优先：显著改善弱网首屏等待。
- 短超时 + TTL：减少长等待与频繁拉取，功耗为正向优化。
- RecyclerView配置：降低首滚分配与重绘，提升手表设备流畅度。

---

### 风险与回滚
- 风险：冷启动且空库时，短超时可能导致短期内列表仍为空；已通过“本地优先 + 后台自动刷新”缓解。
- 回滚：
  - 移除 `loadAllSongs()` 的“本地优先”与后台刷新块，恢复原网络优先逻辑；
  - 删除 `getAllSongsQuick()` 调用或方法本身即可；
  - 移除 `loadPlaylists()` 中“本地优先”展示线程。

---

### 版本信息与变更摘要
- 版本：v4.0（2025-09-13，在线首屏与弱网优化补充）
- 摘要：
  - “所有歌曲/歌单”统一采用“本地优先 + 后台刷新”。
  - 新增短超时快速刷新与15分钟TTL限流，弱网快速失败不阻塞UI。
  - “所有歌曲”列表增加RecyclerView性能配置，首次滚动更稳。 