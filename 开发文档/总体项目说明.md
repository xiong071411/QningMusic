# LiMusic - Navidrome 音乐播放器（Android 手表优先）
!!!这是一个为安卓手表设计的软件，开发与调优时需优先考虑性能、功耗与稳定性

## 项目简介

LiMusic 是一个连接 Navidrome/Subsonic 兼容服务器的音乐播放器，面向 Android 设备（尤其是手表）。
支持浏览专辑、播放歌曲、下载与离线播放、拼音索引、前台服务稳定播放等。

## 技术栈

- **语言与平台**: Java（部分 Kotlin 运行时依赖），Android 27+（目标 33）
- **播放**: ExoPlayer 2.18.7（扩展解码器优先、解码器失败回退）
- **网络**: OkHttp（直连）与 Retrofit（保留，逐步统一），Gson 解析
- **图片**: Glide 4.11.0
- **数据库**: Room（Album/Song/Download 三实体）
- **异步**: Kotlin Coroutines（依赖存在）；线程池/Handler（Java 实现）
- **UI/导航**: 原生 Activity + RecyclerView 适配器 + Navigation KTX（依赖存在）
- **中文排序**: Pinyin4j 2.5.1

## 构建与版本

- JDK: 17
- compileSdk: 33 / targetSdk: 33 / minSdk: 27
- 版本号: 2.1.0 (versionCode 8)
- 构建: Gradle（viewBinding 开启，release 未混淆）

## 能力一览

1. **专辑/歌曲浏览**：分页拉取与懒加载，骨架屏优化首屏体验
2. **播放控制**：播放/暂停、上一首/下一首、进度条、列表循环/单曲循环/随机
3. **离线模式**：无网仅播放已下载歌曲，播放列表自动过滤
4. **下载系统**：支持进度、暂停/继续、取消、失败重试、封面离线保存
5. **缓存管理**：播放器缓存与本地下载并存，离线直读不再写入缓存
6. **中文索引**：按拼音首字母快速定位
7. **后台播放**：前台服务 + 媒体会话，保持播放与通知控制
8. **设备兼容**：硬件解码器异常时自动回退服务器端转码（320kbps MP3）
9. **状态持久化**：自动保存播放列表/索引/进度/模式，下次启动快速恢复

## 项目结构

- `adapter/`
  - `AlbumAdapter.java`：专辑网格/列表适配器
  - `SongAdapter.java`：歌曲列表适配器
- `api/`
  - `NavidromeApi.java`：OkHttp 直连版，Subsonic 接口签名（md5 token + salt），统一 `User-Agent: LiMusic`
  - `NavidromeClient.java`：Retrofit 客户端（保留），带基本认证拦截器与统一 User-Agent
  - `NavidromeService.java`：Retrofit 接口定义（保留）
  - `SubsonicResponse.java` / `NavidromeResponse.java`：响应模型
- `cache/`
  - `CacheManager.java`：ExoPlayer 缓存管理（LRU 驱逐、磁盘大小限制）
  - `SmartDataSourceFactory.java`：智能数据源选择（本地文件直读/缓存/网络）
- `database/`
  - `MusicDatabase.java`：Room 数据库（AlbumEntity/SongEntity/DownloadEntity，v3）
  - `AlbumDao.java` / `SongDao.java` / `DownloadDao.java`
  - `EntityConverter.java` / `DatabaseConverters.java`：模型与实体转换/类型转换
  - `DownloadRepository.java` / `MusicRepository.java`：仓库层封装
- `download/`
  - `DownloadManager.java`：主动下载（并发 3，Range 续传，.part 临时文件，进度/完成/失败/取消广播）
  - `LocalFileDetector.java`：本地文件检测（下载文件命名与存在性校验）
  - `DownloadSystemValidator.java` / `migration/DownloadSystemMigration.java`：兼容/迁移支持
- `service/`
  - `PlayerService.java`：核心播放服务（ExoPlayer 构建、媒体会话、焦点、前台通知、离线/回退）
- `model/`
  - `Album.java` / `Song.java` / `DownloadInfo.java` / `DownloadStatus.java` / 其它结构体
- `util/`
  - `NetworkUtils.java`：网络可用性检测与状态上报
  - `PinyinUtil.java`：拼音索引/排序
  - `SwipeGestureListener.java`：手势
- `view/`
  - `LetterIndexDialog.java`：字母索引对话框
- `ui/theme/` 与 `res/`：主题、布局、图标与 shape

## 播放管线（核心逻辑）

- 入口：`PlayerService`
  - 使用 `DefaultRenderersFactory(EXTENSION_RENDERER_MODE_PREFER)` 并启用 `setEnableDecoderFallback(true)`
  - `SmartDataSourceFactory` 决定数据来源：
    1) 若检测到已下载文件（`LocalFileDetector`），直接 `file://` 播放（不再写入缓存）
    2) 否则走网络数据源 + ExoPlayer 磁盘缓存
  - LoadControl：30s 最小缓冲，120s 最大缓冲，起播 700ms，重缓冲后起播 5s
  - 轨道选择器：`DefaultTrackSelector`
  - 媒体会话/通知：前台服务维持播放存活，媒体键控制

- 解码兼容与转码回退
  - 优先使用设备/扩展解码器（含 FLAC）
  - 若收到硬件解码错误（如 `OMX.qti.audio.decoder.flac`），尝试同曲目以服务器转码（mp3@320kbps）重新播放
  - 已尝试过回退的曲目会记录，避免无限重试；仍失败则跳过并切下一首

- 状态持久化
  - 记录播放列表、当前索引、歌曲元数据、播放进度与模式；下次启动恢复（默认暂停，防误触）

## 离线模式

- 无网络或主动切换离线时：
  - 播放列表将被过滤为“仅已下载歌曲”
  - 仅允许从本地文件播放，拒绝网络流
  - 已下载封面优先展示

## 缓存策略

- ExoPlayer 磁盘缓存（`CacheManager` 管理）
- 典型大小：约 70MB（日志显示 73,400,320B），LRU 驱逐
- 对本地下载文件：直接文件播放，不写入播放器缓存，避免浪费空间

## 下载系统

- 并发：固定线程池（最大 3 个并发任务）
- 断点续传：使用 `Range`，临时文件以 `.part` 结尾，完成后原地重命名
- 命名规约：`/Android/data/com.watch.limusic/files/downloads/songs/{songId}.{ext}`
- 封面离线化：`downloads/covers/{albumId}.jpg`
- 扩展名：当前强制 mp3（若开启“下载强制转码”）；否则默认 mp3 兜底（后续可据 Content-Type 智能选择）
- 事件广播（`LocalBroadcastManager`）：
  - 进行中：`ACTION_DOWNLOAD_PROGRESS`，携带 `{songId, progress}`
  - 完成：`ACTION_DOWNLOAD_COMPLETE`，携带 `{songId}`
  - 失败：`ACTION_DOWNLOAD_FAILED`，携带 `{songId, errorMessage}`
  - 取消：`ACTION_DOWNLOAD_CANCELED`，携带 `{songId}`

## 网络层

- OkHttp 直连：`NavidromeApi`
  - Subsonic 认证：`u + t(md5(password+salt)) + s + v + c + f=json`
  - 统一 `User-Agent: LiMusic`
  - 关键接口：`getAlbumList2`、`getAlbum`（取曲目）/`getRandomSongs`、`stream`（含 `format/maxBitRate` 转码参数）、`getCoverArt`
- Retrofit 客户端：`NavidromeClient`（保留）
  - 统一 UA；提供 `getStreamUrl/getCoverArtUrl` 等工具方法
- 统一化建议
  - 逐步收敛到一种客户端（推荐 OkHttp 直连 + 统一签名），避免配置项/凭据分散

## 数据库（Room）

- 数据库：`MusicDatabase`（v3，`fallbackToDestructiveMigration`），开发期允许主线程操作
- 实体：`AlbumEntity` / `SongEntity` / `DownloadEntity`
  - `SongEntity` 已包含 `streamUrl` 字段（支撑离线播放与冗余校验）
- DAO：专辑/歌曲/下载的增删查改
- Repository：`MusicRepository` / `DownloadRepository` 统一对外接口

## 运行时通信

- Activity ↔ Service：绑定 `PlayerService` + 显式 `Intent`
- UI 更新：`LocalBroadcastManager` 推送播放与下载状态，Activity 订阅并刷新
- 播放控制：通过 Service binder 暴露控制能力

## 设置项总览

- 服务器设置：地址、端口、用户名、密码
- 解码兼容模式：强制服务端转码为 MP3（提升兼容性）
- 下载管理：手动下载、暂停/继续/取消、清理
- 缓存设置：缓存大小、清理缓存
- 自动恢复播放状态：重启后恢复到上次播放器状态（默认暂停）

## 权限与声明（Manifest）

- `INTERNET` / `ACCESS_NETWORK_STATE`：网络访问与状态检测
- `WAKE_LOCK`：播放时保活
- `MODIFY_AUDIO_SETTINGS`：音频焦点管理
- `FOREGROUND_SERVICE` / `FOREGROUND_SERVICE_MEDIA_PLAYBACK`：前台播放服务
- `android.hardware.type.watch`：手表设备特性
- `usesCleartextTraffic=true`：允许明文流量（便于开发/局域网服务器）
- 存储权限（用于下载到 App 外部私有目录）：`READ/WRITE_EXTERNAL_STORAGE`（按平台行为限制在 App 作用域内）

## 已知问题与排障

- 某些设备硬件 FLAC 解码器（如 `OMX.qti.audio.decoder.flac`）可能报错：
  - 已启用 ExoPlayer 扩展解码器与解码器失败回退；仍失败时将自动尝试服务端转码
  - 若“解码兼容模式”开启仍失败，将跳过该曲目并继续播放
- `MediaButtonReceiver` 警告：在部分设备/上下文中可能无法找到唯一接收者，属预期警告，不影响播放
- 下载文件扩展名：当前默认 mp3；未来将基于 Content-Type 智能确定
- 数据库允许主线程：仅为开发权衡，若出现 UI 卡顿，需将重操作移至后台

## 如何使用

1. 在设置页配置 Navidrome 服务器地址、端口与登录凭据
2. 浏览专辑或搜索音乐，进入专辑后点击歌曲播放
3. 可在歌曲项中发起下载；离线时进入“已下载”播放
4. 在设置-下载/缓存中管理空间；在设置-解码兼容模式中切换服务端转码策略

---

## 最近优化（概览）

- 播放器：优化缓冲策略（快速起播 + 更强重缓冲门槛 + 更大持续缓冲），启用扩展解码器与失败回退
- 列表：骨架屏、懒加载与视图缓存池，降低滑动抖动与首屏时间
- 缓存：离线文件直读，避免二次写缓存；提供缓存清理
- 下载：进度/暂停/继续/取消广播完善；封面离线化
- 稳定性：网络切换/离线模式/数据库同步逻辑增强


## 更新日志

### v1.9993 (2025-06-28)
- 修复进度条显示问题，确保进度条始终可见
- 优化拖动进度条时的显示效果，避免布局跳动
- 改进歌曲标题滚动效果，支持无限循环滚动
- 添加文本淡入淡出边缘效果，提升视觉体验
- 完成两阶段内存优化，显著降低内存占用
- 提升列表滚动性能和专辑加载速度
- 优化播放器缓冲策略，提高播放稳定性
- 改进缓存管理，减少磁盘空间占用
### v1.9994 (2025-07-11)（该版本实际未发布，所有更新内容合并到2.0）
- 统一网络请求客户端标识为"LiMusic"，解决服务器端显示多个客户端的问题
- 为所有HTTP请求添加统一User-Agent头，改善服务器端识别
- 重构网络请求拦截器，提高代码可维护性
- 修复MusicRepository中API调用参数不匹配问题
- 添加离线数据库支持，实现断网时查看歌曲和专辑
- 实现歌曲缓存状态检测与显示，区分已缓存和未缓存歌曲
- 优化网络状态检测，自动切换在线/离线模式
- 采用Repository设计模式，改善数据获取流程
- 改进UI视觉反馈，使已缓存和未缓存歌曲清晰区分
- 提高数据加载可靠性，减少网络异常导致的应用崩溃
- 修复进度条在专辑页面不显示的问题
- 优化缓存状态显示逻辑，在线模式下不显示缓存状态颜色区分
- 修复断网时无法切换到"所有歌曲"页面的问题
- 修复专辑点击无反应的问题
- 确保播放进度条在所有页面切换中保持可见
- 改进离线数据库加载逻辑，提高应用稳定性
- 优化UI状态管理，减少页面切换时的视觉闪烁
- 增加歌曲下载功能
- 修复离线模式下已缓存歌曲显示为灰色的问题
- 优化缓存状态检测逻辑，确保准确识别已缓存歌曲
- 增强离线模式下的播放体验，仅允许播放已下载的歌曲
- 改进播放列表过滤机制，离线模式下自动过滤未下载歌曲
- 优化数据库与缓存系统的同步，确保缓存状态实时更新
- 修复SongEntity结构，添加streamUrl字段以支持离线播放
- 提高应用在网络切换场景下的稳定性
### v2.0.0 （2025-08-14 00:40）
- 添加专辑封面缓存优化
- 支持显示下载进度
- 支持离线显示封面
- 修复离线后无法播放已下载音乐的问题
- 支持.flac格式解码
- 新修复（09:58）：修复取消下载之后UI不更新的问题
- 新修复（12:18）：修复现有模型 Album.genres 被定义为 List<String>，Gson 默认按字符串解析，遇到对象就抛出该异常，导致“加载专辑失败/加载更多失败”的问题
- 新修复（15:11）：修复缓存不命中的问题、修复弱网环境下播放异常卡顿的问题、优化启播体验，大幅降低启播时长
- 新修复（15:58）：修复播放本地音乐时仍然将本地音乐文件重复写入缓存的问题
### v2.0.1 （2025-08-14）
- 再次优化因服务端有时返回数组里是对象而不是字符串导致的专辑解析异常
- 提升专辑加载速度，减少首屏加载等待时间
- 增加骨架屏，进一步缩短用户对专辑加载时间的主观感受，提升操作流畅度
### v2.1（2025-08-15）
- 改进专辑图片加载逻辑，提升在线专辑图片加载速度
- 改进专辑页面返回逻辑，增加专辑详情页面的返回键用于返回上一级菜单
- 改进使用系统返回键退出软件时的软件退出逻辑
- 为系统返回键退出软件进行防误触处理，需二次确认才能退出软件
- 在专辑详情页面为长专辑标题设计了标题滚动，以此来能完整显示长专辑标题
- 新增自动保存播放列表/索引、歌曲信息（标题/艺术家/封面/专辑）、播放模式与进度的功能；下次打开软件时自动还原离开软件时的播放器状态，点击播放即可无缝续听。启动时默认暂停，防止误触。
- 设置页新增卡片“解码兼容模式”，针对一些设备在服务端源文件为flac等格式音频无法解码播放时，可尝试开启此选项，开启后可以强制在服务端将音频转码为320kbpsMP3，以最大化保证兼容性。
- 增强离线歌曲识别逻辑
- 增强与服务端格式不一致的歌曲的显示与处理逻辑
### v2.2（2025-8-16）
- 优化“所有歌曲”加载与滚动，字母索引跳转更快更准
- 修复跳转后只显示序号、删除下载后状态不刷新的问题
### v2.3 Beta（2025-8-17）
- 新增歌单功能
- 新增在任意界面长按多选歌曲添加到歌单
- 新增歌单编辑功能（长按对应歌单重命名/删除/改变可见范围）
- 新增歌单与服务器同步功能、
- 新增离线状态歌单支持
- 新增歌单内拖动排序功能（目前功能不完善）
- 新增歌单内音乐管理功能（长按批量删除歌单内音乐）
