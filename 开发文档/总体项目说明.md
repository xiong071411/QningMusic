# 轻柠音乐（原Limusic） - Navidrome 音乐播放器（Android 手表优先）
!!!这是一个为安卓手表设计的软件，开发与调优时需优先考虑性能、功耗与稳定性

## 项目简介

轻柠音乐（原Limusic）是一个连接 Navidrome/Subsonic 兼容服务器的音乐播放器，面向 Android 设备（尤其是手表）。
支持浏览专辑、播放歌曲、下载与离线播放、拼音索引、前台服务稳定播放等。

## 技术栈

- **语言与平台**: Java（部分 Kotlin 运行时依赖），Android 27+（目标 33）
- **播放**: ExoPlayer 2.18.7（原生支持 FLAC；扩展解码器优先；失败自动回退服务器转码 MP3@320）
- **网络**: OkHttp（直连）与 Retrofit（保留，逐步统一），Gson 解析
- **图片**: Glide 4.11.0
- **数据库**: Room（Album/Song/Download 三实体）
- **异步**: Kotlin Coroutines（依赖存在）；线程池/Handler（Java 实现）
- **UI/导航**: 原生 Activity + RecyclerView 适配器 + Navigation KTX（依赖存在）
- **中文排序**: Pinyin4j 2.5.1

## 构建与版本

- JDK: 17
- compileSdk: 33 / targetSdk: 33 / minSdk: 27
- 版本号: 3.2 (versionCode 20)
- 构建: Gradle（viewBinding 开启，release 未混淆）

## 能力一览

1. **专辑/歌曲浏览**：分页拉取与懒加载，骨架屏优化首屏体验
2. **播放控制**：播放/暂停、上一首/下一首、进度条、列表循环/单曲循环/随机
3. **离线模式**：无网仅播放已下载歌曲，播放列表自动过滤
4. **下载系统**：支持进度、暂停/继续、取消、失败重试、封面离线保存
5. **缓存管理**：播放器缓存与本地下载并存，离线直读不再写入缓存
6. **中文索引**：按拼音首字母快速定位
7. **后台播放**：前台服务 + 媒体会话，保持播放与通知控制
8. **设备兼容**：硬件解码器异常时自动回退服务器端转码（320kbps MP3）
9. **状态持久化**：自动保存播放列表/索引/进度/模式，下次启动快速恢复
10. **歌单系统（新增）**：
   - 歌单列表展示、创建/重命名/删除、公开/私有切换；
   - 与服务器（Navidrome）对账同步：头部对齐、软删除与孤儿清理；
   - 歌单详情的本地歌曲明细、离线可用；
   - 从任意列表（所有歌曲/专辑详情）长按多选添加到歌单（自动去重，保持选择顺序）。
11. **多选与拖拽（新增）**：
   - 长按进入“选择模式”，标题显示“已选择 n 首”；
   - 歌单详情选择模式下显示拖动柄，按住上下拖动进行排序（仅本地排序，后台写库）；
   - 批量删除支持本地及服务器同步（利用 `songIndexToRemove`）。
12. **下拉刷新（新增）**：
   - 顶层列表支持下拉刷新；
   - 选择模式下自动禁用刷新，避免手势冲突；
   - 歌单详情提供“同步状态”提示（绿=已同步、蓝=同步中、红=失败可重试）。
13. **Seek 防误跳（新增）**：对不可寻址/时长未就绪的流媒体，UI 严格阻止 seek 并支持同曲目就绪后一次性挂起执行
14. **音频类型徽标（新增）**：设置-播放器可开启，显示 `FLAC/MP3` 方框徽标，随曲目更新

## 项目结构

- `adapter/`
  - `AlbumAdapter.java`：专辑网格/列表适配器
  - `SongAdapter.java`：歌曲列表适配器（支持选择模式、稳定ID、拖动柄、顺序快照）
  - `AllSongsRangeAdapter.java`：所有歌曲范围适配器（分页懒加载、占位行、选择模式）
  - `PlaylistAdapter.java`：歌单列表适配器（名称/数量/公开标识、封面）
- `api/`
  - `NavidromeApi.java`：OkHttp 直连版，Subsonic 接口签名；支持 `updatePlaylist(name/public/add/remove)`
  - `NavidromeClient.java` / `NavidromeService.java`：Retrofit 客户端与接口定义（保留）
- `cache/`
  - `CacheManager.java` / `SmartDataSourceFactory.java`
- `database/`
  - `MusicDatabase.java`：Room 数据库（v3）
  - `AlbumDao.java` / `SongDao.java` / `DownloadDao.java`
  - `PlaylistDao.java` / `PlaylistSongDao.java`：歌单头与明细 DAO（对账、软删除、孤儿清理、三步安全位移重排）
  - `PlaylistEntity.java` / `PlaylistSongEntity.java`
  - `DownloadRepository.java` / `MusicRepository.java` / `PlaylistRepository.java`
- `download/`：下载系统
- `service/`：`PlayerService` 播放服务
- `util/`：网络检测、拼音、手势
- `view/`：字母索引对话框、无缝跑马灯视图（`SeamlessMarqueeTextView`）
- `ui/`：`PlaylistListActivity`（歌单列表）、`PlaylistDetailActivity`（歌单详情）、全屏播放器覆盖层

## 播放管线（核心逻辑）

- 入口：`PlayerService`
  - 使用 `DefaultRenderersFactory(EXTENSION_RENDERER_MODE_PREFER)` 并启用 `setEnableDecoderFallback(true)`
  - `SmartDataSourceFactory` 决定数据来源：
    1) 若检测到已下载文件，直接 `file://` 播放（不再写入缓存）
    2) 否则走网络数据源 + ExoPlayer 磁盘缓存
  - LoadControl：30s 最小缓冲，120s 最大缓冲，起播 700ms，重缓冲后起播 5s
  - 轨道选择器：`DefaultTrackSelector`
  - 媒体会话/通知：前台服务维持播放存活，媒体键控制

- 解码兼容与转码回退
  - 优先使用设备/扩展解码器（含 FLAC）；MediaItem 优先尝试源文件（FLAC）播放
  - 若收到硬件解码错误，自动原位回退服务器转码（mp3@320kbps）并重播；仅首次失败触发，避免死循环
  - 失败回退有记忆，仍失败则跳过

- Seek 防误跳机制
  - Service 广播携带 `isSeekable`/`isDurationUnset`，并在不可寻址时忽略外部 seek 请求
  - UI 仅在 `isSeekable && !isDurationUnset` 放行进度/歌词跳转；否则对当前曲目挂起一次
  - 切歌立即清空挂起，避免跨曲目跳转

- 状态持久化
  - 记录播放列表、当前索引、歌曲元数据、播放进度与模式；下次启动恢复（默认暂停，防误触）

## 离线模式

- 无网络或主动切换离线时：
  - 播放列表将被过滤为“仅已下载歌曲”
  - 仅允许从本地文件播放，拒绝网络流
  - 已下载封面优先展示

## 缓存策略

- ExoPlayer 磁盘缓存（`CacheManager` 管理）
- 典型大小：约 70MB，LRU 驱逐
- 对本地下载文件：直接文件播放，不写入播放器缓存

## 下载系统

- 并发：固定线程池（最大 3 个并发任务）
- 断点续传：使用 `Range`，临时文件以 `.part` 结尾，完成后原地重命名
- 命名规约：`/Android/data/com.watch.limusic/files/downloads/songs/{songId}.{ext}`
- 封面离线化：`downloads/covers/{albumId}.jpg`
- 扩展名：当前强制 mp3（若开启“下载强制转码”）；否则默认 mp3 兜底（后续可据 Content-Type 智能选择）
- 事件广播（`LocalBroadcastManager`）：
  - 进行中：`ACTION_DOWNLOAD_PROGRESS`，携带 `{songId, progress}`
  - 完成：`ACTION_DOWNLOAD_COMPLETE`，携带 `{songId}`
  - 失败：`ACTION_DOWNLOAD_FAILED`，携带 `{songId, errorMessage}`
  - 取消：`ACTION_DOWNLOAD_CANCELED`，携带 `{songId}`

## 网络层（含歌单接口）

- OkHttp 直连：`NavidromeApi`
  - `getPlaylists / getPlaylist / createPlaylist / updatePlaylist / deletePlaylist`
  - `updatePlaylist` 支持：重命名（name）、公开/私有（public）、增加歌曲（songIdToAdd）、按索引删除（songIndexToRemove）
- Retrofit 客户端：`NavidromeClient`（保留）

## 数据库（Room）

- 数据库：`MusicDatabase`（v3，`fallbackToDestructiveMigration`）
- 新增实体：
  - `PlaylistEntity`：允许重名；公开/私有；`serverId`、`songCount`、`changedAt`、`syncDirty`、软删除 `isDeleted`、`owner`
  - `PlaylistSongEntity`：主键 `(playlistLocalId, ordinal)`，允许同一 `songId` 多次添加；维护 `ordinal` 顺序
- 新增 DAO 能力：
  - `PlaylistDao`：头部 CRUD、软删除、对账同步（含孤儿清理）
  - `PlaylistSongDao`：
    - `insertAtTailKeepingOrder`：按尾部追加并保持选择顺序
    - `reorder`：三步安全位移（高位暂存 + 目标写入 + 回落平移）避免唯一冲突
    - `deleteByOrdinals`：按序号批量删除

## 运行时通信

- Activity ↔ Service：绑定 `PlayerService`
- UI 更新：本地广播推送播放与下载状态；
  - 播放状态：`ACTION_PLAYBACK_STATE_CHANGED { pos,dur,buf,isSeekable,isDurationUnset,audioType,songId }`
  - 歌单：`PLAYLISTS_UPDATED` / `PLAYLIST_CHANGED`
  - UI 设置：`UI_SETTINGS_CHANGED { what=audio_badge }`
- 歌单同步：
  - 列表头部：拉取服务端列表 → 对齐/软删 → 清理本地孤儿 → 展示
  - 明细：必要时拉取 `getPlaylist`，先回填 `songs`/专辑占位，再写入明细，最后更新统计

## UI 交互（新增歌单/多选/刷新）

- 长按进入选择模式：标题“已选择 n 首”；所有列表保持一致规则
- 歌单详情：选择模式下显示拖动柄（36dp），下载区域隐藏；拖拽仅视觉移动，松手提交快照并后台写库
- 批量删除：本地删除 + `updatePlaylist(songIndexToRemove)` 同步服务端
- 下拉刷新：顶层列表可刷新；选择模式下禁用刷新，退出后恢复
- 同步状态：歌单详情标题下方显示“同步中/已同步/失败可重试”

## 设置项总览

- 服务器设置、解码兼容模式（启用后强制服务器端转码为 MP3@320）、下载管理、缓存设置、自动恢复播放器状态
- 播放器设置：显示音频类型（全屏标题旁徽标）

## 权限与声明（Manifest）

- 网络、前台服务、音频设置、存储权限；声明手表设备特性；允许明文流量（开发/局域网）

## 已知问题与排障

- 个别设备硬件 FLAC 解码器（如 `OMX.qti.audio.decoder.flac`）可能报错：
  - 已启用扩展解码器与失败回退；仍失败则自动回退 `mp3@320` 并继续播放
  - 可通过“解码兼容模式”强制所有曲目走服务器端转码
- 某些服务端实时转码流不可 Seek：
  - 表现为 `dur=TIME_UNSET/isSeekable=false`，此时 UI 禁止拖动，仅允许正常播放；必要时可考虑后续“伪 Seek（timeOffset）”增强
- `MediaButtonReceiver` 警告：部分设备/上下文可能无法找到唯一接收者，属预期警告，不影响播放
- 下载文件扩展名：当前默认 mp3；未来将基于 Content-Type 智能确定
- 数据库允许主线程：仅为开发权衡，若出现 UI 卡顿，需将重操作移至后台

## 如何使用

1. 在设置页配置 Navidrome 服务器地址、端口与登录凭据
2. 浏览专辑或搜索音乐，进入专辑后点击歌曲播放
3. 可在歌曲项中发起下载；离线时进入“已下载”播放
4. 在设置-下载/缓存中管理空间；在设置-解码兼容模式中切换服务端转码策略

---

## 最近优化（概览）

- 播放器：优化缓冲策略（快速起播 + 更强重缓冲门槛 + 更大持续缓冲），启用扩展解码器与失败回退
- 列表：骨架屏、懒加载与视图缓存池，降低滑动抖动与首屏时间
- 缓存：离线文件直读，避免二次写缓存；提供缓存清理
- 下载：进度/暂停/继续/取消广播完善；封面离线化
- 稳定性：网络切换/离线模式/数据库同步逻辑增强


## 更新日志

### v1.9993 (2025-06-28)
- 修复进度条显示问题，确保进度条始终可见
- 优化拖动进度条时的显示效果，避免布局跳动
- 改进歌曲标题滚动效果，支持无限循环滚动
- 添加文本淡入淡出边缘效果，提升视觉体验
- 完成两阶段内存优化，显著降低内存占用
- 提升列表滚动性能和专辑加载速度
- 优化播放器缓冲策略，提高播放稳定性
- 改进缓存管理，减少磁盘空间占用
### v1.9994 (2025-07-11)（该版本实际未发布，所有更新内容合并到2.0）
- 统一网络请求客户端标识为"LiMusic"，解决服务器端显示多个客户端的问题
- 为所有HTTP请求添加统一User-Agent头，改善服务器端识别
- 重构网络请求拦截器，提高代码可维护性
- 修复MusicRepository中API调用参数不匹配问题
- 添加离线数据库支持，实现断网时查看歌曲和专辑
- 实现歌曲缓存状态检测与显示，区分已缓存和未缓存歌曲
- 优化网络状态检测，自动切换在线/离线模式
- 采用Repository设计模式，改善数据获取流程
- 改进UI视觉反馈，使已缓存和未缓存歌曲清晰区分
- 提高数据加载可靠性，减少网络异常导致的应用崩溃
- 修复进度条在专辑页面不显示的问题
- 优化缓存状态显示逻辑，在线模式下不显示缓存状态颜色区分
- 修复断网时无法切换到"所有歌曲"页面的问题
- 修复专辑点击无反应的问题
- 确保播放进度条在所有页面切换中保持可见
- 改进离线数据库加载逻辑，提高应用稳定性
- 优化UI状态管理，减少页面切换时的视觉闪烁
- 增加歌曲下载功能
- 修复离线模式下已缓存歌曲显示为灰色的问题
- 优化缓存状态检测逻辑，确保准确识别已缓存歌曲
- 增强离线模式下的播放体验，仅允许播放已下载的歌曲
- 改进播放列表过滤机制，离线模式下自动过滤未下载歌曲
- 优化数据库与缓存系统的同步，确保缓存状态实时更新
- 修复SongEntity结构，添加streamUrl字段以支持离线播放
- 提高应用在网络切换场景下的稳定性
### v2.0.0 （2025-08-14 00:40）
- 添加专辑封面缓存优化
- 支持显示下载进度
- 支持离线显示封面
- 修复离线后无法播放已下载音乐的问题
- 支持.flac格式解码
- 新修复（09:58）：修复取消下载之后UI不更新的问题
- 新修复（12:18）：修复现有模型 Album.genres 被定义为 List<String>，Gson 默认按字符串解析，遇到对象就抛出该异常，导致“加载专辑失败/加载更多失败”的问题
- 新修复（15:11）：修复缓存不命中的问题、修复弱网环境下播放异常卡顿的问题、优化启播体验，大幅降低启播时长
- 新修复（15:58）：修复播放本地音乐时仍然将本地音乐文件重复写入缓存的问题
### v2.0.1 （2025-08-14）
- 再次优化因服务端有时返回数组里是对象而不是字符串导致的专辑解析异常
- 提升专辑加载速度，减少首屏加载等待时间
- 增加骨架屏，进一步缩短用户对专辑加载时间的主观感受，提升操作流畅度
### v2.1（2025-08-15）
- 改进专辑图片加载逻辑，提升在线专辑图片加载速度
- 改进专辑页面返回逻辑，增加专辑详情页面的返回键用于返回上一级菜单
- 改进使用系统返回键退出软件时的软件退出逻辑
- 为系统返回键退出软件进行防误触处理，需二次确认才能退出软件
- 在专辑详情页面为长专辑标题设计了标题滚动，以此来能完整显示长专辑标题
- 新增自动保存播放列表/索引、歌曲信息（标题/艺术家/封面/专辑）、播放模式与进度的功能；下次打开软件时自动还原离开软件时的播放器状态，点击播放即可无缝续听。启动时默认暂停，防止误触。
- 设置页新增卡片“解码兼容模式”，针对一些设备在服务端源文件为flac等格式音频无法解码播放时，可尝试开启此选项，开启后可以强制在服务端将音频转码为320kbpsMP3，以最大化保证兼容性。
- 增强离线歌曲识别逻辑
- 增强与服务端格式不一致的歌曲的显示与处理逻辑
### v2.2（2025-8-16）
- 优化“所有歌曲”加载与滚动，字母索引跳转更快更准
- 修复跳转后只显示序号、删除下载后状态不刷新的问题
### v2.3Beta（2025-8-17）
- 新增歌单功能
- 新增在任意界面长按多选歌曲添加到歌单
- 新增歌单编辑功能（长按对应歌单重命名/删除/改变可见范围）
- 新增歌单与服务器同步功能、
- 新增离线状态歌单支持
- 新增歌单内拖动排序功能（目前功能不完善）
- 新增歌单内音乐管理功能（长按批量删除歌单内音乐）
### v2.3Beta2（2025-8-18）
- 修复：歌单详情使用系统返回可正确回到歌单列表
- 修复：任意歌曲列表进入多选后按系统返回优先退出多选，而非直接退出应用
- 优化：歌单拖动体验与稳定性（跨多行拖动、让位不抖动、长距离拖动不断开）
- 优化歌单详情歌曲顺序排序策略：本地排序优先；服务端新增歌曲按返回顺序追加至末尾；服务端删除同步本地移除；不采用服务端排序覆盖
- 稳健：删除按真实 ordinal 处理避免空洞误删；尾部追加以 maxOrdinal+1 作为基准避免主键冲突
### v2.3Beta3（2025-8-19）
- 性能与体验
  - Glide 全局降耗（RGB_565、禁动画、禁硬件位图）；统一专辑/歌单/歌曲封面尺寸（40dp/36dp）；播放器封面保持 150dp。
  - 占位图改为轻量 shape；专辑/歌单卡片去除 elevation；移除 RecyclerView 旧绘图缓存设置。
  - 延迟绑定/初始化播放服务：首次点播放或点歌时再绑定；绑定后自动设置待播列表并播放；未绑定时首屏恢复播放器 UI（含时间文本）。
  - OkHttp 日志级别默认调为 BASIC，降低在线场景 CPU/I/O。
- 首屏记忆
  - 记忆上次退出时的板块（专辑/所有歌曲/歌单/专辑内歌曲/歌单详情）与滚动位置，重进软件直接恢复。
- 歌单
  - 删除同步精准化：先获取服务端歌单详情，再按 songId 映射 `songIndexToRemove` 同步删除，避免误删和“又回来”。
  - 拖拽排序稳定：index→ordinal 映射写库；抑制窗口 700ms→1500ms，减少抖动。
  - 统一入口：移除旧 `PlaylistDetailActivity`，由 `MainActivity` 通过 `open_playlist_local_id` 打开内嵌详情，导航行为一致。
- Bug 修复
  - 修复未绑定时进度与时间不显示的问题；修复 `SongAdapter` 类结束花括号导致的编译失败。
### v2.3（2025-8-20）
- 修复蓝牙耳机控制播放无法切换上一曲的问题
- 修复专辑首屏无法加载的问题  
### v2.3.1(2025-8-20)
- 修复部分场景下返回前台/旋转后播放器进度条与时长及其他UI显示异常的问题
- 进一步避免“所有歌曲”历史残留与抽样差导致的错配所导致的列表显示异常
- 优化了专辑封面命中旧的错误 URL 或旧磁盘缓存，错误显示为 Navidrome 默认图的问题
### v2.4(2025-8-25)
- 优化了服务器切换及单次服务器测试的体验
- 解决了“所有歌曲”重出现重复数据的问题
- 优化了歌单功能的使用体验
### v3.0（2025-8-29）
- “Limusic”正式更名为“轻柠音乐”！并修改了更好看的应用图标！
- 修复了低性能设备切歌后进度条异常问题
- 增强了“所有歌曲”页面在滑动时的列表显示稳定性
- 修改了部分UI颜色
- 在设置中新增“省电模式”，开启后会限制部分列表更新频率、全屏播放器暂停显示歌曲封面背景
- 在设置中添加了可调节的“播放进度刷新速率”
- 优化了低性能设备的列表加载速度
- 新增全屏播放器，点击应用下方小播放器非控件区域即可唤出（左右滑动切页、顶部设置有页面指示器）
- 优化设置卡片显示，页面更整洁清爽
- 新增设置项：背景模糊开关
- 新增设置项：背景模糊强度调整
- 新增“随机播放”模式，且随机范围不受列表长度限制
- 修复了歌单详情页面使用系统返回无法返回歌单列表的问题
- 修复了专辑详情页面返回后始终回到专辑列表顶部的问题
- 增加了滚动歌词功能：正在播放的歌词放大高亮、点击任意行可跳转进度、无时间戳时纯文本显示
- 设置增强：歌词字号（当前/其他行）自定义；歌词平滑过渡开关（实验，默认关闭）；自定义歌词源（URL 模板）
- 全屏播放器底部中间新增音量按钮，点击呼出全屏音量遮罩，点击空白处可关闭
- 进度条时长不再出现拖动后回到开头的情况
### v3.1（2025-8-30）
- 新增“睡眠定时”功能
### v3.2（2025-9-6）
- “设置”-“播放器设置”新增“显示音频类型”选项，打开后可在全屏播放器页面标题栏旁显示当前播放的音频类型
- 对于部分需要在线转码的歌曲，新增进度条拖动保护，防止在无法seek的情况下直接跳到歌曲开头位置 
- 为全屏播放器标题添加了长标题滚动效果
- 在不开启“解码兼容模式”的情况下新增了解码异常回退，默认回退MP3 320kbps码率以保证当前音乐可以播放
- 修复了随机播放顺序重复的问题
- 提高了随机播放的随机覆盖范围
- 修复了在歌单列表列表循环播放时播放顺序混乱的问题
- “设置”-“播放器设置”新增“点击播放后自动打开全屏播放器”开关，开启后点击任意歌曲即可自动打开全屏播放器播放
- 为当前正在播放的歌曲添加了正在播放指示
- 添加了快速定位到当前正在播放的歌曲按钮
- 优化了歌词滚动效果，使平滑模式下滚动更自然
### v3.3（2025-9-7）
- 修复了部分情况下启动应用后闪退的问题
