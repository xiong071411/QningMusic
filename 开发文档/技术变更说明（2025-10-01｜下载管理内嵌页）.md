## 2025-10-01｜下载管理内嵌页
(TechChangeSpec_2025-10-01-Downloads-Embedded)

### 方案总览与实现要点
- 在抽屉导航新增“下载管理”入口，`MainActivity` 内以内嵌页形式展示；使用 `ConcatAdapter` 组合“分区头(正在下载/已下载)+列表”。
- 顶部工具栏提供“暂停全部/继续全部/取消全部”；“已下载”分区复用歌曲项样式（不显示下载控件），点击可播放本地文件。
- 下载管理新增多选：仅作用于“已下载”分区，长按进入；Toolbar 使用 `menu_downloads_selection` 提供批量删除/添加到歌单。

### 问题回溯与根因分析
- 旧实现进入“下载管理”另起 Activity，手表小屏不便捷；缺少统一任务列表与批量控制。
- 已下载长按直接删除与多选冲突；播放“已下载”列表时索引映射错误导致空列表。

### 受影响文件与关键点
- `app/src/main/res/menu/nav_menu.xml`：新增 `nav_downloads`。
- `app/src/main/java/com/watch/limusic/MainActivity.java`：
  - 视图 `currentView="downloads"`、`openDownloadsEmbedded()/rebuildDownloadsConcat()/refreshDownloadsData()`。
  - `onCreateOptionsMenu/onOptionsItemSelected`：在 `downloads` 下装载 `menu_downloads` 或 `menu_downloads_selection`，处理批量操作与删除所选。
  - 注册本地广播接收器 `downloadsUiReceiver`，合并刷新。
- 新增/修改适配器与布局：`SectionHeaderAdapter`、`DownloadTaskAdapter`、`DownloadedSongAdapter`、`res/layout/item_download_task.xml`、`res/menu/menu_downloads*.xml`。
- 颜色：`download_progress_running/#2ECC71`、`download_progress_paused/#F5A623`。

### 版本信息与变更摘要
- 版本：v4.0Beta4（2025-10-01，下载管理内嵌页）
- 摘要：内嵌页展示下载管理；提供批量控制；“已下载”支持多选与批量删除/添加；修复播放列表索引映射问题。

### 验收用例与验收标准（手表优先）
- 进入“下载管理”：两栏默认展开；进行中任务进度与大小显示正确；失败隐藏进度条。
- 工具栏批量操作：暂停/继续/取消全部生效；广播到达后列表刷新。
- “已下载”点击可播放；长按进入多选，批量删除/添加生效。

### 性能与功耗评估
- 复用同一 `RecyclerView` 与禁用动画；刷新整段合并；细进度条 1dp 减少绘制成本；后台线程处理数据。

### 风险与回滚
- 风险：`MainActivity` 体量大、交互耦合度提升。
- 回滚：恢复为 `startActivity(DownloadSettingsActivity)`，移除 `downloads` 分支与广播注册；保留设置页功能。

### 回归测试要点
- 抽屉切换与返回键行为稳定；折叠/展开区头状态持久；弱网/离线时状态与播放行为正确。

### 本次补充修改（2025-10-01 二次迭代）
- 新增“多选模式”在“已下载”分区；修复播放空列表；移除“已下载”行右侧图标；为区头添加折叠箭头文案；兼容原“正在下载”长按取消操作。 