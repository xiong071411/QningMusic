# 项目结构与功能清单（2025-10-03）

更新时间：2025-10-03  
适用版本：v4.0（手表版）

---

## app/src/main 目录结构（更新点标注）
- `AndroidManifest.xml`
  - 新增：注册 `ListenReportSettingsActivity`（听歌记录服务器设置）
  - 保持：`PlayerService` 前台媒体播放服务、`usesCleartextTraffic` 开启（兼容内网/明文调试）
  - 手表特性：`uses-feature android.hardware.type.watch`

- `java/com/watch/limusic/`
  - `adapter/`
    - `AlbumAdapter.java`：专辑网格/列表适配器
    - `AllSongsRangeAdapter.java`：所有歌曲“范围分页”适配器（懒加载、占位行、选择模式、字母预取）
    - `DownloadedSongAdapter.java`：已下载歌曲适配器（离线列表）
    - `SectionHeaderAdapter.java`：分区/字母分节头部
    - `PlaylistAdapter.java`：歌单列表适配器
    - `PlaylistPickerAdapter.java`：添加到歌单时的选择器
    - `SongAdapter.java`：歌曲列表适配器（选择模式、稳定ID、拖动柄、顺序快照）
    - `LyricsAdapter.java`：歌词行渲染（平滑缩放、左枢轴、跑马灯延迟一帧）
    - `ArtistAdapter.java` / `GenresAdapter.java` / `DiscTitlesAdapter.java`：艺术家/流派/碟片标题适配器
    - `HintFooterAdapter.java` / `SearchFooterAdapter.java`：底部提示/“正在搜索”页脚

  - `api/`
    - `CustomLyricsApi.java`：自定义歌词源 URL 模板请求
    - `NavidromeApi.java` / `NavidromeClient.java` / `NavidromeService.java` / `NavidromeResponse.java` / `SubsonicResponse.java`：Subsonic/Navidrome API
    - `ListenReporter.java`（新增）：轻量听歌上报器（Basic 认证，POST `/api/listens`，失败网络/5xx 重试一次；支持仅测试用“忽略主机名校验”）

  - `audio/`（新增分组）
    - `AudioTapProcessor.java`：低功耗 PCM 抽头与频段分析（Goertzel，双时间常数 + 峰值保持 + 门限滞回；FPS 可控）
    - `AudioLevelBus.java`：音量条总线（初始化、FPS 上限、发布 `bars` 与播放状态）

  - `cache/`
    - `CacheManager.java`：ExoPlayer 磁盘缓存（线程安全单例、LRU 驱逐）
    - `SmartDataSourceFactory.java`：智能数据源（本地直读 / 在线带缓存）

  - `database/`
    - `MusicDatabase.java` / `DatabaseConverters.java`
    - `SongDao.java` / `SongEntity.java`
    - `AlbumDao.java` / `AlbumEntity.java`
    - `PlaylistDao.java` / `PlaylistEntity.java` / `PlaylistSongDao.java` / `PlaylistSongEntity.java`
    - `DownloadDao.java` / `DownloadEntity.java` / `DownloadRepository.java`
    - `CacheDetector.java` / `LocalFileDetector.java`
    - `InitialCount.java` / `EntityConverter.java`
    - `ArtistCount.java`：艺术家计数统计项

  - `download/`
    - `DownloadManager.java`：下载队列与线程池（进度/完成/失败/取消 LocalBroadcast）
    - `DownloadSystemValidator.java`：下载系统环境校验

  - `migration/`
    - `DownloadSystemMigration.java`：下载系统迁移

  - `model/`
    - `Song.java` / `SongWithIndex.java` / `Album.java` / `DownloadInfo.java` / `DownloadStatus.java` / `ArtistItem.java`

  - `repository/`
    - `LyricsRepository.java`：歌词源优先级与缓存
    - `PlaylistRepository.java`：歌单业务封装（CRUD、同步、排序与删除）

  - `service/`
    - `PlayerService.java`：播放服务（ExoPlayer、媒体会话、全局滑动窗口、解码回退、睡眠定时；初始化 `AudioLevelBus`；触发 `ListenReporter.reportAsync(currentSong)`）

  - Activity / UI
    - `MainActivity.java`：主界面/导航与列表、全屏播放器/歌词页/刷新与广播接收；右下角“定位当前曲目”悬浮按钮
    - `SettingsActivity.java` / `SettingsGeneralActivity.java` / `SettingsPlayerActivity.java` / `GeneralSettingsActivity.java` / `PlayerSettingsActivity.java`
    - `NavidromeSettingsActivity.java`：服务器/账号设置与连接测试
    - `CacheSettingsActivity.java` / `DownloadSettingsActivity.java`
    - `ListenReportSettingsActivity.java`（新增）：听歌记录服务器设置（开关、服务器、用户名/密码、连接测试、可选“不安全HTTPS”）
    - `ui/PlaylistListActivity.java`：歌单列表页

  - `LyricsController.java`：歌词页控制（懒加载、取词与解析、精准居中、调度/心跳；绑定 `AudioBarsVisualizerView`）

  - `util/`
    - `BlurUtils.java` / `LyricsParser.java` / `NetworkUtils.java` / `PinyinUtil.java` / `SwipeGestureListener.java`

  - `view/`
    - `AudioBarsVisualizerView.java`（新增）：轻量柱状音频可视化视图（外部 `levels` 驱动优先；回退 Visualizer；低功耗模式降帧）
    - `LetterIndexDialog.java` / `SeamlessMarqueeTextView.java`

- `res/`
  - `layout/`
    - `activity_main.xml`：主界面（定位按钮 `@id/btn_locate_current`；底部播放器；下拉刷新与骨架/空态/错误占位）
    - `layout_lyrics_page.xml`：歌词页（新增 `AudioBarsVisualizerView @id/audio_bars_visualizer`）
    - `activity_listen_report_settings.xml`（新增）：听歌记录服务器设置页
    - 其他：下载/设置/歌单/专辑项等布局一并保留

  - `menu/`
    - `menu_downloads.xml` / `menu_downloads_selection.xml`：下载页菜单（操作、选择、多选）
    - `menu_songs.xml` / `menu_playlist_list.xml` / `menu_playlist_detail_selection.xml` / `nav_menu.xml` / `drawer_menu.xml`

  - `drawable/`
    - 样式：`player_background.xml`、`progress_bar_rounded.xml`、`item_background*.xml` 等
    - 图标：`ic_locate.xml`、`ic_task_alt_checked.xml`、`ic_task_alt_unchecked.xml`、`ic_multi_select.xml`、播放控制与系统图标等

  - `values/`
    - `colors.xml` / `strings.xml` / `dimens.xml` / `styles.xml` / `themes.xml` / `ids.xml`

  - `xml/`
    - `backup_rules.xml` / `data_extraction_rules.xml`

---

## 开发文档 目录结构（新增/更新）
- `总体项目说明.md`
- `项目结构与功能清单（2025-09-07）.md`
- 本文件：`项目结构与功能清单（2025-10-03）.md`
- 技术变更说明（节选，按日期）：
  - 2025-09-27 ～ 2025-10-03：随机自动切歌修复、可视化卡死修复、下载管理增强、排序持久化、字母检索优化、听歌记录前端接入、设置界面开关与长文案布局等
  - 2025-09-06 ～ 2025-09-14：定位按钮、精准居中、歌词可视化与权限变更、Seek 防误跳、FLAC 优先等
  - 更早变更详见各日期文件

---

## 功能清单（更新补充）
- 播放器与服务
  - ExoPlayer 解码与媒体会话；FLAC→MP3 回退；快速起播与缓冲策略
  - 后台/前台服务、耳机与蓝牙媒体键；首屏记忆与恢复（默认暂停防误触）
  - 全局“所有歌曲”滑动窗口播放（边播边扩）

- 列表/浏览
  - 专辑/歌曲/歌单/艺术家 列表与详情（骨架屏、懒加载、统一封面尺寸）
  - 所有歌曲：范围分页、字母索引跳转、占位行、选择模式
  - 行内“正在播放指示器”与“定位当前曲目”悬浮按钮

- 歌词与音频可视化（新增细化）
  - 歌词平滑模式：左枢轴轻缩放（0.96→1.0）替代字号动画；跑马灯延后一帧
  - 可视化：`AudioTapProcessor` + `AudioLevelBus` + `AudioBarsVisualizerView`
    - 低功耗：默认 16 柱、约 30FPS；省电模式降帧
    - 数据优先级：外部 levels 驱动 > Visualizer 绑定 > 拟真模式

- 下载与离线
  - 下载任务（进度/暂停/继续/取消 LocalBroadcast）、封面离线化；离线模式 `file://` 直读不写缓存

- 听歌记录上报（新增）
  - 开关与配置：`ListenReportSettingsActivity`（服务器/用户名/密码、连接测试、可选不安全HTTPS）
  - 上报策略：`PlayerService` 播放曲目时异步 `POST /api/listens`（Basic 认证；网络异常/5xx 重试一次；超时短、失败不打断播放）

- 缓存/图片
  - ExoPlayer 磁盘缓存（LRU 驱逐），`CacheManager` 并发安全增强；Glide RGB_565、禁动画/硬件位图

---

## 关键交互与算法说明（简版）
- “定位当前曲目”
  1) 从当前适配器 `getPositionBySongId` 获取位置；未加载则调用 `SongDao.getGlobalIndex` 粗定位并预取
  2) 两阶段 `scrollToPositionWithOffset` 同步居中（估高→实高二次校正），多次延迟复查直到严格居中

- 歌词平滑模式
  - 立即设置目标字号/内边距，再做 `scaleX/scaleY` 轻缩放，枢轴固定左边缘；跑马灯延后一帧避免动效叠加

- 音频可视化（手表优先）
  - 抽头帧长 512、门限滞回与峰值保持、双时间常数（attack/release）
  - 频段 50–6kHz 自适应对数分布，低频抑制与 80–160Hz 轻权重
  - 发布节流：由 `AudioLevelBus` 控制最大 FPS，UI 与处理协同省电

- 听歌记录上报
  - 触发：曲目开始播放后在服务侧异步构造 JSON（title/artist/album/source/started_at/duration_sec/external_id）并上报
  - 时长：优先从本地 DB 读取秒级时长，缺失时按 `Song.getDuration()` 猜测并限制上限（24h）

---

## 性能与功耗（手表端）
- 两阶段同步居中替代 SmoothScroller，显著降低长距离滚动卡顿
- 可视化：柱数/帧率/分析范围受控，外部驱动优先减少 Visualizer 初始化与功耗
- 网络：听歌上报使用短超时与单线程执行器，失败不重试多次、不中断播放

---

## 稳定性与异常处理
- 缓存并发安全：`CacheManager` 使用线程安全单例，避免 SimpleCache 多实例崩溃
- 听歌上报：网络异常或 5xx 重试一次；可选“忽略主机名校验”仅供测试，默认关闭
- 可视化：Visualizer 初始化异常自动回退拟真模式；仅在“可见 + 设置开启 + 播放中”渲染

---

## 验收要点（简明清单）
- 可视化：开启设置后，播放中在歌词页背景看到 16 柱随音乐变化；暂停后缓慢衰减至静止
- 听歌上报：设置页保存服务器与凭据后，播放新曲目应上报成功（服务器可见到记录）
- 定位当前曲目：目标未加载时仍可见按钮；点击后 0.2–0.3s 内纠正至严格居中
- 歌词平滑模式：长句左缘对齐，无“逐字放大”错觉，跑马灯与缩放不互扰

---

## 风险与回滚
- 站点兼容性：`/api/listens` 接口差异可能导致上报失败；可通过设置页关闭上报快速回退
- HTTPS 配置：测试环境主机名不匹配可临时启用“不安全HTTPS”，生产请关闭
- 功耗：若手表发热或续航下降，可在播放器设置降低 FPS 或关闭可视化


