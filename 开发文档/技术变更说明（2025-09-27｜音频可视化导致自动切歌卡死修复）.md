## 2025-09-27｜音频可视化导致自动切歌卡死修复
(TechChangeSpec_2025-09-27-Visualizer-Drain-Fix)

### 背景与目标
- 背景：在 2025-09-14 引入“歌词页音频可视化（PCM 抽头 + 频段）”后，出现“自动切到下一首后显示已播放但无声音、进度条不动；或一首歌播放完不自动切到下一首”的问题。控制台同时持续出现 `DefaultAudioSink` 的 `Spurious audio timestamp (system clock mismatch)` 警告。
- 目标：修复自动切歌卡死/无声问题，恢复稳定连续播放；在不牺牲手表端性能的前提下尽量维持可视化功能；关闭可视化时不影响音频播放。

---

### 问题回溯与根因分析
1) 自动切歌边界卡死（主要症状）
- 现象：通常发生在“上一首结束→下一首开始”的边界（自动切歌），手动切歌大多正常；所有格式均可复现。
- 日志：连续刷 `Spurious audio timestamp (system clock mismatch): ...`。

2) 根因：自定义 `AudioProcessor` 未正确出清输出缓冲
- 处理器：`audio/AudioTapProcessor.java` 实现了 `AudioProcessor`，在 `getOutput()` 返回 `outputBuffer` 后没有将其重置为 `EMPTY_BUFFER`。
- 结果：在 `queueEndOfStream()` 之后，`isEnded()` 条件为 `inputEnded && outputBuffer == EMPTY_BUFFER` 始终不成立，导致音频渲染器无法完成 drain，管线停滞，出现无声/进度不动且时间戳不匹配的持续告警。
- 佐证：关闭/隔离可视化后问题消失；当前版本“无条件注入处理器”，即使设置里关闭可视化也会影响音频管线。

3) 次要因素（不作为本次根因）
- 在 `PlayerService` 中重建 `DefaultAudioSink.Builder()` 未充分复用默认 `AudioSink` 的配置，可能放大个别机型上的时间戳告警概率，但并非卡死主因。

---

### 方案总览与实现要点
A. 修复 `AudioProcessor` 输出语义（必做）
- 修改 `AudioTapProcessor.getOutput()`：在返回缓存前将内部 `outputBuffer` 置为 `EMPTY_BUFFER`，保证在 `queueEndOfStream()` 之后缓冲读尽即可满足 `isEnded()`，播放器可顺利完成 drain 并进入下一首。

B. 保持兼容与性能（本次不改动配置链）
- 维持现有 PCM 抽头与频段计算实现（FRAME_SIZE=512、默认 16 段、EMA 平滑与 Hann 窗等），不额外引入 CPU 负担。

C. 后续可选增强（未纳入本次变更）
- 注入开关化：设置关闭可视化时，不注入处理器或使 `isActive()` 返回 false，确保完全不影响音频管线。
- 复用默认 `AudioSink` 配置：在自定义构建时复用默认 `AudioSink` 的能力配置，进一步减少时间戳告警概率。

---

### 受影响文件与关键点
- `app/src/main/java/com/watch/limusic/audio/AudioTapProcessor.java`
  - 变更：`getOutput()` 由“直接返回内部缓冲”改为“返回后清空为 `EMPTY_BUFFER`”。
  - 目的：确保 `isEnded()` 能在 `queueEndOfStream()` 后正确变为 `true`，让渲染器完成 drain。

---

### 验收用例与验收标准（手表优先）
1) 自动切歌连续播放
- 操作：正常播放，让一首歌自然结束进入下一首，重复多次。
- 预期：不再出现“显示播放中但无声音、进度不动”；连续多首均可正常自动切歌。

2) 手动切歌
- 操作：频繁手动切歌。
- 预期：声音正常、进度正常。

3) 日志与稳定性
- 操作：在上述场景中观察日志。
- 预期：不再持续刷 `Spurious audio timestamp`；偶发 1–2 条可接受。

4) 开启/关闭可视化
- 操作：设置中开启与关闭可视化后重复以上步骤。
- 预期：关闭可视化时播放完全不受影响；开启时连续播放正常。

---

### 性能与功耗评估
- 该修复仅变更缓冲出清语义，不增加分析计算量；PCM 抽头与频段分析仍按帧率节流（`AudioLevelBus`），在手表端 CPU 增幅可忽略。

---

### 风险与回滚
- 风险：无（逻辑仅限于缓冲出清）。
- 回滚：将 `getOutput()` 恢复为“仅返回内部缓冲且不置空”（不推荐）。

---

### 版本信息与变更摘要
- 版本：v4.0（2025-09-27，自动切歌卡死修复）
- 变更摘要：
  - 修复 `AudioTapProcessor` 输出缓冲未出清导致的 drain 无法完成问题，解决自动切歌卡死/无声与时间戳告警刷屏。
  - 预留后续增强方向：注入开关化与默认 `AudioSink` 配置复用，以进一步提升鲁棒性。 

---

### 可视化增强补充（保持16条 + 三种样式 + 风险控制）
- 频段与映射：将分析频率范围缩窄至 50–6 kHz，保持 16 条对数映射；去除超高频无意义波动，提升鼓点与人声区的可见性。
- 能量整形：引入 dB 域噪声门限（-60 dB）、<80 Hz 低架削（-6 dB）与 80–160 Hz 鼓点轻加权（+3 dB），轻度高频提升（渐进+8%）。
- 时域响应：新增双时间常数（attack 20 ms / release 220 ms）与 120 ms 峰值保持，鼓点“打一下就跳一下”，随后平滑回落。
- 帧率与节流：沿用 `AudioLevelBus` 的帧率上限（默认 30 FPS，可在设置调整，低功耗强制 15 FPS）。
- 三种样式（设置-播放器设置中可选）：
  - Minimal（极简直条、超低成本）
  - Capsule（胶囊柱 + 顶部高亮，默认推荐）
  - Ambient（轻柔外辉叠色，非高斯，低成本）
- 稳定性约束（关键）：
  - 不改变 `AudioProcessor` 的输出/结束语义，保持 `getOutput()` 返回后立刻置空 `outputBuffer`，`queueEndOfStream()` 后 `isEnded()` 可达，避免复发 drain 卡死。
  - 仍采用外部 PCM 抽头驱动，默认不强制绑定系统 `Visualizer`，规避设备兼容性导致的崩溃或高耗电。
  - 关闭可视化时仅由 UI 层隐藏并减少刷新；后续可进一步“开关化注入”，彻底做到关闭=零开销（预留）。

### 受影响文件与关键点（本次增强）
- `app/src/main/java/com/watch/limusic/audio/AudioTapProcessor.java`
  - 新增频段范围 50–6 kHz、dB 门限与低频/鼓点权重、双时间常数和平峰保持；保持 16 条输出；保留 drain 修复逻辑。
- `app/src/main/java/com/watch/limusic/view/AudioBarsVisualizerView.java`
  - 新增三种样式（Minimal/Capsule/Ambient），硬件加速 `Canvas` 绘制，`Shader/RectF` 等资源按尺寸变更复用，避免每帧分配。
- `app/src/main/java/com/watch/limusic/PlayerSettingsActivity.java`
  - 新增“可视化样式”选择项（极简/胶囊/环境光），持续保留透明度与帧率设置。
- `app/src/main/java/com/watch/limusic/LyricsController.java`
  - 读取 `visualizer_style` 并传递给 `AudioBarsVisualizerView`，仅在歌词页可见且开启时刷新。

---

### A方案实现（参数微调，强调稳定性）
- 频段与条数：保持 50–6 kHz 与 16 条不变。
- 低频抑制：<80 Hz 改为中等抑制 −4 dB；80–160 Hz 鼓点加权 +3 dB。
- 时域（弹性动效）：attack 20 ms / release 220 ms；峰值保持 70 ms，并加入“缓释”策略（约 70 ms 时间常数），避免持峰结束时瞬间跌落。
- 噪声门限：加入滞回门限，开门 −58 dB / 关门 −62 dB，减少微弱噪声引起的抖动。
- 风险控制：
  - 未改变 `getOutput()` 置空与 `isEnded()` 条件，drain 语义保持，自动切歌稳定性不受影响。
  - 仅数学层（能量整形与时间平滑）调整，不涉及渲染链路与可视化注入方式。

---

### A方案参数微调（低频与鼓点）
- 低频抑制：由 −4 dB 调整为 −6 dB，并采用分段抑制策略：<70 Hz 使用全量抑制（−6 dB），70–90 Hz 使用半量抑制（−3 dB），以进一步降低低频基线但不吞掉鼓点瞬态。
- 鼓点权重：由 +3 dB 调整为 +2 dB，避免在部分曲目中过度提升 80–160 Hz 导致低频条“常高”。
- 其他保持不变：attack 20 ms / release 220 ms；峰值保持 70 ms + 缓释 70 ms；门限滞回 −58/−62 dB；频段 50–6 kHz；条数 16；drain 语义保持。

---

### 验收补充
- 鼓点出现时低频条明显上冲，随后平滑回落；右侧“死条”消失。
- 16 条保持稳定；切歌与重缓冲阶段无无声/进度不动；日志不再持续刷 `Spurious audio timestamp`。
- 可视化关闭时播放稳定性完全不受影响，低功耗模式可见关闭或降帧。 