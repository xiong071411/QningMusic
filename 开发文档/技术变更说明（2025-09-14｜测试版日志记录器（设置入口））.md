## 2025-09-14｜测试版日志记录器（设置入口）
(TechChangeSpec_2025-09-14-Debug-Log-Recorder)

### 方案总览与实现要点
- 目标：在没有电脑连接的场景下也能便捷抓取运行日志，用于问题复现与排障。
- 设计：仅测试版（Debug）封装真实功能；正式版（Release）提供空实现并隐藏入口。
- 入口位置：设置 → 通用 → 卡片“测试日志记录（仅测试版）”。
- 功能点：
  - 开始记录：启动一个后台线程，通过 `logcat` 读取本应用进程日志，写入应用外部私有目录。
  - 停止记录：停止读取、关闭句柄，并将 `.tmp` 文件重命名为最终日志文件。
  - 文件命名：`log_yyyyMMdd_HHmmss.txt`，保存目录：`Android/data/com.watch.limusic/files/logs/`。
  - 兼容性：优先使用 `logcat --pid <pid> -v time`，不支持时回退 `logcat -v time`（通常只能读到本应用日志）。

---

### 问题回溯与根因分析
- 现场问题常出现在手表设备且无电脑环境，不便通过 `adb logcat` 抓取；应用内部缺乏一键抓取能力，定位成本高。

---

### 受影响文件与关键点
- 代码（新增）
  - `app/src/debug/java/com/watch/limusic/devtools/LogRecorder.java`
    - `start(Context)`：创建 `logs/` 目录、打开输出流，启动 `logcat` 进程并在后台线程持续读取写入。
    - `stop(Context)`：停止标志、销毁 `logcat` 进程、关闭输出流，将临时文件 `.tmp` 重命名为最终文件并返回路径。
    - `isRecording()`：返回录制状态。
  - `app/src/release/java/com/watch/limusic/devtools/LogRecorder.java`
    - 空实现（所有方法返回默认值），确保 Release 不包含真实逻辑。
- UI（修改）
  - `app/src/main/res/layout/activity_general_settings.xml`：新增“测试日志记录（仅测试版）”卡片，包含状态与“开始记录 / 停止并保存”按钮。
  - `app/src/main/java/com/watch/limusic/GeneralSettingsActivity.java`：
    - 绑定按钮点击逻辑，调用 `LogRecorder.start/stop`；
    - 使用 `BuildConfig.DEBUG` 在 Release 中隐藏该卡片；
    - 使用完全限定名调用 `devtools.LogRecorder`，避免导入冲突。

---

### 使用说明（测试版）
1) 打开设置 → 通用 → “测试日志记录（仅测试版）”。
2) 点击“开始记录”，复现问题；完成后点击“停止并保存”。
3) 日志文件保存路径：`/Android/data/com.watch.limusic/files/logs/log_yyyyMMdd_HHmmss.txt`。

---

### 验收用例与标准
- 开始/停止：
  - 首次点击“开始记录”→ 提示“开始记录日志”，状态显示“正在记录…”。
  - 再次点击“开始记录”→ 返回 false，不重复启动。
  - 点击“停止并保存”→ 提示“日志已保存：<路径>”，状态回到“未在记录”。
- 文件检查：
  - `logs/` 目录下生成 `.txt` 文件，内容包含最近操作产生的日志（时间戳、级别、Tag、消息）。
- Release 构建：
  - 通用页不显示该卡片；即使通过反射调用 `LogRecorder`，也只得到空实现。

---

### 性能与功耗
- 平时不启用时零开销；录制期间常驻一个后台线程与管道 IO，CPU/I/O 占用很低（取决于日志量）。

---

### 风险与回滚
- 个别设备对 `logcat --pid` 支持不一致：已做降级处理（全量读取但通常仅能读到本应用日志）。
- 日志可能包含敏感信息：文件仅保存在应用外部私有目录，建议手动清理；必要时可追加“清除日志”入口（未纳入本次）。
- 回滚方案：删除新增类与卡片布局，并移除通用页绑定逻辑。

---

### 版本信息与变更摘要
- 版本：v4.0（2025-09-14，测试版辅助工具）
- 变更摘要：
  - 新增测试版“测试日志记录”功能（设置 → 通用），支持一键抓取 `logcat` 日志到应用目录；
  - 正式版隐藏入口且不包含实现逻辑（空实现占位）。 