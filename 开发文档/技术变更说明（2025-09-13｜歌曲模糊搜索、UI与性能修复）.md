## 2025-09-13｜歌曲模糊搜索、UI与性能修复
(TechChangeSpec_2025-09-13-FuzzySearch-UI-Perf-Fixes)

### 背景与目标
- 背景：
  - 需要在导航抽屉中新增“歌曲模糊搜索”功能，作为“所有歌曲”字母索引的补充，支持按任意关键词在所有歌曲中进行匹配。
  - 为适应手表小屏，UI 方案确定为嵌入式页面（在 `MainActivity` 内切换），而非独立的 `Activity`，以最大化内容显示区域。
  - V1 初版实现后暴露出若干核心交互问题，包括多选模式下标题栏状态异常、搜索结果列表加载时错误地滚动到底部、空态提示不一致等，严重影响使用体验。
  - 后续迭代中又发现高亮状态跨页泄漏、搜索结果多时首次滚动卡顿、“添加到歌单”UI简陋且交互有遮挡、提示消息密集、搜索空态残留等一系列问题。
- 目标：
  - 实现一个稳定、流畅、交互正确的嵌入式模糊搜索页面，并对关联UI进行全面优化。
  - 彻底修复“退出多选后标题栏不恢复为搜索框”的严重问题。
  - 彻底修复“搜索结果加载后直接跳转到底部”的列表定位问题。
  - 统一并优化空态（初始空态、无结果空态、清空后空态、跨页残留）的视觉表现。
  - 优化搜索结果的首次滚动性能，消除大量结果时的卡顿感。
  - 升级“添加到歌单”UI为带自定义按钮的对话框，解决遮挡与显示不全问题。
  - 改进提示消息机制，避免多条消息密集叠加。
  - 隔离高亮状态，防止从搜索页泄漏至其他歌曲列表页。

---

### 问题回溯与根因分析
1) **搜索结果直接跳至列表底部**
- 现象：输入关键词开始搜索后，列表先短暂显示“我是有底线的”（Footer），随后结果加载完成，但视图被锚定在列表最底部。
- 根因：UI 列表由 `ConcatAdapter`（主列表 `SongAdapter` + 页脚 `SearchFooterAdapter`）构成。在首次加载（列表从空变为有）时，如果 Footer（页脚）先于主列表项参与 `RecyclerView` 的布局计算，或其状态（如 `NOMORE`）先于主列表数据提交，`RecyclerView` 可能会错误地将可见的 Footer 当作布局锚点，导致滚动到底部。

2) **退出多选模式后，标题栏不恢复为搜索框**
- 现象：在搜索页长按进入多选模式，标题栏变为“已选择 n 首”；此时无论通过左上角返回键还是系统返回键退出多选，标题栏都卡在这个状态，无法恢复为搜索输入框。
- 根因：`ActionBar` 的状态管理混乱。`enterRootNavigationMode()` 方法会强制清除 `CustomView` 并显示 `Title`，它在 `onBackPressed` 等返回路径中被误用，导致恢复的不是搜索框而是默认标题。同时，进入/退出多选时，未能为搜索页建立一个独立的、能维持自定义搜索框的导航模式，导致状态被错误覆盖。

3) **清空搜索关键词后，空态提示不正确**
- 现象：首次进入搜索页，提示“输入关键词开始搜索”，正常。但搜索有结果后再清空关键词，界面除“输入关键词开始搜索”外，还残留一个“我是有底线的”提示。
- 根因：清空输入框的逻辑仅处理了主列表的数据（置空）和空态提示的显示，但没有重置或隐藏 `SearchFooterAdapter` 的状态，导致其维持了上一次搜索结果的 `NOMORE` 状态。

4) **搜索结果首次滚动卡顿**
- 现象：搜索结果项过多时，首次向下滑动列表有明显卡顿。
- 根因：`SongAdapter` 的 `onBindViewHolder` 中，高亮逻辑（`applyHighlight`）每次都会执行 `toLowerCase` 创建新字符串，并创建新的 `SpannableString` 对象，在快速滚动时造成大量GC和计算开销。同时，`RecyclerView` 未针对搜索场景做性能优化配置。

5) **跨页面高亮状态泄漏**
- 现象：从“搜索”页切换到“歌单详情”、“专辑详情”等其他也使用 `SongAdapter` 的页面时，高亮状态被保留，导致艺术家名等文本仍然显示高亮色。
- 根因：`SongAdapter` 实例在不同视图间复用，其 `highlightKeyword` 成员变量未在视图切换时重置，导致状态泄漏。

6) **“添加到歌单”UI遮挡与交互不佳**
- 现象：在手表小屏上，“添加到歌单”的系统原生对话框列表被截断，且底部按钮被一个约40%屏高的空白区域完全遮挡，无法正常操作。
- 根因：系统 `AlertDialog` 对自定义视图的高度计算在某些设备上存在问题，导致内容区域过大，将按钮挤出屏幕外。原生按钮也无法满足“选中后才启用”的交互需求。

7) **提示消息密集叠加**
- 现象：“添加到歌单”后，多个反馈（如“跳过已存在”、“保存成功”）以独立的 `Toast` 快速连续弹出，信息难以阅读。
- 根因：回调中对不同事件（跳过、成功、同步状态）分别调用 `Toast.makeText`，系统默认行为是叠加显示。

8) **搜索空态残留**
- 现象：从“搜索”页（空态下）直接切换到“所有歌曲”等其他页面，搜索页的“输入关键词以开始搜索”提示会重叠显示在目标页面列表之上。
- 根因：视图切换时，仅处理了目标页面的加载，未主动隐藏上一个页面（搜索页）的 `emptyContainer`。

---

### 方案总览与实现要点
A. **滚动与UI状态修复**
- **滚动定位强序修复**：在 `startSearch()` 的异步回调中，严格保证操作顺序：`songAdapter.submitList` -> 在其完成回调中 `recyclerView.post(scrollToTop)` -> 最后更新 `SearchFooterAdapter` 状态。
- **标题栏恢复逻辑重构**：封装统一的 `applySearchToolbar()` 函数，并为搜索页建立隔离的 `enterSearchNavigationMode()` 导航模式，在所有返回路径中统一调用，确保状态正确恢复。
- **空态逻辑修复**：在清空搜索或切换到其他页面时，主动隐藏 `emptyContainer` 和 `SearchFooterAdapter`，避免残留。

B. **性能优化**
- **高亮零分配优化 (`SongAdapter`)**：
  - `applyHighlight` 内部增加小型 `LRU Cache` (LinkedHashMap)，缓存高亮处理过的 `CharSequence` 结果。
  - `indexOf` 替换为忽略大小写的 `regionMatches`，避免为匹配而创建 `toLowerCase` 新字符串。
  - `highlightColor` 缓存，避免重复调用 `getColor`。
- **搜索列表 (`RecyclerView`) 优化 (`MainActivity`)**：
  - 在 `loadSearchEmbedded` 时，为 `RecyclerView` 设置 `setHasFixedSize(true)`，禁用 `setItemAnimator(null)`，并适度增大回收池 `setMaxRecycledViews(0, 24)`，减少滚动中创建和销毁 `ViewHolder` 的开销。

C. **UI与交互改进**
- **“添加到歌单”自定义对话框**：
  - 布局 (`dialog_add_to_playlist.xml`)：`RecyclerView` 高度设为 `0dp` + `layout_weight=1`，下方新增一个包含“取消/新建/添加”的自定义按钮栏，彻底解决系统按钮被遮挡问题。
  - 逻辑 (`MainActivity`)：不再使用 `AlertDialog` 的原生按钮，而是 `findViewById` 找到自定义按钮并手动绑定点击事件。选中歌单项后才启用“添加”按钮。
- **统一提示队列**：
  - 在 `MainActivity` 中引入一个 `ArrayDeque<String>` 作为提示消息队列和 `showQueuedTip()` 方法。
  - 所有 `Toast` 调用改为向该队列添加消息。队列处理器确保一次只显示一条消息，在前一条消失后（通过 `postDelayed` 控制）再显示下一条，实现串行化提示。

D. **状态隔离**
- **高亮状态清理**：在所有加载非搜索视图的方法（如 `openPlaylistDetail`, `loadAlbumSongs`, `loadArtists` 等）以及通用的 `resetUiForNewView()` 方法中，显式调用 `songAdapter.setHighlightKeyword(null)`，确保状态隔离。

---

### 代码变更清单（核心摘录）
- **新增/修改文件**:
  - `app/src/main/java/com/watch/limusic/adapter/PlaylistPickerAdapter.java` (新增)
  - `app/src/main/res/layout/dialog_add_to_playlist.xml` (新增/修改)
  - `app/src/main/res/layout/item_playlist_pick.xml` (新增)
  - `app/src/main/java/com/watch/limusic/MainActivity.java` (重度修改)
  - `app/src/main/java/com/watch/limusic/adapter/SongAdapter.java` (修改)
- **新增/修改方法**:
  - `MainActivity.java`:
    - 新增 `private void showQueuedTip(String message)` 和消息队列机制。
    - 修改 `onOptionsItemSelected` 中 `action_add_to_playlist` 的逻辑，替换为自定义视图对话框。
    - 修改 `loadSearchEmbedded`，增加 `RecyclerView` 性能优化配置。
    - 在 `loadAllSongs`, `loadPlaylists` 等导航切换处增加隐藏 `emptyContainer` 的逻辑。
    - 在 `openPlaylistDetail`, `loadAlbumSongs`, `openArtistDetail`, `resetUiForNewView` 中增加 `songAdapter.setHighlightKeyword(null)` 调用。
  - `SongAdapter.java`:
    - 修改 `applyHighlight`，增加 `LRU Cache` 和零分配优化。
    - 修改 `setHighlightKeyword`，在关键字变化时清空缓存。

---

### 受影响文件与关键点
- `MainActivity.java`: 搜索、多选、导航、对话框和提示消息的核心逻辑所在地，本次修复的大部分工作集中于此。
- `SongAdapter.java`: 关键性能优化点，高亮逻辑被重写以减少滚动卡顿。
- `dialog_add_to_playlist.xml`: UI 关键修改，从简单列表演变为带自定义按钮栏的健壮布局。
- `PlaylistPickerAdapter.java`: 为新对话框提供数据支持的全新适配器。

---
### 版本信息与变更摘要
- 版本：v4.0（2025-09-13，模糊搜索与体验优化）
- 变更摘要：
  - 新增“歌曲模糊搜索”功能，采用嵌入式UI，支持按歌名/艺术家/专辑匹配。
  - 修复搜索页多项核心交互问题，包括结果滚动定位、多选标题恢复、空态残留等。
  - 优化搜索结果列表的首次滚动性能，消除大量结果时的卡顿。
  - 升级“添加到歌单”对话框为自定义UI，解决小屏遮挡与交互问题。
  - 改进全局提示消息机制为串行队列，避免信息叠加。

---

### 附录：接口与关键方法（摘要）
- Adapter:
  - `SongAdapter.applyHighlight()`: 零分配高亮优化（LRU缓存、regionMatches）。
  - `PlaylistPickerAdapter`: 新增，用于“添加到歌单”对话框的单选列表。
- MainActivity:
  - `loadSearchEmbedded()`: 初始化搜索视图及`RecyclerView`性能配置。
  - `showQueuedTip()`: 新增，用于串行化显示Toast提示。
  - `onOptionsItemSelected(action_add_to_playlist)`: 逻辑重构，使用自定义`AlertDialog`视图。 
  - 
### 验收用例与验收标准（手表优先）
1) **滚动与高亮**
- 搜索大量结果后，首次滚动列表应顺滑无卡顿。
- 从搜索页切换到歌单/专辑详情等页，不应再看到任何残留高亮。
2) **添加到歌单**
- 对话框下方不再有大面积空白，底部“取消/新建/添加”按钮始终可见。
- 未选中任何歌单时，“添加”按钮为禁用状态。
- 添加成功后的多个提示信息会依次弹出，不会重叠。
3) **空态显示**
- 从搜索页（空态）切换到“所有歌曲”等其他页面，列表上不再重叠显示“输入关键词开始搜索”。
- 首次进入搜索页，或搜索后清空关键词，界面仅居中显示“输入关键词开始搜索”，无其他多余提示。
4) **标题栏与多选**
- 在搜索页进入和退出多选模式，标题栏都能在“搜索框”和“已选择 n 首”之间正确切换。

---

### 性能与功耗评估
- 搜索滚动性能通过零分配优化得到显著提升，降低了CPU在滚动期间的负载。
- 自定义对话框和串行提示队列优化了UI响应和信息呈现，对功耗影响为正向。
- 整体对性能与功耗的影响为正向优化，符合手表设备约束。

---

### 风险与回滚
- 主要风险在于对 `MainActivity` 状态管理和 `AlertDialog` 的深度定制，但通过将UI与逻辑解耦（自定义按钮栏、独立适配器），风险可控。
- 回滚策略：可直接回退 `MainActivity.java`, `SongAdapter.java` 及新增的布局和适配器文件至上一版本。本次修改与其他模块耦合度低，回滚风险可控。 