## 2025-8-20｜专辑首屏修复、蓝牙线控修复

### 背景与目标
- **背景**：在落地“首屏记忆”与“延迟绑定播放服务”的一系列优化后，用户反馈两类高优先级问题：
  - 冷启动时若记忆的是“专辑列表”，恢复后出现标题为“专辑”但列表空白，必须从抽屉再次进入“专辑”才显示；若记忆的是“专辑详情”，恢复正常，但点击左上角返回后“专辑列表”空白。
  - 使用蓝牙耳机线控切歌时，“上一首”会再次播放当前歌曲（没有真正切到上一首）。
- **目标**：
  - 修复“专辑列表”在冷启动恢复、以及从“专辑详情”返回时的空白问题，确保无需额外导航即可正常显示。
  - 修复蓝牙耳机“上一首”行为，使其严格切至上一首歌曲。

---

### 问题回溯与根因分析
#### 1) 专辑首屏/返回空白
- **现象**：
  - 冷启动记忆为“专辑列表”时，标题栏显示“专辑”，但列表不渲染，需从抽屉菜单重新进入才显示。
  - 记忆为“专辑详情”时恢复正常，但点击左上角返回后“专辑列表”空白。
- **日志证据**：
  - 日志中多次出现 RecyclerView 警告：
```text
No adapter attached; skipping layout
```
- **根因**：
  - 在恢复路径中调用 `resetUiForNewView()` 清理了 UI 状态（包含清空适配器），而 `loadAlbums()` 内部在某些时序下未及时重新附着 `albumAdapter`，导致布局阶段没有适配器。
  - `loadAlbums()` 顶部有 `if (isLoading) return;` 的早退保护。在某些异常或恢复分支里 `isLoading` 残留为 `true`，使本次加载被直接跳过。
  - `navigateBackToAlbums()` 仅在已有 `albumAdapter` 时将其设置回 `RecyclerView`，当适配器尚未初始化或内部数据为空时，没有触发重新加载，造成空白。

#### 2) 蓝牙耳机“上一首”重播当前曲
- **现象**：
  - 蓝牙耳机触发“上一首”时，经常只是把当前歌曲从头播放，并未切换到上一首。
- **根因**：
  - `PlayerService.previous()` 为了兼顾应用内操作体验，包含“若进度>3秒则回到曲首”的逻辑。
  - 媒体会话回调 `onSkipToPrevious()` 直接调用了 `previous()`，因此蓝牙线控也套用了“>3秒回到曲首”的规则，未强制切到上一首。

---

### 方案总览与实现要点
#### A. 专辑首屏/返回空白修复
- **强制附着适配器与状态复位**：
  - 在 `MainActivity.loadAlbums()` 开始处：
    - 先将 `isLoading = false`，避免因残留状态导致的“早退”。
    - 若 `albumAdapter` 为 `null`，则创建并设置点击回调；随后确保 `recyclerView` 上的适配器为 `albumAdapter`。
  - 在 `loadAlbums()` 的两处 UI 回调分支（“本地缓存回填”和“网络返回覆盖”）中：
    - 若当前 `recyclerView.getAdapter() != albumAdapter`，则重新附着 `albumAdapter`，再 `setAlbums(...)`。
- **返回专辑的兜底加载**：
  - 在 `navigateBackToAlbums()` 中，增加兜底逻辑：当 `albumAdapter == null` 或 `albumAdapter.getItemCount() == 0` 时，执行 `resetUiForNewView()` 并直接 `loadAlbums()`，保证返回后一定有数据。否则维持快速切换适配器的路径（保留性能）。
- **不改变现有交互**：
  - 仍在 `loadAlbums()` 内维持“先显示骨架屏→回填本地缓存→网络返回覆盖”的流程，保持首屏感知速度与离线可用性。

#### B. 蓝牙线控“上一首”强制切歌
- **行为拆分**：
  - 新增 `previousInternal(boolean forceToPrevious)`：
    - 当 `forceToPrevious = true` 时，忽略“>3秒回到曲首”的规则，直接切换到上一首（或在“全部循环”模式下跳到最后一首）。
    - 当 `forceToPrevious = false` 时，保留原有应用内“>3秒回到曲首”的体验。
  - 调整媒体会话回调 `onSkipToPrevious()` 调用 `previousInternal(true)`，确保蓝牙线控严格“上一首”。
  - 原 `previous()` 改为调用 `previousInternal(false)`，不改变应用内按钮的既有体验。

---

### 受影响文件与关键点
- `app/src/main/java/com/watch/limusic/MainActivity.java`
  - `loadAlbums()`：
    - 加入 `isLoading = false` 的状态复位；
    - 确保 `albumAdapter` 初始化与 `recyclerView` 适配器附着；
    - 在“本地缓存回填”和“网络返回覆盖”两个 UI 分支，若适配器未附着则重新附着。
  - `navigateBackToAlbums()`：
    - 若适配器为空或无数据，走 `resetUiForNewView(); loadAlbums();` 的兜底路径；否则仅切换标题与导航并附着已存在的适配器。
- `app/src/main/java/com/watch/limusic/service/PlayerService.java`
  - 新增 `previousInternal(boolean forceToPrevious)`；
  - `onSkipToPrevious()` → `previousInternal(true)`；
  - `previous()` → `previousInternal(false)`（保持应用内体验）。

---

### 验证用例与验收标准
#### A. 专辑首屏/返回
- **冷启动（记忆 last_view = "albums"）**：
  - 期望：标题为“专辑”，骨架短暂展示后出现专辑列表；不可出现 “No adapter attached; skipping layout”。
- **冷启动（记忆 last_view = "album_songs"）→左上角返回**：
  - 期望：返回后专辑列表可见且可滚动，无需通过抽屉再进入。
- **抽屉→专辑**：
  - 期望：正常加载，无空白或骨架叠加。
- **边界**：离线/弱网下依旧通过本地缓存回填首屏；滚动加载更多维持原行为。

#### B. 蓝牙“上一首/下一首”
- **蓝牙“上一首”**：
  - 期望：无论当前进度是否>3秒，都切换至上一首（或在“全部循环”模式下跳到最后一首）。
- **蓝牙“下一首”**：
  - 期望：行为不变，正常下一首。
- **应用内“上一首”按钮**：
  - 期望：保持>3秒回到曲首的既有体验，满足常见本地操作习惯。

---

### 性能与兼容性评估
- **性能**：
  - `loadAlbums()` 中的适配器附着与状态复位为 O(1) 级别，无明显额外开销；
  - 不新增网络请求，仅优化 UI 时序，符合手表端性能约束。
- **兼容性**：
  - 蓝牙“上一首”的行为与主流播放器一致；
  - 保留应用内“上一首”>3秒回到曲首的体验，避免行为突变。

---

### 回滚策略
- 若出现异常（例如特殊机型仍出现空白或耳机事件未按预期触发）：
  - 可将 `navigateBackToAlbums()` 恢复为仅切换适配器的旧逻辑；
  - 将 `onSkipToPrevious()` 恢复为调用 `previous()`；
  - 或逐步仅保留 `loadAlbums()` 中的“强制附着适配器”改动以定位问题。

---

### 版本信息与变更摘要
- **分支/版本**：v2.3Beta3 后续小版本增量（2025-8-20）
- **变更摘要**：
  - 专辑首屏/返回空白：通过 `loadAlbums()` 的状态复位与适配器强附着、`navigateBackToAlbums()` 的兜底加载，消除空白与“无适配器”告警；
  - 蓝牙线控上一首：媒体会话回调改为强制上一首，不再重播当前曲。

---

### 附：日志证据（节选）
```text
2025-08-20 08:33:43.119 RecyclerView W  No adapter attached; skipping layout
2025-08-20 08:33:43.260 RecyclerView W  No adapter attached; skipping layout
```
