## 2025-09-27｜全局随机自动切歌修复（所有歌曲全局模式）
(TechChangeSpec_2025-09-27-GlobalShuffle-AutoNext-Fix)

### 方案总览与实现要点
- 在 `PlayerService` 的 `onMediaItemTransition(...)` 中，拦截“全局所有歌曲模式 + 随机模式 + 自动切歌(AUTO)”场景。
- 触发一次自定义随机跳转：调用 `pickRandomGlobalIndexAvoidingCurrent()` 选取目标索引，并通过 `jumpToGlobalIndex(target, 0L, true)` 跳转。
- 增加防抖标记 `handlingAutoRandom`，避免一次自动切歌导致连跳/重复触发；处理完成后清除标记。
- 保持原有窗口扩边、广播时序与非全局场景随机逻辑不变。

### 问题回溯与根因分析
- 问题：在“所有歌曲”（全局滑窗）里开启随机播放时，自动切歌表现为顺序前进，但 UI 显示仍是随机；手动下一曲则是随机。
- 根因：全局模式下我们关闭了 ExoPlayer 自带 `shuffle`（以保证滑动窗口与索引稳定），手动下一曲走了自定义随机 `pickRandomGlobalIndexAvoidingCurrent()`，但自动切歌由 ExoPlayer 按队列顺序推进，未走自定义随机逻辑。

### 受影响文件与关键点
- `app/src/main/java/com/watch/limusic/service/PlayerService.java`
  - 类字段：新增 `private volatile boolean handlingAutoRandom` 防抖标记。
  - 方法：`onMediaItemTransition(MediaItem mediaItem, int reason)`
    - 在 `reason == MEDIA_ITEM_TRANSITION_REASON_AUTO` 且 `useGlobalAllSongsMode && playbackMode == PLAYBACK_MODE_SHUFFLE` 时：
      - 若未在处理，设置 `handlingAutoRandom=true`，`handler.post(...)` 执行 `jumpToGlobalIndex` 实现自定义随机跳转；执行完毕重置标记。
      - `return` 提前返回，避免继续走顺序扩边路径造成“顺序推进”。

### 验收用例与验收标准（手表优先）
1) 所有歌曲（全局）+ 随机
- 自动切歌：曲目随机，不会按顺序推进；UI 模式与行为一致。
- 手动下一曲：保持随机，与自动一致。
- 上一曲：可依据 `shuffleHistory` 正确回退。

2) 非全局（专辑/歌单）+ 随机
- 行为与之前一致：启用 ExoPlayer shuffle，自动/手动均为随机。

3) 边界与稳定性
- 未引入连跳；日志无异常刷屏；窗口扩边与缓冲行为不变。
- AFTER_CURRENT、单曲循环/列表循环、睡眠定时等逻辑不受影响。

### 性能与功耗评估
- 改动仅在自动切歌事件点触发一次轻量计算与一次跳转调用；对表端 CPU/GPU/功耗影响可忽略不计。
- 不改变窗口大小与扩边策略，不增加网络或解码负担。

### 风险与回滚
- 风险：个别设备上 `onMediaItemTransition` 的 AUTO 时序差异可能造成一次短暂 UI 显示顺序→随机的切换感知。
- 回滚：
  - 移除 `handlingAutoRandom` 与拦截逻辑，恢复为“自动切歌顺序、手动随机”的旧行为。
  - 或改为开启全局模式下的 ExoPlayer shuffle（不推荐，打破窗口稳定）。

### 版本信息与变更摘要
- 版本：v4.0（2025-09-27，全局随机自动切歌修复）
- 摘要：全局“所有歌曲”随机播放的自动切歌改为自定义随机，与手动切歌一致；新增防抖标记避免连跳；不影响非全局场景。 