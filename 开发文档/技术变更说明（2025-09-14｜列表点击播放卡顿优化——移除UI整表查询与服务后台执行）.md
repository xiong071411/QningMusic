## 2025-09-14｜列表点击播放卡顿优化——移除UI整表查询与服务后台执行
(TechChangeSpec_2025-09-14-Click-Play-Jank-Fix)

### 背景与目标
- 背景：反馈“点击任意歌曲播放时 UI 明显卡一帧，‘所有歌曲’页面更重，其他页面也会卡”。
- 目标：
  - 消除点击播放瞬间的主线程阻塞与掉帧。
  - 保持既有交互与功能一致（含在线/离线、随机/循环、封面展示、自动打开全屏的偏好逻辑）。
  - 面向手表设备优先（Android 8.1），避免额外功耗与不稳定因素。

---

### 问题回溯与根因分析
1) UI 线程整表查询（“所有歌曲”页最重）
- 现象：`MainActivity.onSongClick(...)` 在检测为 `AllSongsRangeAdapter` 时，UI 线程同步把“所有歌曲”整表读出（`getSongsRange(total, 0)`），且 `Room` 开启了 `allowMainThreadQueries()`，直接阻塞主线程。曲库越大越明显（用户约 750 首，亦可感知）。
- 影响：点击瞬间长时间阻塞 UI，导致明显掉帧；“所有歌曲”更重是因为每次点击都整表加载。

2) 服务重操作经本地 Binder 落在 UI 线程
- 现象：`MainActivity` 直接调用 `playerService.setPlaylist(...)`，本地 Binder 会在调用线程（UI 线程）执行；`setPlaylist(...)` 内部执行：窗口构建、为 ~20 首歌构建 MediaItem、查找本地文件（多后缀 `File.exists()`）、`stop/clear/setMediaItems/prepare/play` 等重操作。
- 影响：所有页面点击播放都会卡一帧，即便非“所有歌曲”。

3) 次要叠加因素（未在本次改动中调整）
- 背景模糊（API 27）在打开全屏或切歌时可能在 UI 线程执行位图缩放与三通道 box blur，但用户未开启“点击后自动打开全屏”，因此不属于点击瞬间的主要路径，本次暂不改动。

---

### 方案总览与实现要点
A. 移除 UI 线程整表查询（“所有歌曲”在线场景）
- 点击“所有歌曲”时不再在 UI 线程整表读取；在线场景改为调用服务的“全局所有歌曲滑动窗口”入口，通过服务端按需拉取窗口并起播。

B. 服务侧重操作全部后台化
- 为 `PlayerService` 新增后台单线程执行器，将 `setPlaylist(...)`、`playAllSongsFromGlobal(...)` 的重操作封装到内部私有方法（`*Internal`）并在后台线程执行，避免通过本地 Binder 把重活执行在 UI 线程。

C. ExoPlayer 访问主线程化
- 对 `stop/clearMediaItems/setMediaItems/prepare/play` 的调用统一用主线程 `handler.post(...)` 包装，降低跨线程访问播放器的风险。

D. 离线场景安全回退
- 当设备离线时仍保留原“本地列表 + 可播放过滤”路径，确保离线依然可播；内部对过滤后的起始索引做一致性修正。

E. 绑定后挂起请求处理
- 未绑定时点击“所有歌曲”：记录全局索引；绑定成功后直接触发“全局滑窗播放”，避免再次在 UI 线程整表读取。

---

### 代码变更清单（核心摘录）
- `app/src/main/java/com/watch/limusic/MainActivity.java`
  - `onSongClick(Song, int)`：
    - 当适配器为 `AllSongsRangeAdapter`：
      - 在线：改为 `playerService.playAllSongsFromGlobal(position)`，不再 UI 线程整表查询。
      - 离线：保留本地列表路径，并交由服务侧异步处理与过滤。
    - 其他页面：保留 `setPlaylist(...)` 调用（服务端现已异步）。
  - `ServiceConnection.onServiceConnected(...)`：
    - 新增对“全局索引挂起请求”的处理：在 `pendingPlaylist==null && pendingPlaylistRebasedIndex>=0` 时，调用 `playerService.playAllSongsFromGlobal(...)` 并清理标记。

- `app/src/main/java/com/watch/limusic/service/PlayerService.java`
  - 新增后台 IO 执行器字段（单线程，线程优先级设为后台）。
  - `setPlaylist(List<Song>, int)`：改为异步外壳，调用 `setPlaylistInternal(...)`。
  - `setPlaylistInternal(...)`：保留原窗口化注入逻辑；离线模式下过滤仅可播放项并修正起始索引；ExoPlayer 调用通过主线程 `handler.post(...)` 执行。
  - `playAllSongsFromGlobal(int)`：改为异步外壳，调用 `playAllSongsFromGlobalInternal(...)`。
  - `playAllSongsFromGlobalInternal(...)`：构建首块窗口媒体项与起播索引；ExoPlayer 调用通过主线程 `handler.post(...)` 执行。

（数据库结构未变更；网络层未变更；`AllSongsRangeAdapter` 无需改动）

---

### 受影响文件与关键点
- `MainActivity.java`
  - 点击播放路径分流（所有歌曲/其他页面），以及服务绑定成功后的挂起请求恢复。
- `PlayerService.java`
  - 新增后台单线程与 `*Internal` 实现；ExoPlayer 操作主线程化；离线过滤与索引一致性修正。

---

### 验收用例与验收标准（手表优先）
1) 所有歌曲页面（在线）
- 操作：进入“所有歌曲”，点击任意歌曲。
- 预期：无明显“一卡一帧”；能迅速开始缓冲/播放；UI 可操作不被阻塞。

2) 所有歌曲页面（离线）
- 操作：断网或离线模式，点击任意歌曲。
- 预期：若歌曲（或其缓存）可用则正常播放；不可用则提示；无明显 UI 卡顿。

3) 专辑详情/歌单详情页面
- 操作：点击任意歌曲。
- 预期：无明显“一卡一帧”；播放正常；随机/循环等模式维持不变。

4) 服务未绑定 → 首次点击触发绑定
- 操作：冷启动后首次点击歌曲（所有歌曲页）。
- 预期：绑定成功即从全局索引起播，无 UI 线程整表查询；不出现长时间卡顿。

5) Android 8.1（API 27）
- 操作：重复以上用例。
- 预期：行为与流畅度符合上述预期；无异常崩溃与播放卡死。

---

### 性能与功耗评估
- 主线程阻塞去除：
  - 之前：UI 线程 `Room` 整表查询（750 首）+ 服务重操作导致明显卡顿。
  - 现在：
    - 在线：UI 线程不再整表查询；仅发起轻量 IPC 到服务；窗口构建与文件检测在后台执行。
    - 离线：本地列表读取仍存在，但服务端重操作异步化显著缩短 UI 阻塞时间。
- 预计效果（表端）：点击响应延迟与掉帧峰值显著下降；整体功耗无上升（重操作后台化、窗口小批量）。

---

### 风险与回滚
- 风险：
  - 异步化后与 UI 的状态同步时序问题（如快速连点、模式切换时竞态）。
  - ExoPlayer 主线程封装需确保在服务销毁/重建边界条件下不发生空引用。
- 回滚：
  - 将 `setPlaylist(...)`、`playAllSongsFromGlobal(...)` 恢复为同步实现；
  - 恢复 `MainActivity` 中“所有歌曲”分支的整表查询与 `setPlaylist(...)` 直调（不推荐）。

---

### 版本信息与变更摘要
- 版本：v4.0Beta（2025-09-14，点击播放卡顿优化）
- 变更摘要：
  - 移除“所有歌曲”点击时的 UI 线程整表查询（在线场景改为全局滑窗）。
  - 将服务内重操作异步化，播放器调用主线程化，显著降低点击瞬间卡顿。
  - 离线场景保持可播性与一致性，未变更既有交互与设置。

---

### 备注
- 背景模糊（API 27）为次要叠加因素，未在本次改动中变更；后续如需进一步降低全屏打开或切歌时的掉帧，可引入更激进的缓存与离屏处理策略（与本次改动解耦）。 