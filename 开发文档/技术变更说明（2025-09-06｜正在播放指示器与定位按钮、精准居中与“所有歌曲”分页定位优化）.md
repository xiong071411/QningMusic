## 2025-09-06｜正在播放指示器与定位按钮、精准居中与“所有歌曲”分页定位优化
(TechChangeSpec_2025-09-07-PlayingIndicator-LocateCentering)

### 背景与目标
- 背景：
  - 手表小屏空间有限，“正在播放”标识需更加克制且不抢占空间；原方案中的微型三角图标在部分设备上观感不一致。
  - “定位当前播放”在“所有歌曲（滑动窗口分页）”场景中，目标曲目未加载前按钮不可用，且长距离滚动会卡顿，居中偏差较大（常出现目标上方约10行）。
- 目标：
  - 将“正在播放”指示改为品牌风格、更清晰但不突兀；移除小图标与动效，保留标题加粗。
  - 定位按钮在目标未加载时也可用；点击后能快速、精准、严格居中到目标曲目，长列表不再卡顿。

---

### 问题回溯与根因分析
1) 定位偏差（目标常停在上方约10行）
- 根因：长距离使用 SmoothScroller 进行插值平滑滚动，停止位置受估算速度与中途绑定/测量影响，存在累计误差；且目标行真实高度与估值不同步。

2) 未加载目标时按钮不可用
- 根因：按钮显隐逻辑将 `pos<0`（未加载）理解为“不可定位”，导致隐藏按钮；且缺少“先粗定位到相邻段触发预取，再校正居中”的流程。

3) 长列表卡顿
- 根因：长距离平滑滚动产生大量中间帧位移，UI 线程与布局测量频繁，弱设备上卡顿明显。

4) 指示样式不统一
- 根因：微型三角图标与动效在小屏上占位且分散注意力，与品牌色不统一。

---

### 方案总览与实现要点
A. 正在播放指示样式统一与弱打扰
- 左侧竖条：改为品牌绿 `#58D36B`，宽度 3dp；仅当前曲目显示。
- 标题：仅加粗（非选择模式时），不改变字号与颜色。
- 三角图标：移除（不再显示、不做动效），降低视觉干扰。

B. “定位当前播放”按钮（显示逻辑与行为）
- 显示：
  - 目标未加载（`pos<0`）也显示；
  - 目标已加载但不在可视范围也显示；
  - 目标在可视范围内时隐藏。
- 点击行为：
  - “所有歌曲”未加载：先基于数据库计算全局索引 `approx` 并定位到该索引触发预取；随后多次快速检查（160ms/260ms/320ms），一旦目标出现立即居中定位。
  - 其他列表：直接严格居中定位。

C. 严格居中与无卡顿定位
- 替换 SmoothScroller：使用两阶段 `scrollToPositionWithOffset` 居中算法：
  - 第一步：用可见项或默认高度估算，粗略居中；
  - 第二步（下一帧）：读取目标项真实高度，按 RecyclerView 可用高度（去除上下 padding）计算精确 offset，再次 `scrollToPositionWithOffset`，严格居中；
  - 避免长距离平滑滚动带来的累积误差与中间帧卡顿。

D. 精准全局索引（减少粗估偏差）
- 新增 DAO 方法 `getGlobalIndex(cat, ini, title)`，按与 UI 一致的排序规则（`#` → 数字 → A-Z，且 `title COLLATE NOCASE`）精确计算目标歌曲在全局排序中的前置行数，用作未加载初始定位的 `approx`。

---

### 代码变更清单（核心摘录）
- `app/src/main/res/values/colors.xml`
  - `playing_indicator` 改为品牌绿 `#58D36B`。

- `app/src/main/res/layout/item_song.xml`
  - 新增/调整：`@id/playing_indicator_bar` 宽 3dp，颜色 `@color/playing_indicator`；
  - 移除三角图标显示：`@id/playing_icon` 置为 0dp/GONE；
  - 标题 `@id/song_title` 保持加粗逻辑由适配器控制。

- `app/src/main/java/com/watch/limusic/adapter/SongAdapter.java`
  - 新增：`setCurrentPlaying(songId, isPlaying)`、`getPositionBySongId(songId)`；
  - 渲染：仅显示左侧竖条与标题加粗；移除小图标与动效；
  - 稳定性：保留稳定 ID，最小刷新（仅上一首与当前首）。

- `app/src/main/java/com/watch/limusic/adapter/AllSongsRangeAdapter.java`
  - 新增：`setCurrentPlaying(...)`、`getPositionBySongId(...)`；
  - 渲染：与 `SongAdapter` 一致；
  - 保持分页加载逻辑与下载状态渲染。

- `app/src/main/res/layout/activity_main.xml`
  - 新增悬浮按钮 `@id/btn_locate_current`（36dp 圆形，右下角），图标 `@drawable/ic_locate`，默认 GONE。

- `app/src/main/java/com/watch/limusic/MainActivity.java`
  - 新增：
    - `btnLocateCurrent` 引用，显隐与点击逻辑；
    - 分发当前曲目 `songId/isPlaying` 给列表适配器；
    - 按钮显隐：未加载（`pos<0`）也显示；在屏内隐藏；
    - 定位流程（所有歌曲未加载时）：
      1) 计算 `approx`（优先 `SongDao.getGlobalIndex(...)`，回退当前可见锚点）；
      2) `prefetchAround(approx)` 触发加载；
      3) 先滚到 `approx`；
      4) 160/260/320ms 连续检查 `getPositionBySongId(sid)`，一旦命中即严格居中；
    - 严格居中算法：两阶段 `scrollToPositionWithOffset`（粗估 + 下一帧精确），不再用 SmoothScroller；
    - lambda 捕获修复：`sid` 与 `itemH` 改为 `final` 局部副本（`finalSid`、`finalItemH`）。
  - 清理：移除重复的 `updateLocateButtonVisibility/locateCurrentPlaying/smoothCenterTo` 的冗余定义。

- `app/src/main/java/com/watch/limusic/database/SongDao.java`
  - 新增：`getGlobalIndex(int cat, String ini, String title)`，用于精确计算全局索引。

- `app/src/main/res/drawable/ic_locate.xml`
  - 新增定位图标（轻量矢量）。

---

### 受影响文件与关键点
- `MainActivity.java`：按钮显隐与居中定位核心逻辑；广播分发当前曲目；lambda final 修复；
- `AllSongsRangeAdapter.java` / `SongAdapter.java`：当前播放渲染、定位辅助方法；
- `item_song.xml` / `colors.xml`：指示条样式调整与统一；
- `SongDao.java`：新增精确全局索引查询；
- `activity_main.xml` / `ic_locate.xml`：新增定位按钮与图标。

---

### 验收用例与验收标准（手表优先）
1) 正在播放指示
- 当前曲目：左侧 3dp 品牌绿竖条 + 标题加粗；无三角图标与动效；
- 非当前曲目：不显示竖条，标题正常；
- 选择模式：以选择态为准，不额外提亮。

2) 定位按钮显隐
- 所有歌曲：目标未加载（`pos<0`）也显示；目标已加载且不在屏内也显示；在屏内隐藏；
- 专辑内/歌单详情：同“已加载不在屏内则显示”的规则。

3) 点击定位（所有歌曲）
- 未加载：先滚到 `approx` 附近触发加载；随后 160/260/320ms 内一旦目标出现即严格居中；
- 已加载：一次性严格居中；不出现“少10行”的偏移。

4) 性能
- 长列表远距离定位无明显卡顿；
- 定位过程不引入持续动画或频繁无效刷新；
- 仅最小化刷新上一首/当前首两个条目。

---

### 性能与功耗评估
- SmoothScroller 改为两阶段同步居中：减少中间帧位移，显著降低 UI/Jank；
- 预取与检查均为事件驱动的短时操作；
- 未引入常驻计时器；功耗可忽略。

---

### 风险与回滚
- 极端数据顺序异常：`getGlobalIndex(...)` 回退当前可见锚点；
- 个别设备 `findViewByPosition` 返回滞后：二阶段校正保证最终居中；
- 如定位仍存在偏差，可临时退回 SmoothScroller，但建议保留两阶段校正规则；
- 定位按钮如对 UI 造成遮挡，可通过 margin 微调或条件隐藏（保留开关实现空间）。

---

### 版本信息与变更摘要
- 版本：v3.2（2025-09-06，正在播放指示与定位优化）
- 变更摘要：
  - UI：正在播放指示改为 3dp 品牌绿竖条 + 标题加粗；去除三角图标与动效；
  - 功能：定位按钮在目标未加载时可用；点击后精准居中；
  - 性能：长距离定位采用两阶段同步居中，显著降低卡顿；
  - 稳定：新增全局索引查询，定位更精准；修复 lambda final 捕获导致的编译问题；清理重复方法定义。

---

### 附录：接口与关键方法（摘要）
- Activity：
  - `updateLocateButtonVisibility(String currentSongId)`：控制按钮显隐（未加载也显示）。
  - `locateCurrentPlaying()`：计算 `approx` → 预取 → 连续检查 → 严格居中。
  - `smoothCenterTo(int position)`：两阶段 `scrollToPositionWithOffset` 精准居中。
- 适配器：
  - `SongAdapter/AllSongsRangeAdapter.setCurrentPlaying(songId, isPlaying)`：更新渲染；
  - `getPositionBySongId(songId)`：返回当前位置（未加载返回 -1）。
- DAO：
  - `SongDao.getGlobalIndex(cat, ini, title)`：按 UI 排序规则计算全局索引。 

---

### 问题回溯与根因分析（补充）
5) 歌单详情：骨架屏与列表叠加、滑动时多行短暂重叠（约第15项附近）
- 根因A：进入详情时先 `setAdapter` 再展示骨架，导致首帧骨架与列表同时可见；
- 根因B：RecyclerView 默认 `ItemAnimator` 在首批绑定与快速复用时触发过渡动画，弱设备上产生“重叠闪影”。

6) 歌词平滑模式：长句切换时左缘不齐、非当前行偶发“外凸”
- 根因A：改为整体缩放后未固定 `pivotX`（默认中心枢轴），缩放造成左边缘相对位移；
- 根因B：View 复用时保留了上次的缩放状态，导致新的非当前行起始就存在缩放残留。

7) 构建稳定性：lambda 捕获局部变量
- 根因：在 `postDelayed` 或 lambda 中直接引用了非常量的局部变量（如 `sid`、`itemH`），违反 Java “有效 final”约束，导致编译失败。

---

### 方案总览与实现要点（补充）
E. 歌单详情首屏交叠与重叠修复
- 进入详情前：先隐藏 `RecyclerView`（`INVISIBLE`）并关闭 `ItemAnimator`；
- 设置适配器并展示骨架；
- 数据到达后：提交数据 → 收起骨架 → 再显示 `RecyclerView(VISIBLE)`；二次刷新同样确保骨架隐藏与列表可见。

F. 歌词平滑动画：字号静态 + 左枢轴轻缩放
- 成为当前：字号与内边距一次性到位；以左侧为枢轴执行轻量缩放（0.96→1.0，160ms）增强过渡质感；
- 离开当前：字号与内边距恢复；以左侧为枢轴执行 1.0→0.96（120ms）；
- 绑定时统一重置 `pivotX=0f` 与 `scaleX/scaleY=1f`，杜绝复用残留；
- 水平跑马灯延后一帧再启动，避免与缩放叠加。

G. 构建稳定性：lambda 捕获 final 化
- 统一将 lambda 中用到的局部变量拷贝为 `final`（如 `finalSid`、`finalItemH`），满足 Java 规则。

---

### 代码变更清单（补充）
- `MainActivity.java`
  - `openPlaylistDetail(...)`：
    - 进入前 `recyclerView.setVisibility(INVISIBLE)`、`recyclerView.setItemAnimator(null)`；
    - 首次与二次数据到达时：关闭骨架并 `setVisibility(VISIBLE)`；
  - lambda 捕获：`finalSid`（定位流程）、`finalItemH`（严格居中）

- `LyricsAdapter.java`
  - 平滑模式分支：移除 textSize 连续动画，改为左枢轴轻缩放；
  - 绑定时重置 `pivotX=0f`、`scale=1f`，避免复用残留；
  - 跑马灯：延后一帧启动。

---

### 验收用例与验收标准（补充）
- 歌单详情：
  - 进入详情首帧仅见骨架，不见列表；数据就绪后骨架立即隐藏，列表显示；
  - 列表前 20 项滑动时不再出现多项短暂重叠；
- 歌词：
  - 平滑模式下长句切换时，当前/非当前行左缘对齐，无“外凸/错位”；
  - 长句无“从左到右逐字放大”的错觉，过渡自然；
- 构建：
  - 不再出现 lambda 非 final 捕获的编译错误。

---

### 风险与回滚（补充）
- 个别 ROM 对 `ItemAnimator=null` 行为有差异：如需恢复，保留按需启用 Animator 的回退分支；
- 若个别字体在缩放时仍产生轻微度量差，可进一步减小缩放幅度（0.98↔1.0）或缩短时长；
- 若定位流程在极端长列表上仍有轻微偏差，可增加一次额外检查或扩大预取范围，但建议保留“两阶段同步居中”策略以控制卡顿。 