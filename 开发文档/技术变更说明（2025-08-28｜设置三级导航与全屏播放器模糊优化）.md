## 2025-08-28｜设置三级导航与全屏播放器模糊优化（三级菜单 + ViewStub 懒加载 + 模糊线性映射 + 即时生效广播 + 崩溃修复)
(TechChangeSpec_2025-08-28-Settings-3Level-and-FullPlayer-Blur)

### 背景与目标
- 背景：
  - 设置页在手表上为长列表，操作成本高、易误触；
  - 全屏播放器新增后，需保证低功耗、高稳定，且背景模糊观感“毛玻璃”、强度调整线性且立即生效；
  - 发现若干问题：布局文件空导致编译失败、顶层设置页仍引用已移除视图导致闪退、模糊强度非线性/像素化、设置改动需切歌或重启才生效。
- 目标：
  - 将设置页改为“三级导航”（顶层仅入口、二级承载子项、可按需扩展第三级）；
  - 全屏播放器覆盖全屏、交互顺畅；
  - 背景模糊强度 0–100% 线性且更均匀（将“原有效 0–40%”线性压缩到 0–100%）；
  - 设置改动（低耗模式/模糊开关/模糊强度）无需切歌/重启即可即时生效；
  - 修复编译/运行期崩溃，提升稳定性。
- 新增：返回专辑列表时保持滚动位置，提升专辑浏览连续性与可用性（手表优先）。

---

### 问题回溯与根因分析
1) 设置页过长、操作不便：
- 顶层堆叠大量功能卡片，滚动与点击负担大。

2) 全屏播放器覆盖不完整与交互细节：
- 需保证顶层遮盖（elevation/clickable/focusable/bringToFront），以及返回收起、进度拖动显示、控件尺寸适配。

3) 模糊观感与强度不线性：
- 旧实现在 40% 左右已“过糊”，40–100% 几乎无区分；低版本近似算法呈“像素化/马赛克感”。

4) 设置改动未即时生效：
- 需切歌或重启才能刷新背景；广播与 UI 刷新链路不足。

5) 崩溃与编译失败：
- `activity_settings_player.xml` 为空导致“文件提前结束”；
- `SettingsActivity` 仍引用已从布局移除的卡片 ID，`findViewById(...).setOnClickListener(...)` 触发 NPE。

6) 列表返回置顶问题：
- 从专辑详情返回专辑列表时，滚动位置回到顶部，影响连续浏览效率与用户预期。

---

### 方案总览与实现要点
A. 设置页三级导航（手表友好）
- 顶层（`SettingsActivity`）：仅三张卡片入口
  - 服务器设置（`card_navidrome`）
  - 通用（`card_general_settings` → `GeneralSettingsActivity`）
  - 播放器设置（`card_player_settings` → `PlayerSettingsActivity`）
- 二级：
  - 通用（`GeneralSettingsActivity` + `activity_general_settings.xml`）
    - 一键清理缓存、缓存详情设置、解码兼容模式、下载强制转码、省电模式、播放进度刷新频率
    - 补齐每张卡片标题（14sp、加粗、主色），副标题 12sp 次要色
  - 播放器设置（`PlayerSettingsActivity` + `activity_settings_player.xml`）
    - 背景模糊开关、背景模糊强度（SeekBar），补齐标题文案
- 清单：注册 `GeneralSettingsActivity`、`PlayerSettingsActivity`，父页为 `SettingsActivity`。
- 顶层移除对旧卡片的绑定，避免 NPE。

B. 全屏播放器（全屏覆盖 + 懒加载）
- `activity_main.xml`：在根布局末尾新增 `ViewStub`（`@id/full_player_stub`）懒加载全屏播放器覆盖层；
- `layout_full_player_overlay.xml`：
  - 根 `FrameLayout` 设置 `clickable/focusable/elevation`，完全覆盖下层；
  - 顶部窄绿色条“返回列表”；
  - 顶部信息区（标题走马灯、艺术家/拖动时显示时间）；
  - 中部大号播放/暂停，左右上一首/下一首（向量图标圆润版）；
  - 底部进度条（拖动联动）、最底三控件（播放顺序/音量/更多）。
- `MainActivity`：
  - 打开时 `bringToFront()` 并在动画前调用 `applyFullPlayerBackground()`；
  - `onStart/onResume` 若可见则立即刷新背景；
  - 监听播放广播，曲目变更时立刻更新背景；
  - 统一进度同步与拖动保护（就绪前不提交 seek）。

C. 背景模糊（线性强度 + 质量与性能）
- `BlurUtils`：
  - API 31+ 使用 `RenderEffect`；API 27–30 使用自研三通道盒式模糊（近似高斯，观感“毛玻璃”而非“像素化”）；
  - 强度映射线性压缩：将过去“有效 0–40%”平铺到 0–100%；
    - 半径：`radius = t * (MAX_RADIUS * 0.4f)`（`MAX_RADIUS≈50`）
    - 采样：`scale = 0.98 - 0.65 * (t * 0.4)`
  - LruCache 提升至 6，按 `albumId+强度` 缓存；
  - 修正应用顺序（先 `setImageBitmap` 再 `RenderEffect`）。
- `applyFullPlayerBackground()`：
  - 读取偏好：`low_power_mode_enabled/bg_blur_enabled/bg_blur_intensity`；
  - 省电模式直设纯黑背景；
  - 开关关闭时显示原图；开启时按强度映射与缓存加载模糊图；
  - 数据源：当前曲目封面，若服务未绑定则回退 `last_song_id` → DB 封面。

D. 设置即时生效链路
- `SettingsActivity/GeneralSettingsActivity/PlayerSettingsActivity`：
  - 修改相关偏好后发送 `ACTION_UI_SETTINGS_CHANGED`；
  - 同时发送一次空的 `PLAYBACK_STATE_CHANGED` 刷新 UI（确保主界面进入统一刷新通道）；
  - `MainActivity` 在 `onStart/onResume/openFullPlayer/广播回调` 内均触发背景重绘，保证“立即可见”。

E. 崩溃与编译修复
- 补全空文件 `app/src/main/res/layout/activity_settings_player.xml`；
- 精简 `SettingsActivity` 仅绑定三张现有卡片，移除对已删视图ID的引用，消除 NPE；
- 为二级页面卡片补充标题，统一视觉层级。

---

### 受影响文件与关键点
- 布局：
  - `app/src/main/res/layout/activity_settings_list.xml`（顶层仅三入口）
  - `app/src/main/res/layout/activity_general_settings.xml`（通用二级页，补齐标题）
  - `app/src/main/res/layout/activity_settings_player.xml`（播放器二级页，补齐标题）
  - `app/src/main/res/layout/layout_full_player_overlay.xml`（全屏播放器覆盖层）
  - `app/src/main/res/layout/activity_main.xml`（新增 `ViewStub`）
- 代码：
  - `app/src/main/java/com/watch/limusic/SettingsActivity.java`（精简与入口绑定）
  - `app/src/main/java/com/watch/limusic/GeneralSettingsActivity.java`（通用页）
  - `app/src/main/java/com/watch/limusic/PlayerSettingsActivity.java`（播放器页）
  - `app/src/main/java/com/watch/limusic/MainActivity.java`（覆盖层生命周期、背景刷新、进度与拖动同步）
  - `app/src/main/java/com/watch/limusic/util/BlurUtils.java`（线性强度映射、RenderEffect/盒式模糊、缓存）
  - `app/src/main/java/com/watch/limusic/service/PlayerService.java`（广播信息与 seek 状态更新）
  - `app/src/main/AndroidManifest.xml`（注册新 Activity）
  - `app/src/main/res/values/strings.xml`（必要文案）
  - F. 专辑列表滚动位置保持
- `MainActivity` 新增方法：`recordAlbumsScrollPosition()`、`restoreAlbumsScrollPosition()`；
- 进入专辑详情前记录 `RecyclerView` 第一可见项位置与顶部偏移；返回专辑列表时通过 `LinearLayoutManager.scrollToPositionWithOffset` 精确恢复；
- 仅在当前视图为 `albums` 时记录；加入异常容错，保证低风险与稳定性。

---

### 验证用例与验收标准（手表设备优先）
1) 顶层设置 → 二级页：
- 三个入口可点击进入对应二级；二级内各卡片标题清晰，点击/滑动交互正常，无崩溃。

2) 全屏播放器显示与覆盖：
- 点击迷你播放器非控件区唤出；完整覆盖下层；点击“返回列表”收起。

3) 背景模糊强度与观感：
- 0–100% 可见线性变化，无“40% 后无差别”；低版本观感为“毛玻璃”，非“像素化”。

4) 设置即时生效：
- 切换“省电模式/模糊开关/模糊强度”后，无需切歌或重启即可刷新全屏播放器背景；从列表切歌时背景也立即更新。

5) 进度/拖动：
- 进度条在就绪后推进；就绪前拖动不提交 seek（如实现），时间显示有兜底不回跳开头。

6) 稳定性：
- 无“文件提前结束”与空指针闪退；正常切后台/返回无异常。

7) 列表返回位置保持：
- 从专辑列表滚动到中部，进入某专辑后返回，应停留在原来的滚动位置而非列表顶部。

---

### 性能与兼容性评估
- 懒加载：全屏播放器使用 `ViewStub`，未打开不占资源；
- 模糊性能：低分辨率采样 + 三通道盒式模糊 + LruCache，API31+走 RenderEffect；
- 广播频率：设置改动与播放状态变更触发一次增量刷新，功耗可忽略；
- 兼容：API 27+；老设备优先保证流畅与省电。
- 列表位置保持：记录/恢复仅发生在导航切换瞬间；调用 `scrollToPositionWithOffset` 为 UI 线程轻量操作，对 CPU/I/O 几乎无额外开销；对非 `LinearLayoutManager` 退化为 `scrollToPosition`。

---

### 风险与回滚
- 风险：
  - 个别设备 RenderEffect 行为差异；
  - 某些封面缺失导致回退路径命中率下降（已做 last_song_id/DB 回退）。
- 回滚策略：
  - 模糊：切回旧强度曲线或禁用模糊（开关保留）；
  - 覆盖层：移除 `ViewStub` 与覆盖层文件，恢复旧 UI；
  - 设置导航：顶层暂时恢复旧长列表（不推荐）。
- 列表位置保持：
  - 风险：不同布局管理器行为差异可能导致偏移不精确；
  - 回滚：移除进入/返回时的记录与恢复调用，列表退化为默认返回顶部行为。

---

### 版本信息与变更摘要
- 版本：v2.5（2025-08-28，设置三级导航、即时生效与全屏播放器模糊优化）
- 变更摘要：
  - 设置：顶层仅入口，二级拆分“通用/播放器设置”，统一标题与样式；
  - 全屏播放器：覆盖层完善，交互闭环与返回行为规范；
  - 模糊：线性强度映射 + 质量提升 + 缓存；
  - 即时生效：设置广播链路完善；
  - 稳定性：修复空布局导致编译失败与顶层设置页 NPE。 
- 列表：返回专辑列表保持滚动位置，提升浏览连续性。 